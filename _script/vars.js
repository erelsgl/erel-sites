/*
This file was automatically generated by:
	/_script/combine_js.php?files=_script/jquery-1.3.2.min+_script/jquery.hoverIntent.min+_script/wymeditor/wymeditor/jquery.wymeditor+_script/vars0+_script/cookies+_script/elements+_script/form_validation+_script/fields+_script/arguments+_script/sites+_script/dates/dates+_script/templates+_script/magrim+_script/search+_script/rtelang_en+_script/rte+_script/etc&out=_script/vars&minify=0
Don't edit it directly!
*/
var target_direction = '';


/* _script/jquery-1.3.2.min */

/*
 * jQuery JavaScript Library v1.3.2
 * http://jquery.com/
 *
 * Copyright (c) 2009 John Resig
 * Dual licensed under the MIT and GPL licenses.
 * http://docs.jquery.com/License
 *
 * Date: 2009-02-19 17:34:21 -0500 (Thu, 19 Feb 2009)
 * Revision: 6246
 */
(function(){var l=this,g,y=l.jQuery,p=l.$,o=l.jQuery=l.$=function(E,F){return new o.fn.init(E,F)},D=/^[^<]*(<(.|\s)+>)[^>]*$|^#([\w-]+)$/,f=/^.[^:#\[\.,]*$/;o.fn=o.prototype={init:function(E,H){E=E||document;if(E.nodeType){this[0]=E;this.length=1;this.context=E;return this}if(typeof E==="string"){var G=D.exec(E);if(G&&(G[1]||!H)){if(G[1]){E=o.clean([G[1]],H)}else{var I=document.getElementById(G[3]);if(I&&I.id!=G[3]){return o().find(E)}var F=o(I||[]);F.context=document;F.selector=E;return F}}else{return o(H).find(E)}}else{if(o.isFunction(E)){return o(document).ready(E)}}if(E.selector&&E.context){this.selector=E.selector;this.context=E.context}return this.setArray(o.isArray(E)?E:o.makeArray(E))},selector:"",jquery:"1.3.2",size:function(){return this.length},get:function(E){return E===g?Array.prototype.slice.call(this):this[E]},pushStack:function(F,H,E){var G=o(F);G.prevObject=this;G.context=this.context;if(H==="find"){G.selector=this.selector+(this.selector?" ":"")+E}else{if(H){G.selector=this.selector+"."+H+"("+E+")"}}return G},setArray:function(E){this.length=0;Array.prototype.push.apply(this,E);return this},each:function(F,E){return o.each(this,F,E)},index:function(E){return o.inArray(E&&E.jquery?E[0]:E,this)},attr:function(F,H,G){var E=F;if(typeof F==="string"){if(H===g){return this[0]&&o[G||"attr"](this[0],F)}else{E={};E[F]=H}}return this.each(function(I){for(F in E){o.attr(G?this.style:this,F,o.prop(this,E[F],G,I,F))}})},css:function(E,F){if((E=="width"||E=="height")&&parseFloat(F)<0){F=g}return this.attr(E,F,"curCSS")},text:function(F){if(typeof F!=="object"&&F!=null){return this.empty().append((this[0]&&this[0].ownerDocument||document).createTextNode(F))}var E="";o.each(F||this,function(){o.each(this.childNodes,function(){if(this.nodeType!=8){E+=this.nodeType!=1?this.nodeValue:o.fn.text([this])}})});return E},wrapAll:function(E){if(this[0]){var F=o(E,this[0].ownerDocument).clone();if(this[0].parentNode){F.insertBefore(this[0])}F.map(function(){var G=this;while(G.firstChild){G=G.firstChild}return G}).append(this)}return this},wrapInner:function(E){return this.each(function(){o(this).contents().wrapAll(E)})},wrap:function(E){return this.each(function(){o(this).wrapAll(E)})},append:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.appendChild(E)}})},prepend:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.insertBefore(E,this.firstChild)}})},before:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this)})},after:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this.nextSibling)})},end:function(){return this.prevObject||o([])},push:[].push,sort:[].sort,splice:[].splice,find:function(E){if(this.length===1){var F=this.pushStack([],"find",E);F.length=0;o.find(E,this[0],F);return F}else{return this.pushStack(o.unique(o.map(this,function(G){return o.find(E,G)})),"find",E)}},clone:function(G){var E=this.map(function(){if(!o.support.noCloneEvent&&!o.isXMLDoc(this)){var I=this.outerHTML;if(!I){var J=this.ownerDocument.createElement("div");J.appendChild(this.cloneNode(true));I=J.innerHTML}return o.clean([I.replace(/ jQuery\d+="(?:\d+|null)"/g,"").replace(/^\s*/,"")])[0]}else{return this.cloneNode(true)}});if(G===true){var H=this.find("*").andSelf(),F=0;E.find("*").andSelf().each(function(){if(this.nodeName!==H[F].nodeName){return}var I=o.data(H[F],"events");for(var K in I){for(var J in I[K]){o.event.add(this,K,I[K][J],I[K][J].data)}}F++})}return E},filter:function(E){return this.pushStack(o.isFunction(E)&&o.grep(this,function(G,F){return E.call(G,F)})||o.multiFilter(E,o.grep(this,function(F){return F.nodeType===1})),"filter",E)},closest:function(E){var G=o.expr.match.POS.test(E)?o(E):null,F=0;return this.map(function(){var H=this;while(H&&H.ownerDocument){if(G?G.index(H)>-1:o(H).is(E)){o.data(H,"closest",F);return H}H=H.parentNode;F++}})},not:function(E){if(typeof E==="string"){if(f.test(E)){return this.pushStack(o.multiFilter(E,this,true),"not",E)}else{E=o.multiFilter(E,this)}}var F=E.length&&E[E.length-1]!==g&&!E.nodeType;return this.filter(function(){return F?o.inArray(this,E)<0:this!=E})},add:function(E){return this.pushStack(o.unique(o.merge(this.get(),typeof E==="string"?o(E):o.makeArray(E))))},is:function(E){return !!E&&o.multiFilter(E,this).length>0},hasClass:function(E){return !!E&&this.is("."+E)},val:function(K){if(K===g){var E=this[0];if(E){if(o.nodeName(E,"option")){return(E.attributes.value||{}).specified?E.value:E.text}if(o.nodeName(E,"select")){var I=E.selectedIndex,L=[],M=E.options,H=E.type=="select-one";if(I<0){return null}for(var F=H?I:0,J=H?I+1:M.length;F<J;F++){var G=M[F];if(G.selected){K=o(G).val();if(H){return K}L.push(K)}}return L}return(E.value||"").replace(/\r/g,"")}return g}if(typeof K==="number"){K+=""}return this.each(function(){if(this.nodeType!=1){return}if(o.isArray(K)&&/radio|checkbox/.test(this.type)){this.checked=(o.inArray(this.value,K)>=0||o.inArray(this.name,K)>=0)}else{if(o.nodeName(this,"select")){var N=o.makeArray(K);o("option",this).each(function(){this.selected=(o.inArray(this.value,N)>=0||o.inArray(this.text,N)>=0)});if(!N.length){this.selectedIndex=-1}}else{this.value=K}}})},html:function(E){return E===g?(this[0]?this[0].innerHTML.replace(/ jQuery\d+="(?:\d+|null)"/g,""):null):this.empty().append(E)},replaceWith:function(E){return this.after(E).remove()},eq:function(E){return this.slice(E,+E+1)},slice:function(){return this.pushStack(Array.prototype.slice.apply(this,arguments),"slice",Array.prototype.slice.call(arguments).join(","))},map:function(E){return this.pushStack(o.map(this,function(G,F){return E.call(G,F,G)}))},andSelf:function(){return this.add(this.prevObject)},domManip:function(J,M,L){if(this[0]){var I=(this[0].ownerDocument||this[0]).createDocumentFragment(),F=o.clean(J,(this[0].ownerDocument||this[0]),I),H=I.firstChild;if(H){for(var G=0,E=this.length;G<E;G++){L.call(K(this[G],H),this.length>1||G>0?I.cloneNode(true):I)}}if(F){o.each(F,z)}}return this;function K(N,O){return M&&o.nodeName(N,"table")&&o.nodeName(O,"tr")?(N.getElementsByTagName("tbody")[0]||N.appendChild(N.ownerDocument.createElement("tbody"))):N}}};o.fn.init.prototype=o.fn;function z(E,F){if(F.src){o.ajax({url:F.src,async:false,dataType:"script"})}else{o.globalEval(F.text||F.textContent||F.innerHTML||"")}if(F.parentNode){F.parentNode.removeChild(F)}}function e(){return +new Date}o.extend=o.fn.extend=function(){var J=arguments[0]||{},H=1,I=arguments.length,E=false,G;if(typeof J==="boolean"){E=J;J=arguments[1]||{};H=2}if(typeof J!=="object"&&!o.isFunction(J)){J={}}if(I==H){J=this;--H}for(;H<I;H++){if((G=arguments[H])!=null){for(var F in G){var K=J[F],L=G[F];if(J===L){continue}if(E&&L&&typeof L==="object"&&!L.nodeType){J[F]=o.extend(E,K||(L.length!=null?[]:{}),L)}else{if(L!==g){J[F]=L}}}}}return J};var b=/z-?index|font-?weight|opacity|zoom|line-?height/i,q=document.defaultView||{},s=Object.prototype.toString;o.extend({noConflict:function(E){l.$=p;if(E){l.jQuery=y}return o},isFunction:function(E){return s.call(E)==="[object Function]"},isArray:function(E){return s.call(E)==="[object Array]"},isXMLDoc:function(E){return E.nodeType===9&&E.documentElement.nodeName!=="HTML"||!!E.ownerDocument&&o.isXMLDoc(E.ownerDocument)},globalEval:function(G){if(G&&/\S/.test(G)){var F=document.getElementsByTagName("head")[0]||document.documentElement,E=document.createElement("script");E.type="text/javascript";if(o.support.scriptEval){E.appendChild(document.createTextNode(G))}else{E.text=G}F.insertBefore(E,F.firstChild);F.removeChild(E)}},nodeName:function(F,E){return F.nodeName&&F.nodeName.toUpperCase()==E.toUpperCase()},each:function(G,K,F){var E,H=0,I=G.length;if(F){if(I===g){for(E in G){if(K.apply(G[E],F)===false){break}}}else{for(;H<I;){if(K.apply(G[H++],F)===false){break}}}}else{if(I===g){for(E in G){if(K.call(G[E],E,G[E])===false){break}}}else{for(var J=G[0];H<I&&K.call(J,H,J)!==false;J=G[++H]){}}}return G},prop:function(H,I,G,F,E){if(o.isFunction(I)){I=I.call(H,F)}return typeof I==="number"&&G=="curCSS"&&!b.test(E)?I+"px":I},className:{add:function(E,F){o.each((F||"").split(/\s+/),function(G,H){if(E.nodeType==1&&!o.className.has(E.className,H)){E.className+=(E.className?" ":"")+H}})},remove:function(E,F){if(E.nodeType==1){E.className=F!==g?o.grep(E.className.split(/\s+/),function(G){return !o.className.has(F,G)}).join(" "):""}},has:function(F,E){return F&&o.inArray(E,(F.className||F).toString().split(/\s+/))>-1}},swap:function(H,G,I){var E={};for(var F in G){E[F]=H.style[F];H.style[F]=G[F]}I.call(H);for(var F in G){H.style[F]=E[F]}},css:function(H,F,J,E){if(F=="width"||F=="height"){var L,G={position:"absolute",visibility:"hidden",display:"block"},K=F=="width"?["Left","Right"]:["Top","Bottom"];function I(){L=F=="width"?H.offsetWidth:H.offsetHeight;if(E==="border"){return}o.each(K,function(){if(!E){L-=parseFloat(o.curCSS(H,"padding"+this,true))||0}if(E==="margin"){L+=parseFloat(o.curCSS(H,"margin"+this,true))||0}else{L-=parseFloat(o.curCSS(H,"border"+this+"Width",true))||0}})}if(H.offsetWidth!==0){I()}else{o.swap(H,G,I)}return Math.max(0,Math.round(L))}return o.curCSS(H,F,J)},curCSS:function(I,F,G){var L,E=I.style;if(F=="opacity"&&!o.support.opacity){L=o.attr(E,"opacity");return L==""?"1":L}if(F.match(/float/i)){F=w}if(!G&&E&&E[F]){L=E[F]}else{if(q.getComputedStyle){if(F.match(/float/i)){F="float"}F=F.replace(/([A-Z])/g,"-$1").toLowerCase();var M=q.getComputedStyle(I,null);if(M){L=M.getPropertyValue(F)}if(F=="opacity"&&L==""){L="1"}}else{if(I.currentStyle){var J=F.replace(/\-(\w)/g,function(N,O){return O.toUpperCase()});L=I.currentStyle[F]||I.currentStyle[J];if(!/^\d+(px)?$/i.test(L)&&/^\d/.test(L)){var H=E.left,K=I.runtimeStyle.left;I.runtimeStyle.left=I.currentStyle.left;E.left=L||0;L=E.pixelLeft+"px";E.left=H;I.runtimeStyle.left=K}}}}return L},clean:function(F,K,I){K=K||document;if(typeof K.createElement==="undefined"){K=K.ownerDocument||K[0]&&K[0].ownerDocument||document}if(!I&&F.length===1&&typeof F[0]==="string"){var H=/^<(\w+)\s*\/?>$/.exec(F[0]);if(H){return[K.createElement(H[1])]}}var G=[],E=[],L=K.createElement("div");o.each(F,function(P,S){if(typeof S==="number"){S+=""}if(!S){return}if(typeof S==="string"){S=S.replace(/(<(\w+)[^>]*?)\/>/g,function(U,V,T){return T.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i)?U:V+"></"+T+">"});var O=S.replace(/^\s+/,"").substring(0,10).toLowerCase();var Q=!O.indexOf("<opt")&&[1,"<select multiple='multiple'>","</select>"]||!O.indexOf("<leg")&&[1,"<fieldset>","</fieldset>"]||O.match(/^<(thead|tbody|tfoot|colg|cap)/)&&[1,"<table>","</table>"]||!O.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!O.indexOf("<td")||!O.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||!O.indexOf("<col")&&[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"]||!o.support.htmlSerialize&&[1,"div<div>","</div>"]||[0,"",""];L.innerHTML=Q[1]+S+Q[2];while(Q[0]--){L=L.lastChild}if(!o.support.tbody){var R=/<tbody/i.test(S),N=!O.indexOf("<table")&&!R?L.firstChild&&L.firstChild.childNodes:Q[1]=="<table>"&&!R?L.childNodes:[];for(var M=N.length-1;M>=0;--M){if(o.nodeName(N[M],"tbody")&&!N[M].childNodes.length){N[M].parentNode.removeChild(N[M])}}}if(!o.support.leadingWhitespace&&/^\s/.test(S)){L.insertBefore(K.createTextNode(S.match(/^\s*/)[0]),L.firstChild)}S=o.makeArray(L.childNodes)}if(S.nodeType){G.push(S)}else{G=o.merge(G,S)}});if(I){for(var J=0;G[J];J++){if(o.nodeName(G[J],"script")&&(!G[J].type||G[J].type.toLowerCase()==="text/javascript")){E.push(G[J].parentNode?G[J].parentNode.removeChild(G[J]):G[J])}else{if(G[J].nodeType===1){G.splice.apply(G,[J+1,0].concat(o.makeArray(G[J].getElementsByTagName("script"))))}I.appendChild(G[J])}}return E}return G},attr:function(J,G,K){if(!J||J.nodeType==3||J.nodeType==8){return g}var H=!o.isXMLDoc(J),L=K!==g;G=H&&o.props[G]||G;if(J.tagName){var F=/href|src|style/.test(G);if(G=="selected"&&J.parentNode){J.parentNode.selectedIndex}if(G in J&&H&&!F){if(L){if(G=="type"&&o.nodeName(J,"input")&&J.parentNode){throw"type property can't be changed"}J[G]=K}if(o.nodeName(J,"form")&&J.getAttributeNode(G)){return J.getAttributeNode(G).nodeValue}if(G=="tabIndex"){var I=J.getAttributeNode("tabIndex");return I&&I.specified?I.value:J.nodeName.match(/(button|input|object|select|textarea)/i)?0:J.nodeName.match(/^(a|area)$/i)&&J.href?0:g}return J[G]}if(!o.support.style&&H&&G=="style"){return o.attr(J.style,"cssText",K)}if(L){J.setAttribute(G,""+K)}var E=!o.support.hrefNormalized&&H&&F?J.getAttribute(G,2):J.getAttribute(G);return E===null?g:E}if(!o.support.opacity&&G=="opacity"){if(L){J.zoom=1;J.filter=(J.filter||"").replace(/alpha\([^)]*\)/,"")+(parseInt(K)+""=="NaN"?"":"alpha(opacity="+K*100+")")}return J.filter&&J.filter.indexOf("opacity=")>=0?(parseFloat(J.filter.match(/opacity=([^)]*)/)[1])/100)+"":""}G=G.replace(/-([a-z])/ig,function(M,N){return N.toUpperCase()});if(L){J[G]=K}return J[G]},trim:function(E){return(E||"").replace(/^\s+|\s+$/g,"")},makeArray:function(G){var E=[];if(G!=null){var F=G.length;if(F==null||typeof G==="string"||o.isFunction(G)||G.setInterval){E[0]=G}else{while(F){E[--F]=G[F]}}}return E},inArray:function(G,H){for(var E=0,F=H.length;E<F;E++){if(H[E]===G){return E}}return -1},merge:function(H,E){var F=0,G,I=H.length;if(!o.support.getAll){while((G=E[F++])!=null){if(G.nodeType!=8){H[I++]=G}}}else{while((G=E[F++])!=null){H[I++]=G}}return H},unique:function(K){var F=[],E={};try{for(var G=0,H=K.length;G<H;G++){var J=o.data(K[G]);if(!E[J]){E[J]=true;F.push(K[G])}}}catch(I){F=K}return F},grep:function(F,J,E){var G=[];for(var H=0,I=F.length;H<I;H++){if(!E!=!J(F[H],H)){G.push(F[H])}}return G},map:function(E,J){var F=[];for(var G=0,H=E.length;G<H;G++){var I=J(E[G],G);if(I!=null){F[F.length]=I}}return F.concat.apply([],F)}});var C=navigator.userAgent.toLowerCase();o.browser={version:(C.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(C),opera:/opera/.test(C),msie:/msie/.test(C)&&!/opera/.test(C),mozilla:/mozilla/.test(C)&&!/(compatible|webkit)/.test(C)};o.each({parent:function(E){return E.parentNode},parents:function(E){return o.dir(E,"parentNode")},next:function(E){return o.nth(E,2,"nextSibling")},prev:function(E){return o.nth(E,2,"previousSibling")},nextAll:function(E){return o.dir(E,"nextSibling")},prevAll:function(E){return o.dir(E,"previousSibling")},siblings:function(E){return o.sibling(E.parentNode.firstChild,E)},children:function(E){return o.sibling(E.firstChild)},contents:function(E){return o.nodeName(E,"iframe")?E.contentDocument||E.contentWindow.document:o.makeArray(E.childNodes)}},function(E,F){o.fn[E]=function(G){var H=o.map(this,F);if(G&&typeof G=="string"){H=o.multiFilter(G,H)}return this.pushStack(o.unique(H),E,G)}});o.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(E,F){o.fn[E]=function(G){var J=[],L=o(G);for(var K=0,H=L.length;K<H;K++){var I=(K>0?this.clone(true):this).get();o.fn[F].apply(o(L[K]),I);J=J.concat(I)}return this.pushStack(J,E,G)}});o.each({removeAttr:function(E){o.attr(this,E,"");if(this.nodeType==1){this.removeAttribute(E)}},addClass:function(E){o.className.add(this,E)},removeClass:function(E){o.className.remove(this,E)},toggleClass:function(F,E){if(typeof E!=="boolean"){E=!o.className.has(this,F)}o.className[E?"add":"remove"](this,F)},remove:function(E){if(!E||o.filter(E,[this]).length){o("*",this).add([this]).each(function(){o.event.remove(this);o.removeData(this)});if(this.parentNode){this.parentNode.removeChild(this)}}},empty:function(){o(this).children().remove();while(this.firstChild){this.removeChild(this.firstChild)}}},function(E,F){o.fn[E]=function(){return this.each(F,arguments)}});function j(E,F){return E[0]&&parseInt(o.curCSS(E[0],F,true),10)||0}var h="jQuery"+e(),v=0,A={};o.extend({cache:{},data:function(F,E,G){F=F==l?A:F;var H=F[h];if(!H){H=F[h]=++v}if(E&&!o.cache[H]){o.cache[H]={}}if(G!==g){o.cache[H][E]=G}return E?o.cache[H][E]:H},removeData:function(F,E){F=F==l?A:F;var H=F[h];if(E){if(o.cache[H]){delete o.cache[H][E];E="";for(E in o.cache[H]){break}if(!E){o.removeData(F)}}}else{try{delete F[h]}catch(G){if(F.removeAttribute){F.removeAttribute(h)}}delete o.cache[H]}},queue:function(F,E,H){if(F){E=(E||"fx")+"queue";var G=o.data(F,E);if(!G||o.isArray(H)){G=o.data(F,E,o.makeArray(H))}else{if(H){G.push(H)}}}return G},dequeue:function(H,G){var E=o.queue(H,G),F=E.shift();if(!G||G==="fx"){F=E[0]}if(F!==g){F.call(H)}}});o.fn.extend({data:function(E,G){var H=E.split(".");H[1]=H[1]?"."+H[1]:"";if(G===g){var F=this.triggerHandler("getData"+H[1]+"!",[H[0]]);if(F===g&&this.length){F=o.data(this[0],E)}return F===g&&H[1]?this.data(H[0]):F}else{return this.trigger("setData"+H[1]+"!",[H[0],G]).each(function(){o.data(this,E,G)})}},removeData:function(E){return this.each(function(){o.removeData(this,E)})},queue:function(E,F){if(typeof E!=="string"){F=E;E="fx"}if(F===g){return o.queue(this[0],E)}return this.each(function(){var G=o.queue(this,E,F);if(E=="fx"&&G.length==1){G[0].call(this)}})},dequeue:function(E){return this.each(function(){o.dequeue(this,E)})}});
/*
 * Sizzle CSS Selector Engine - v0.9.3
 *  Copyright 2009, The Dojo Foundation
 *  Released under the MIT, BSD, and GPL Licenses.
 *  More information: http://sizzlejs.com/
 */
(function(){var R=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?/g,L=0,H=Object.prototype.toString;var F=function(Y,U,ab,ac){ab=ab||[];U=U||document;if(U.nodeType!==1&&U.nodeType!==9){return[]}if(!Y||typeof Y!=="string"){return ab}var Z=[],W,af,ai,T,ad,V,X=true;R.lastIndex=0;while((W=R.exec(Y))!==null){Z.push(W[1]);if(W[2]){V=RegExp.rightContext;break}}if(Z.length>1&&M.exec(Y)){if(Z.length===2&&I.relative[Z[0]]){af=J(Z[0]+Z[1],U)}else{af=I.relative[Z[0]]?[U]:F(Z.shift(),U);while(Z.length){Y=Z.shift();if(I.relative[Y]){Y+=Z.shift()}af=J(Y,af)}}}else{var ae=ac?{expr:Z.pop(),set:E(ac)}:F.find(Z.pop(),Z.length===1&&U.parentNode?U.parentNode:U,Q(U));af=F.filter(ae.expr,ae.set);if(Z.length>0){ai=E(af)}else{X=false}while(Z.length){var ah=Z.pop(),ag=ah;if(!I.relative[ah]){ah=""}else{ag=Z.pop()}if(ag==null){ag=U}I.relative[ah](ai,ag,Q(U))}}if(!ai){ai=af}if(!ai){throw"Syntax error, unrecognized expression: "+(ah||Y)}if(H.call(ai)==="[object Array]"){if(!X){ab.push.apply(ab,ai)}else{if(U.nodeType===1){for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&&(ai[aa]===true||ai[aa].nodeType===1&&K(U,ai[aa]))){ab.push(af[aa])}}}else{for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&&ai[aa].nodeType===1){ab.push(af[aa])}}}}}else{E(ai,ab)}if(V){F(V,U,ab,ac);if(G){hasDuplicate=false;ab.sort(G);if(hasDuplicate){for(var aa=1;aa<ab.length;aa++){if(ab[aa]===ab[aa-1]){ab.splice(aa--,1)}}}}}return ab};F.matches=function(T,U){return F(T,null,null,U)};F.find=function(aa,T,ab){var Z,X;if(!aa){return[]}for(var W=0,V=I.order.length;W<V;W++){var Y=I.order[W],X;if((X=I.match[Y].exec(aa))){var U=RegExp.leftContext;if(U.substr(U.length-1)!=="\\"){X[1]=(X[1]||"").replace(/\\/g,"");Z=I.find[Y](X,T,ab);if(Z!=null){aa=aa.replace(I.match[Y],"");break}}}}if(!Z){Z=T.getElementsByTagName("*")}return{set:Z,expr:aa}};F.filter=function(ad,ac,ag,W){var V=ad,ai=[],aa=ac,Y,T,Z=ac&&ac[0]&&Q(ac[0]);while(ad&&ac.length){for(var ab in I.filter){if((Y=I.match[ab].exec(ad))!=null){var U=I.filter[ab],ah,af;T=false;if(aa==ai){ai=[]}if(I.preFilter[ab]){Y=I.preFilter[ab](Y,aa,ag,ai,W,Z);if(!Y){T=ah=true}else{if(Y===true){continue}}}if(Y){for(var X=0;(af=aa[X])!=null;X++){if(af){ah=U(af,Y,X,aa);var ae=W^!!ah;if(ag&&ah!=null){if(ae){T=true}else{aa[X]=false}}else{if(ae){ai.push(af);T=true}}}}}if(ah!==g){if(!ag){aa=ai}ad=ad.replace(I.match[ab],"");if(!T){return[]}break}}}if(ad==V){if(T==null){throw"Syntax error, unrecognized expression: "+ad}else{break}}V=ad}return aa};var I=F.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF_-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF_-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*_-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF_-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(T){return T.getAttribute("href")}},relative:{"+":function(aa,T,Z){var X=typeof T==="string",ab=X&&!/\W/.test(T),Y=X&&!ab;if(ab&&!Z){T=T.toUpperCase()}for(var W=0,V=aa.length,U;W<V;W++){if((U=aa[W])){while((U=U.previousSibling)&&U.nodeType!==1){}aa[W]=Y||U&&U.nodeName===T?U||false:U===T}}if(Y){F.filter(T,aa,true)}},">":function(Z,U,aa){var X=typeof U==="string";if(X&&!/\W/.test(U)){U=aa?U:U.toUpperCase();for(var V=0,T=Z.length;V<T;V++){var Y=Z[V];if(Y){var W=Y.parentNode;Z[V]=W.nodeName===U?W:false}}}else{for(var V=0,T=Z.length;V<T;V++){var Y=Z[V];if(Y){Z[V]=X?Y.parentNode:Y.parentNode===U}}if(X){F.filter(U,Z,true)}}},"":function(W,U,Y){var V=L++,T=S;if(!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T("parentNode",U,V,W,X,Y)},"~":function(W,U,Y){var V=L++,T=S;if(typeof U==="string"&&!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T("previousSibling",U,V,W,X,Y)}},find:{ID:function(U,V,W){if(typeof V.getElementById!=="undefined"&&!W){var T=V.getElementById(U[1]);return T?[T]:[]}},NAME:function(V,Y,Z){if(typeof Y.getElementsByName!=="undefined"){var U=[],X=Y.getElementsByName(V[1]);for(var W=0,T=X.length;W<T;W++){if(X[W].getAttribute("name")===V[1]){U.push(X[W])}}return U.length===0?null:U}},TAG:function(T,U){return U.getElementsByTagName(T[1])}},preFilter:{CLASS:function(W,U,V,T,Z,aa){W=" "+W[1].replace(/\\/g,"")+" ";if(aa){return W}for(var X=0,Y;(Y=U[X])!=null;X++){if(Y){if(Z^(Y.className&&(" "+Y.className+" ").indexOf(W)>=0)){if(!V){T.push(Y)}}else{if(V){U[X]=false}}}}return false},ID:function(T){return T[1].replace(/\\/g,"")},TAG:function(U,T){for(var V=0;T[V]===false;V++){}return T[V]&&Q(T[V])?U[1]:U[1].toUpperCase()},CHILD:function(T){if(T[1]=="nth"){var U=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(T[2]=="even"&&"2n"||T[2]=="odd"&&"2n+1"||!/\D/.test(T[2])&&"0n+"+T[2]||T[2]);T[2]=(U[1]+(U[2]||1))-0;T[3]=U[3]-0}T[0]=L++;return T},ATTR:function(X,U,V,T,Y,Z){var W=X[1].replace(/\\/g,"");if(!Z&&I.attrMap[W]){X[1]=I.attrMap[W]}if(X[2]==="~="){X[4]=" "+X[4]+" "}return X},PSEUDO:function(X,U,V,T,Y){if(X[1]==="not"){if(X[3].match(R).length>1||/^\w/.test(X[3])){X[3]=F(X[3],null,null,U)}else{var W=F.filter(X[3],U,V,true^Y);if(!V){T.push.apply(T,W)}return false}}else{if(I.match.POS.test(X[0])||I.match.CHILD.test(X[0])){return true}}return X},POS:function(T){T.unshift(true);return T}},filters:{enabled:function(T){return T.disabled===false&&T.type!=="hidden"},disabled:function(T){return T.disabled===true},checked:function(T){return T.checked===true},selected:function(T){T.parentNode.selectedIndex;return T.selected===true},parent:function(T){return !!T.firstChild},empty:function(T){return !T.firstChild},has:function(V,U,T){return !!F(T[3],V).length},header:function(T){return/h\d/i.test(T.nodeName)},text:function(T){return"text"===T.type},radio:function(T){return"radio"===T.type},checkbox:function(T){return"checkbox"===T.type},file:function(T){return"file"===T.type},password:function(T){return"password"===T.type},submit:function(T){return"submit"===T.type},image:function(T){return"image"===T.type},reset:function(T){return"reset"===T.type},button:function(T){return"button"===T.type||T.nodeName.toUpperCase()==="BUTTON"},input:function(T){return/input|select|textarea|button/i.test(T.nodeName)}},setFilters:{first:function(U,T){return T===0},last:function(V,U,T,W){return U===W.length-1},even:function(U,T){return T%2===0},odd:function(U,T){return T%2===1},lt:function(V,U,T){return U<T[3]-0},gt:function(V,U,T){return U>T[3]-0},nth:function(V,U,T){return T[3]-0==U},eq:function(V,U,T){return T[3]-0==U}},filter:{PSEUDO:function(Z,V,W,aa){var U=V[1],X=I.filters[U];if(X){return X(Z,W,V,aa)}else{if(U==="contains"){return(Z.textContent||Z.innerText||"").indexOf(V[3])>=0}else{if(U==="not"){var Y=V[3];for(var W=0,T=Y.length;W<T;W++){if(Y[W]===Z){return false}}return true}}}},CHILD:function(T,W){var Z=W[1],U=T;switch(Z){case"only":case"first":while(U=U.previousSibling){if(U.nodeType===1){return false}}if(Z=="first"){return true}U=T;case"last":while(U=U.nextSibling){if(U.nodeType===1){return false}}return true;case"nth":var V=W[2],ac=W[3];if(V==1&&ac==0){return true}var Y=W[0],ab=T.parentNode;if(ab&&(ab.sizcache!==Y||!T.nodeIndex)){var X=0;for(U=ab.firstChild;U;U=U.nextSibling){if(U.nodeType===1){U.nodeIndex=++X}}ab.sizcache=Y}var aa=T.nodeIndex-ac;if(V==0){return aa==0}else{return(aa%V==0&&aa/V>=0)}}},ID:function(U,T){return U.nodeType===1&&U.getAttribute("id")===T},TAG:function(U,T){return(T==="*"&&U.nodeType===1)||U.nodeName===T},CLASS:function(U,T){return(" "+(U.className||U.getAttribute("class"))+" ").indexOf(T)>-1},ATTR:function(Y,W){var V=W[1],T=I.attrHandle[V]?I.attrHandle[V](Y):Y[V]!=null?Y[V]:Y.getAttribute(V),Z=T+"",X=W[2],U=W[4];return T==null?X==="!=":X==="="?Z===U:X==="*="?Z.indexOf(U)>=0:X==="~="?(" "+Z+" ").indexOf(U)>=0:!U?Z&&T!==false:X==="!="?Z!=U:X==="^="?Z.indexOf(U)===0:X==="$="?Z.substr(Z.length-U.length)===U:X==="|="?Z===U||Z.substr(0,U.length+1)===U+"-":false},POS:function(X,U,V,Y){var T=U[2],W=I.setFilters[T];if(W){return W(X,V,U,Y)}}}};var M=I.match.POS;for(var O in I.match){I.match[O]=RegExp(I.match[O].source+/(?![^\[]*\])(?![^\(]*\))/.source)}var E=function(U,T){U=Array.prototype.slice.call(U);if(T){T.push.apply(T,U);return T}return U};try{Array.prototype.slice.call(document.documentElement.childNodes)}catch(N){E=function(X,W){var U=W||[];if(H.call(X)==="[object Array]"){Array.prototype.push.apply(U,X)}else{if(typeof X.length==="number"){for(var V=0,T=X.length;V<T;V++){U.push(X[V])}}else{for(var V=0;X[V];V++){U.push(X[V])}}}return U}}var G;if(document.documentElement.compareDocumentPosition){G=function(U,T){var V=U.compareDocumentPosition(T)&4?-1:U===T?0:1;if(V===0){hasDuplicate=true}return V}}else{if("sourceIndex" in document.documentElement){G=function(U,T){var V=U.sourceIndex-T.sourceIndex;if(V===0){hasDuplicate=true}return V}}else{if(document.createRange){G=function(W,U){var V=W.ownerDocument.createRange(),T=U.ownerDocument.createRange();V.selectNode(W);V.collapse(true);T.selectNode(U);T.collapse(true);var X=V.compareBoundaryPoints(Range.START_TO_END,T);if(X===0){hasDuplicate=true}return X}}}}(function(){var U=document.createElement("form"),V="script"+(new Date).getTime();U.innerHTML="<input name='"+V+"'/>";var T=document.documentElement;T.insertBefore(U,T.firstChild);if(!!document.getElementById(V)){I.find.ID=function(X,Y,Z){if(typeof Y.getElementById!=="undefined"&&!Z){var W=Y.getElementById(X[1]);return W?W.id===X[1]||typeof W.getAttributeNode!=="undefined"&&W.getAttributeNode("id").nodeValue===X[1]?[W]:g:[]}};I.filter.ID=function(Y,W){var X=typeof Y.getAttributeNode!=="undefined"&&Y.getAttributeNode("id");return Y.nodeType===1&&X&&X.nodeValue===W}}T.removeChild(U)})();(function(){var T=document.createElement("div");T.appendChild(document.createComment(""));if(T.getElementsByTagName("*").length>0){I.find.TAG=function(U,Y){var X=Y.getElementsByTagName(U[1]);if(U[1]==="*"){var W=[];for(var V=0;X[V];V++){if(X[V].nodeType===1){W.push(X[V])}}X=W}return X}}T.innerHTML="<a href='#'></a>";if(T.firstChild&&typeof T.firstChild.getAttribute!=="undefined"&&T.firstChild.getAttribute("href")!=="#"){I.attrHandle.href=function(U){return U.getAttribute("href",2)}}})();if(document.querySelectorAll){(function(){var T=F,U=document.createElement("div");U.innerHTML="<p class='TEST'></p>";if(U.querySelectorAll&&U.querySelectorAll(".TEST").length===0){return}F=function(Y,X,V,W){X=X||document;if(!W&&X.nodeType===9&&!Q(X)){try{return E(X.querySelectorAll(Y),V)}catch(Z){}}return T(Y,X,V,W)};F.find=T.find;F.filter=T.filter;F.selectors=T.selectors;F.matches=T.matches})()}if(document.getElementsByClassName&&document.documentElement.getElementsByClassName){(function(){var T=document.createElement("div");T.innerHTML="<div class='test e'></div><div class='test'></div>";if(T.getElementsByClassName("e").length===0){return}T.lastChild.className="e";if(T.getElementsByClassName("e").length===1){return}I.order.splice(1,0,"CLASS");I.find.CLASS=function(U,V,W){if(typeof V.getElementsByClassName!=="undefined"&&!W){return V.getElementsByClassName(U[1])}}})()}function P(U,Z,Y,ad,aa,ac){var ab=U=="previousSibling"&&!ac;for(var W=0,V=ad.length;W<V;W++){var T=ad[W];if(T){if(ab&&T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1&&!ac){T.sizcache=Y;T.sizset=W}if(T.nodeName===Z){X=T;break}T=T[U]}ad[W]=X}}}function S(U,Z,Y,ad,aa,ac){var ab=U=="previousSibling"&&!ac;for(var W=0,V=ad.length;W<V;W++){var T=ad[W];if(T){if(ab&&T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1){if(!ac){T.sizcache=Y;T.sizset=W}if(typeof Z!=="string"){if(T===Z){X=true;break}}else{if(F.filter(Z,[T]).length>0){X=T;break}}}T=T[U]}ad[W]=X}}}var K=document.compareDocumentPosition?function(U,T){return U.compareDocumentPosition(T)&16}:function(U,T){return U!==T&&(U.contains?U.contains(T):true)};var Q=function(T){return T.nodeType===9&&T.documentElement.nodeName!=="HTML"||!!T.ownerDocument&&Q(T.ownerDocument)};var J=function(T,aa){var W=[],X="",Y,V=aa.nodeType?[aa]:aa;while((Y=I.match.PSEUDO.exec(T))){X+=Y[0];T=T.replace(I.match.PSEUDO,"")}T=I.relative[T]?T+"*":T;for(var Z=0,U=V.length;Z<U;Z++){F(T,V[Z],W)}return F.filter(X,W)};o.find=F;o.filter=F.filter;o.expr=F.selectors;o.expr[":"]=o.expr.filters;F.selectors.filters.hidden=function(T){return T.offsetWidth===0||T.offsetHeight===0};F.selectors.filters.visible=function(T){return T.offsetWidth>0||T.offsetHeight>0};F.selectors.filters.animated=function(T){return o.grep(o.timers,function(U){return T===U.elem}).length};o.multiFilter=function(V,T,U){if(U){V=":not("+V+")"}return F.matches(V,T)};o.dir=function(V,U){var T=[],W=V[U];while(W&&W!=document){if(W.nodeType==1){T.push(W)}W=W[U]}return T};o.nth=function(X,T,V,W){T=T||1;var U=0;for(;X;X=X[V]){if(X.nodeType==1&&++U==T){break}}return X};o.sibling=function(V,U){var T=[];for(;V;V=V.nextSibling){if(V.nodeType==1&&V!=U){T.push(V)}}return T};return;l.Sizzle=F})();o.event={add:function(I,F,H,K){if(I.nodeType==3||I.nodeType==8){return}if(I.setInterval&&I!=l){I=l}if(!H.guid){H.guid=this.guid++}if(K!==g){var G=H;H=this.proxy(G);H.data=K}var E=o.data(I,"events")||o.data(I,"events",{}),J=o.data(I,"handle")||o.data(I,"handle",function(){return typeof o!=="undefined"&&!o.event.triggered?o.event.handle.apply(arguments.callee.elem,arguments):g});J.elem=I;o.each(F.split(/\s+/),function(M,N){var O=N.split(".");N=O.shift();H.type=O.slice().sort().join(".");var L=E[N];if(o.event.specialAll[N]){o.event.specialAll[N].setup.call(I,K,O)}if(!L){L=E[N]={};if(!o.event.special[N]||o.event.special[N].setup.call(I,K,O)===false){if(I.addEventListener){I.addEventListener(N,J,false)}else{if(I.attachEvent){I.attachEvent("on"+N,J)}}}}L[H.guid]=H;o.event.global[N]=true});I=null},guid:1,global:{},remove:function(K,H,J){if(K.nodeType==3||K.nodeType==8){return}var G=o.data(K,"events"),F,E;if(G){if(H===g||(typeof H==="string"&&H.charAt(0)==".")){for(var I in G){this.remove(K,I+(H||""))}}else{if(H.type){J=H.handler;H=H.type}o.each(H.split(/\s+/),function(M,O){var Q=O.split(".");O=Q.shift();var N=RegExp("(^|\\.)"+Q.slice().sort().join(".*\\.")+"(\\.|$)");if(G[O]){if(J){delete G[O][J.guid]}else{for(var P in G[O]){if(N.test(G[O][P].type)){delete G[O][P]}}}if(o.event.specialAll[O]){o.event.specialAll[O].teardown.call(K,Q)}for(F in G[O]){break}if(!F){if(!o.event.special[O]||o.event.special[O].teardown.call(K,Q)===false){if(K.removeEventListener){K.removeEventListener(O,o.data(K,"handle"),false)}else{if(K.detachEvent){K.detachEvent("on"+O,o.data(K,"handle"))}}}F=null;delete G[O]}}})}for(F in G){break}if(!F){var L=o.data(K,"handle");if(L){L.elem=null}o.removeData(K,"events");o.removeData(K,"handle")}}},trigger:function(I,K,H,E){var G=I.type||I;if(!E){I=typeof I==="object"?I[h]?I:o.extend(o.Event(G),I):o.Event(G);if(G.indexOf("!")>=0){I.type=G=G.slice(0,-1);I.exclusive=true}if(!H){I.stopPropagation();if(this.global[G]){o.each(o.cache,function(){if(this.events&&this.events[G]){o.event.trigger(I,K,this.handle.elem)}})}}if(!H||H.nodeType==3||H.nodeType==8){return g}I.result=g;I.target=H;K=o.makeArray(K);K.unshift(I)}I.currentTarget=H;var J=o.data(H,"handle");if(J){J.apply(H,K)}if((!H[G]||(o.nodeName(H,"a")&&G=="click"))&&H["on"+G]&&H["on"+G].apply(H,K)===false){I.result=false}if(!E&&H[G]&&!I.isDefaultPrevented()&&!(o.nodeName(H,"a")&&G=="click")){this.triggered=true;try{H[G]()}catch(L){}}this.triggered=false;if(!I.isPropagationStopped()){var F=H.parentNode||H.ownerDocument;if(F){o.event.trigger(I,K,F,true)}}},handle:function(K){var J,E;K=arguments[0]=o.event.fix(K||l.event);K.currentTarget=this;var L=K.type.split(".");K.type=L.shift();J=!L.length&&!K.exclusive;var I=RegExp("(^|\\.)"+L.slice().sort().join(".*\\.")+"(\\.|$)");E=(o.data(this,"events")||{})[K.type];for(var G in E){var H=E[G];if(J||I.test(H.type)){K.handler=H;K.data=H.data;var F=H.apply(this,arguments);if(F!==g){K.result=F;if(F===false){K.preventDefault();K.stopPropagation()}}if(K.isImmediatePropagationStopped()){break}}}},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode metaKey newValue originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),fix:function(H){if(H[h]){return H}var F=H;H=o.Event(F);for(var G=this.props.length,J;G;){J=this.props[--G];H[J]=F[J]}if(!H.target){H.target=H.srcElement||document}if(H.target.nodeType==3){H.target=H.target.parentNode}if(!H.relatedTarget&&H.fromElement){H.relatedTarget=H.fromElement==H.target?H.toElement:H.fromElement}if(H.pageX==null&&H.clientX!=null){var I=document.documentElement,E=document.body;H.pageX=H.clientX+(I&&I.scrollLeft||E&&E.scrollLeft||0)-(I.clientLeft||0);H.pageY=H.clientY+(I&&I.scrollTop||E&&E.scrollTop||0)-(I.clientTop||0)}if(!H.which&&((H.charCode||H.charCode===0)?H.charCode:H.keyCode)){H.which=H.charCode||H.keyCode}if(!H.metaKey&&H.ctrlKey){H.metaKey=H.ctrlKey}if(!H.which&&H.button){H.which=(H.button&1?1:(H.button&2?3:(H.button&4?2:0)))}return H},proxy:function(F,E){E=E||function(){return F.apply(this,arguments)};E.guid=F.guid=F.guid||E.guid||this.guid++;return E},special:{ready:{setup:B,teardown:function(){}}},specialAll:{live:{setup:function(E,F){o.event.add(this,F[0],c)},teardown:function(G){if(G.length){var E=0,F=RegExp("(^|\\.)"+G[0]+"(\\.|$)");o.each((o.data(this,"events").live||{}),function(){if(F.test(this.type)){E++}});if(E<1){o.event.remove(this,G[0],c)}}}}}};o.Event=function(E){if(!this.preventDefault){return new o.Event(E)}if(E&&E.type){this.originalEvent=E;this.type=E.type}else{this.type=E}this.timeStamp=e();this[h]=true};function k(){return false}function u(){return true}o.Event.prototype={preventDefault:function(){this.isDefaultPrevented=u;var E=this.originalEvent;if(!E){return}if(E.preventDefault){E.preventDefault()}E.returnValue=false},stopPropagation:function(){this.isPropagationStopped=u;var E=this.originalEvent;if(!E){return}if(E.stopPropagation){E.stopPropagation()}E.cancelBubble=true},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=u;this.stopPropagation()},isDefaultPrevented:k,isPropagationStopped:k,isImmediatePropagationStopped:k};var a=function(F){var E=F.relatedTarget;while(E&&E!=this){try{E=E.parentNode}catch(G){E=this}}if(E!=this){F.type=F.data;o.event.handle.apply(this,arguments)}};o.each({mouseover:"mouseenter",mouseout:"mouseleave"},function(F,E){o.event.special[E]={setup:function(){o.event.add(this,F,a,E)},teardown:function(){o.event.remove(this,F,a)}}});o.fn.extend({bind:function(F,G,E){return F=="unload"?this.one(F,G,E):this.each(function(){o.event.add(this,F,E||G,E&&G)})},one:function(G,H,F){var E=o.event.proxy(F||H,function(I){o(this).unbind(I,E);return(F||H).apply(this,arguments)});return this.each(function(){o.event.add(this,G,E,F&&H)})},unbind:function(F,E){return this.each(function(){o.event.remove(this,F,E)})},trigger:function(E,F){return this.each(function(){o.event.trigger(E,F,this)})},triggerHandler:function(E,G){if(this[0]){var F=o.Event(E);F.preventDefault();F.stopPropagation();o.event.trigger(F,G,this[0]);return F.result}},toggle:function(G){var E=arguments,F=1;while(F<E.length){o.event.proxy(G,E[F++])}return this.click(o.event.proxy(G,function(H){this.lastToggle=(this.lastToggle||0)%F;H.preventDefault();return E[this.lastToggle++].apply(this,arguments)||false}))},hover:function(E,F){return this.mouseenter(E).mouseleave(F)},ready:function(E){B();if(o.isReady){E.call(document,o)}else{o.readyList.push(E)}return this},live:function(G,F){var E=o.event.proxy(F);E.guid+=this.selector+G;o(document).bind(i(G,this.selector),this.selector,E);return this},die:function(F,E){o(document).unbind(i(F,this.selector),E?{guid:E.guid+this.selector+F}:null);return this}});function c(H){var E=RegExp("(^|\\.)"+H.type+"(\\.|$)"),G=true,F=[];o.each(o.data(this,"events").live||[],function(I,J){if(E.test(J.type)){var K=o(H.target).closest(J.data)[0];if(K){F.push({elem:K,fn:J})}}});F.sort(function(J,I){return o.data(J.elem,"closest")-o.data(I.elem,"closest")});o.each(F,function(){if(this.fn.call(this.elem,H,this.fn.data)===false){return(G=false)}});return G}function i(F,E){return["live",F,E.replace(/\./g,"`").replace(/ /g,"|")].join(".")}o.extend({isReady:false,readyList:[],ready:function(){if(!o.isReady){o.isReady=true;if(o.readyList){o.each(o.readyList,function(){this.call(document,o)});o.readyList=null}o(document).triggerHandler("ready")}}});var x=false;function B(){if(x){return}x=true;if(document.addEventListener){document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,false);o.ready()},false)}else{if(document.attachEvent){document.attachEvent("onreadystatechange",function(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",arguments.callee);o.ready()}});if(document.documentElement.doScroll&&l==l.top){(function(){if(o.isReady){return}try{document.documentElement.doScroll("left")}catch(E){setTimeout(arguments.callee,0);return}o.ready()})()}}}o.event.add(l,"load",o.ready)}o.each(("blur,focus,load,resize,scroll,unload,click,dblclick,mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,change,select,submit,keydown,keypress,keyup,error").split(","),function(F,E){o.fn[E]=function(G){return G?this.bind(E,G):this.trigger(E)}});o(l).bind("unload",function(){for(var E in o.cache){if(E!=1&&o.cache[E].handle){o.event.remove(o.cache[E].handle.elem)}}});(function(){o.support={};var F=document.documentElement,G=document.createElement("script"),K=document.createElement("div"),J="script"+(new Date).getTime();K.style.display="none";K.innerHTML='   <link/><table></table><a href="/a" style="color:red;float:left;opacity:.5;">a</a><select><option>text</option></select><object><param/></object>';var H=K.getElementsByTagName("*"),E=K.getElementsByTagName("a")[0];if(!H||!H.length||!E){return}o.support={leadingWhitespace:K.firstChild.nodeType==3,tbody:!K.getElementsByTagName("tbody").length,objectAll:!!K.getElementsByTagName("object")[0].getElementsByTagName("*").length,htmlSerialize:!!K.getElementsByTagName("link").length,style:/red/.test(E.getAttribute("style")),hrefNormalized:E.getAttribute("href")==="/a",opacity:E.style.opacity==="0.5",cssFloat:!!E.style.cssFloat,scriptEval:false,noCloneEvent:true,boxModel:null};G.type="text/javascript";try{G.appendChild(document.createTextNode("window."+J+"=1;"))}catch(I){}F.insertBefore(G,F.firstChild);if(l[J]){o.support.scriptEval=true;delete l[J]}F.removeChild(G);if(K.attachEvent&&K.fireEvent){K.attachEvent("onclick",function(){o.support.noCloneEvent=false;K.detachEvent("onclick",arguments.callee)});K.cloneNode(true).fireEvent("onclick")}o(function(){var L=document.createElement("div");L.style.width=L.style.paddingLeft="1px";document.body.appendChild(L);o.boxModel=o.support.boxModel=L.offsetWidth===2;document.body.removeChild(L).style.display="none"})})();var w=o.support.cssFloat?"cssFloat":"styleFloat";o.props={"for":"htmlFor","class":"className","float":w,cssFloat:w,styleFloat:w,readonly:"readOnly",maxlength:"maxLength",cellspacing:"cellSpacing",rowspan:"rowSpan",tabindex:"tabIndex"};o.fn.extend({_load:o.fn.load,load:function(G,J,K){if(typeof G!=="string"){return this._load(G)}var I=G.indexOf(" ");if(I>=0){var E=G.slice(I,G.length);G=G.slice(0,I)}var H="GET";if(J){if(o.isFunction(J)){K=J;J=null}else{if(typeof J==="object"){J=o.param(J);H="POST"}}}var F=this;o.ajax({url:G,type:H,dataType:"html",data:J,complete:function(M,L){if(L=="success"||L=="notmodified"){F.html(E?o("<div/>").append(M.responseText.replace(/<script(.|\s)*?\/script>/g,"")).find(E):M.responseText)}if(K){F.each(K,[M.responseText,L,M])}}});return this},serialize:function(){return o.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?o.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||/select|textarea/i.test(this.nodeName)||/text|hidden|password|search/i.test(this.type))}).map(function(E,F){var G=o(this).val();return G==null?null:o.isArray(G)?o.map(G,function(I,H){return{name:F.name,value:I}}):{name:F.name,value:G}}).get()}});o.each("ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend".split(","),function(E,F){o.fn[F]=function(G){return this.bind(F,G)}});var r=e();o.extend({get:function(E,G,H,F){if(o.isFunction(G)){H=G;G=null}return o.ajax({type:"GET",url:E,data:G,success:H,dataType:F})},getScript:function(E,F){return o.get(E,null,F,"script")},getJSON:function(E,F,G){return o.get(E,F,G,"json")},post:function(E,G,H,F){if(o.isFunction(G)){H=G;G={}}return o.ajax({type:"POST",url:E,data:G,success:H,dataType:F})},ajaxSetup:function(E){o.extend(o.ajaxSettings,E)},ajaxSettings:{url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return l.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},lastModified:{},ajax:function(M){M=o.extend(true,M,o.extend(true,{},o.ajaxSettings,M));var W,F=/=\?(&|$)/g,R,V,G=M.type.toUpperCase();if(M.data&&M.processData&&typeof M.data!=="string"){M.data=o.param(M.data)}if(M.dataType=="jsonp"){if(G=="GET"){if(!M.url.match(F)){M.url+=(M.url.match(/\?/)?"&":"?")+(M.jsonp||"callback")+"=?"}}else{if(!M.data||!M.data.match(F)){M.data=(M.data?M.data+"&":"")+(M.jsonp||"callback")+"=?"}}M.dataType="json"}if(M.dataType=="json"&&(M.data&&M.data.match(F)||M.url.match(F))){W="jsonp"+r++;if(M.data){M.data=(M.data+"").replace(F,"="+W+"$1")}M.url=M.url.replace(F,"="+W+"$1");M.dataType="script";l[W]=function(X){V=X;I();L();l[W]=g;try{delete l[W]}catch(Y){}if(H){H.removeChild(T)}}}if(M.dataType=="script"&&M.cache==null){M.cache=false}if(M.cache===false&&G=="GET"){var E=e();var U=M.url.replace(/(\?|&)_=.*?(&|$)/,"$1_="+E+"$2");M.url=U+((U==M.url)?(M.url.match(/\?/)?"&":"?")+"_="+E:"")}if(M.data&&G=="GET"){M.url+=(M.url.match(/\?/)?"&":"?")+M.data;M.data=null}if(M.global&&!o.active++){o.event.trigger("ajaxStart")}var Q=/^(\w+:)?\/\/([^\/?#]+)/.exec(M.url);if(M.dataType=="script"&&G=="GET"&&Q&&(Q[1]&&Q[1]!=location.protocol||Q[2]!=location.host)){var H=document.getElementsByTagName("head")[0];var T=document.createElement("script");T.src=M.url;if(M.scriptCharset){T.charset=M.scriptCharset}if(!W){var O=false;T.onload=T.onreadystatechange=function(){if(!O&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){O=true;I();L();T.onload=T.onreadystatechange=null;H.removeChild(T)}}}H.appendChild(T);return g}var K=false;var J=M.xhr();if(M.username){J.open(G,M.url,M.async,M.username,M.password)}else{J.open(G,M.url,M.async)}try{if(M.data){J.setRequestHeader("Content-Type",M.contentType)}if(M.ifModified){J.setRequestHeader("If-Modified-Since",o.lastModified[M.url]||"Thu, 01 Jan 1970 00:00:00 GMT")}J.setRequestHeader("X-Requested-With","XMLHttpRequest");J.setRequestHeader("Accept",M.dataType&&M.accepts[M.dataType]?M.accepts[M.dataType]+", */*":M.accepts._default)}catch(S){}if(M.beforeSend&&M.beforeSend(J,M)===false){if(M.global&&!--o.active){o.event.trigger("ajaxStop")}J.abort();return false}if(M.global){o.event.trigger("ajaxSend",[J,M])}var N=function(X){if(J.readyState==0){if(P){clearInterval(P);P=null;if(M.global&&!--o.active){o.event.trigger("ajaxStop")}}}else{if(!K&&J&&(J.readyState==4||X=="timeout")){K=true;if(P){clearInterval(P);P=null}R=X=="timeout"?"timeout":!o.httpSuccess(J)?"error":M.ifModified&&o.httpNotModified(J,M.url)?"notmodified":"success";if(R=="success"){try{V=o.httpData(J,M.dataType,M)}catch(Z){R="parsererror"}}if(R=="success"){var Y;try{Y=J.getResponseHeader("Last-Modified")}catch(Z){}if(M.ifModified&&Y){o.lastModified[M.url]=Y}if(!W){I()}}else{o.handleError(M,J,R)}L();if(X){J.abort()}if(M.async){J=null}}}};if(M.async){var P=setInterval(N,13);if(M.timeout>0){setTimeout(function(){if(J&&!K){N("timeout")}},M.timeout)}}try{J.send(M.data)}catch(S){o.handleError(M,J,null,S)}if(!M.async){N()}function I(){if(M.success){M.success(V,R)}if(M.global){o.event.trigger("ajaxSuccess",[J,M])}}function L(){if(M.complete){M.complete(J,R)}if(M.global){o.event.trigger("ajaxComplete",[J,M])}if(M.global&&!--o.active){o.event.trigger("ajaxStop")}}return J},handleError:function(F,H,E,G){if(F.error){F.error(H,E,G)}if(F.global){o.event.trigger("ajaxError",[H,F,G])}},active:0,httpSuccess:function(F){try{return !F.status&&location.protocol=="file:"||(F.status>=200&&F.status<300)||F.status==304||F.status==1223}catch(E){}return false},httpNotModified:function(G,E){try{var H=G.getResponseHeader("Last-Modified");return G.status==304||H==o.lastModified[E]}catch(F){}return false},httpData:function(J,H,G){var F=J.getResponseHeader("content-type"),E=H=="xml"||!H&&F&&F.indexOf("xml")>=0,I=E?J.responseXML:J.responseText;if(E&&I.documentElement.tagName=="parsererror"){throw"parsererror"}if(G&&G.dataFilter){I=G.dataFilter(I,H)}if(typeof I==="string"){if(H=="script"){o.globalEval(I)}if(H=="json"){I=l["eval"]("("+I+")")}}return I},param:function(E){var G=[];function H(I,J){G[G.length]=encodeURIComponent(I)+"="+encodeURIComponent(J)}if(o.isArray(E)||E.jquery){o.each(E,function(){H(this.name,this.value)})}else{for(var F in E){if(o.isArray(E[F])){o.each(E[F],function(){H(F,this)})}else{H(F,o.isFunction(E[F])?E[F]():E[F])}}}return G.join("&").replace(/%20/g,"+")}});var m={},n,d=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]];function t(F,E){var G={};o.each(d.concat.apply([],d.slice(0,E)),function(){G[this]=F});return G}o.fn.extend({show:function(J,L){if(J){return this.animate(t("show",3),J,L)}else{for(var H=0,F=this.length;H<F;H++){var E=o.data(this[H],"olddisplay");this[H].style.display=E||"";if(o.css(this[H],"display")==="none"){var G=this[H].tagName,K;if(m[G]){K=m[G]}else{var I=o("<"+G+" />").appendTo("body");K=I.css("display");if(K==="none"){K="block"}I.remove();m[G]=K}o.data(this[H],"olddisplay",K)}}for(var H=0,F=this.length;H<F;H++){this[H].style.display=o.data(this[H],"olddisplay")||""}return this}},hide:function(H,I){if(H){return this.animate(t("hide",3),H,I)}else{for(var G=0,F=this.length;G<F;G++){var E=o.data(this[G],"olddisplay");if(!E&&E!=="none"){o.data(this[G],"olddisplay",o.css(this[G],"display"))}}for(var G=0,F=this.length;G<F;G++){this[G].style.display="none"}return this}},_toggle:o.fn.toggle,toggle:function(G,F){var E=typeof G==="boolean";return o.isFunction(G)&&o.isFunction(F)?this._toggle.apply(this,arguments):G==null||E?this.each(function(){var H=E?G:o(this).is(":hidden");o(this)[H?"show":"hide"]()}):this.animate(t("toggle",3),G,F)},fadeTo:function(E,G,F){return this.animate({opacity:G},E,F)},animate:function(I,F,H,G){var E=o.speed(F,H,G);return this[E.queue===false?"each":"queue"](function(){var K=o.extend({},E),M,L=this.nodeType==1&&o(this).is(":hidden"),J=this;for(M in I){if(I[M]=="hide"&&L||I[M]=="show"&&!L){return K.complete.call(this)}if((M=="height"||M=="width")&&this.style){K.display=o.css(this,"display");K.overflow=this.style.overflow}}if(K.overflow!=null){this.style.overflow="hidden"}K.curAnim=o.extend({},I);o.each(I,function(O,S){var R=new o.fx(J,K,O);if(/toggle|show|hide/.test(S)){R[S=="toggle"?L?"show":"hide":S](I)}else{var Q=S.toString().match(/^([+-]=)?([\d+-.]+)(.*)$/),T=R.cur(true)||0;if(Q){var N=parseFloat(Q[2]),P=Q[3]||"px";if(P!="px"){J.style[O]=(N||1)+P;T=((N||1)/R.cur(true))*T;J.style[O]=T+P}if(Q[1]){N=((Q[1]=="-="?-1:1)*N)+T}R.custom(T,N,P)}else{R.custom(T,S,"")}}});return true})},stop:function(F,E){var G=o.timers;if(F){this.queue([])}this.each(function(){for(var H=G.length-1;H>=0;H--){if(G[H].elem==this){if(E){G[H](true)}G.splice(H,1)}}});if(!E){this.dequeue()}return this}});o.each({slideDown:t("show",1),slideUp:t("hide",1),slideToggle:t("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"}},function(E,F){o.fn[E]=function(G,H){return this.animate(F,G,H)}});o.extend({speed:function(G,H,F){var E=typeof G==="object"?G:{complete:F||!F&&H||o.isFunction(G)&&G,duration:G,easing:F&&H||H&&!o.isFunction(H)&&H};E.duration=o.fx.off?0:typeof E.duration==="number"?E.duration:o.fx.speeds[E.duration]||o.fx.speeds._default;E.old=E.complete;E.complete=function(){if(E.queue!==false){o(this).dequeue()}if(o.isFunction(E.old)){E.old.call(this)}};return E},easing:{linear:function(G,H,E,F){return E+F*G},swing:function(G,H,E,F){return((-Math.cos(G*Math.PI)/2)+0.5)*F+E}},timers:[],fx:function(F,E,G){this.options=E;this.elem=F;this.prop=G;if(!E.orig){E.orig={}}}});o.fx.prototype={update:function(){if(this.options.step){this.options.step.call(this.elem,this.now,this)}(o.fx.step[this.prop]||o.fx.step._default)(this);if((this.prop=="height"||this.prop=="width")&&this.elem.style){this.elem.style.display="block"}},cur:function(F){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null)){return this.elem[this.prop]}var E=parseFloat(o.css(this.elem,this.prop,F));return E&&E>-10000?E:parseFloat(o.curCSS(this.elem,this.prop))||0},custom:function(I,H,G){this.startTime=e();this.start=I;this.end=H;this.unit=G||this.unit||"px";this.now=this.start;this.pos=this.state=0;var E=this;function F(J){return E.step(J)}F.elem=this.elem;if(F()&&o.timers.push(F)&&!n){n=setInterval(function(){var K=o.timers;for(var J=0;J<K.length;J++){if(!K[J]()){K.splice(J--,1)}}if(!K.length){clearInterval(n);n=g}},13)}},show:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.show=true;this.custom(this.prop=="width"||this.prop=="height"?1:0,this.cur());o(this.elem).show()},hide:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.hide=true;this.custom(this.cur(),0)},step:function(H){var G=e();if(H||G>=this.options.duration+this.startTime){this.now=this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;var E=true;for(var F in this.options.curAnim){if(this.options.curAnim[F]!==true){E=false}}if(E){if(this.options.display!=null){this.elem.style.overflow=this.options.overflow;this.elem.style.display=this.options.display;if(o.css(this.elem,"display")=="none"){this.elem.style.display="block"}}if(this.options.hide){o(this.elem).hide()}if(this.options.hide||this.options.show){for(var I in this.options.curAnim){o.attr(this.elem.style,I,this.options.orig[I])}}this.options.complete.call(this.elem)}return false}else{var J=G-this.startTime;this.state=J/this.options.duration;this.pos=o.easing[this.options.easing||(o.easing.swing?"swing":"linear")](this.state,J,0,1,this.options.duration);this.now=this.start+((this.end-this.start)*this.pos);this.update()}return true}};o.extend(o.fx,{speeds:{slow:600,fast:200,_default:400},step:{opacity:function(E){o.attr(E.elem.style,"opacity",E.now)},_default:function(E){if(E.elem.style&&E.elem.style[E.prop]!=null){E.elem.style[E.prop]=E.now+E.unit}else{E.elem[E.prop]=E.now}}}});if(document.documentElement.getBoundingClientRect){o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}var G=this[0].getBoundingClientRect(),J=this[0].ownerDocument,F=J.body,E=J.documentElement,L=E.clientTop||F.clientTop||0,K=E.clientLeft||F.clientLeft||0,I=G.top+(self.pageYOffset||o.boxModel&&E.scrollTop||F.scrollTop)-L,H=G.left+(self.pageXOffset||o.boxModel&&E.scrollLeft||F.scrollLeft)-K;return{top:I,left:H}}}else{o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}o.offset.initialized||o.offset.initialize();var J=this[0],G=J.offsetParent,F=J,O=J.ownerDocument,M,H=O.documentElement,K=O.body,L=O.defaultView,E=L.getComputedStyle(J,null),N=J.offsetTop,I=J.offsetLeft;while((J=J.parentNode)&&J!==K&&J!==H){M=L.getComputedStyle(J,null);N-=J.scrollTop,I-=J.scrollLeft;if(J===G){N+=J.offsetTop,I+=J.offsetLeft;if(o.offset.doesNotAddBorder&&!(o.offset.doesAddBorderForTableAndCells&&/^t(able|d|h)$/i.test(J.tagName))){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}F=G,G=J.offsetParent}if(o.offset.subtractsBorderForOverflowNotVisible&&M.overflow!=="visible"){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}E=M}if(E.position==="relative"||E.position==="static"){N+=K.offsetTop,I+=K.offsetLeft}if(E.position==="fixed"){N+=Math.max(H.scrollTop,K.scrollTop),I+=Math.max(H.scrollLeft,K.scrollLeft)}return{top:N,left:I}}}o.offset={initialize:function(){if(this.initialized){return}var L=document.body,F=document.createElement("div"),H,G,N,I,M,E,J=L.style.marginTop,K='<div style="position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;"><div></div></div><table style="position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;" cellpadding="0" cellspacing="0"><tr><td></td></tr></table>';M={position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",height:"1px",visibility:"hidden"};for(E in M){F.style[E]=M[E]}F.innerHTML=K;L.insertBefore(F,L.firstChild);H=F.firstChild,G=H.firstChild,I=H.nextSibling.firstChild.firstChild;this.doesNotAddBorder=(G.offsetTop!==5);this.doesAddBorderForTableAndCells=(I.offsetTop===5);H.style.overflow="hidden",H.style.position="relative";this.subtractsBorderForOverflowNotVisible=(G.offsetTop===-5);L.style.marginTop="1px";this.doesNotIncludeMarginInBodyOffset=(L.offsetTop===0);L.style.marginTop=J;L.removeChild(F);this.initialized=true},bodyOffset:function(E){o.offset.initialized||o.offset.initialize();var G=E.offsetTop,F=E.offsetLeft;if(o.offset.doesNotIncludeMarginInBodyOffset){G+=parseInt(o.curCSS(E,"marginTop",true),10)||0,F+=parseInt(o.curCSS(E,"marginLeft",true),10)||0}return{top:G,left:F}}};o.fn.extend({position:function(){var I=0,H=0,F;if(this[0]){var G=this.offsetParent(),J=this.offset(),E=/^body|html$/i.test(G[0].tagName)?{top:0,left:0}:G.offset();J.top-=j(this,"marginTop");J.left-=j(this,"marginLeft");E.top+=j(G,"borderTopWidth");E.left+=j(G,"borderLeftWidth");F={top:J.top-E.top,left:J.left-E.left}}return F},offsetParent:function(){var E=this[0].offsetParent||document.body;while(E&&(!/^body|html$/i.test(E.tagName)&&o.css(E,"position")=="static")){E=E.offsetParent}return o(E)}});o.each(["Left","Top"],function(F,E){var G="scroll"+E;o.fn[G]=function(H){if(!this[0]){return null}return H!==g?this.each(function(){this==l||this==document?l.scrollTo(!F?H:o(l).scrollLeft(),F?H:o(l).scrollTop()):this[G]=H}):this[0]==l||this[0]==document?self[F?"pageYOffset":"pageXOffset"]||o.boxModel&&document.documentElement[G]||document.body[G]:this[0][G]}});o.each(["Height","Width"],function(I,G){var E=I?"Left":"Top",H=I?"Right":"Bottom",F=G.toLowerCase();o.fn["inner"+G]=function(){return this[0]?o.css(this[0],F,false,"padding"):null};o.fn["outer"+G]=function(K){return this[0]?o.css(this[0],F,false,K?"margin":"border"):null};var J=G.toLowerCase();o.fn[J]=function(K){return this[0]==l?document.compatMode=="CSS1Compat"&&document.documentElement["client"+G]||document.body["client"+G]:this[0]==document?Math.max(document.documentElement["client"+G],document.body["scroll"+G],document.documentElement["scroll"+G],document.body["offset"+G],document.documentElement["offset"+G]):K===g?(this.length?o.css(this[0],J):null):this.css(J,typeof K==="string"?K:K+"px")}})})();

/* _script/jquery.hoverIntent.min */

/**
* hoverIntent r5 // 2007.03.27 // jQuery 1.1.2+
* <http://cherne.net/brian/resources/jquery.hoverIntent.html>
* 
* @param  f  onMouseOver function || An object with configuration options
* @param  g  onMouseOut function  || Nothing (use configuration options object)
* @author    Brian Cherne <brian@cherne.net>
*/
(function($){$.fn.hoverIntent=function(f,g){var cfg={sensitivity:7,interval:100,timeout:0};cfg=$.extend(cfg,g?{over:f,out:g}:f);var cX,cY,pX,pY;var track=function(ev){cX=ev.pageX;cY=ev.pageY;};var compare=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);if((Math.abs(pX-cX)+Math.abs(pY-cY))<cfg.sensitivity){$(ob).unbind("mousemove",track);ob.hoverIntent_s=1;return cfg.over.apply(ob,[ev]);}else{pX=cX;pY=cY;ob.hoverIntent_t=setTimeout(function(){compare(ev,ob);},cfg.interval);}};var delay=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);ob.hoverIntent_s=0;return cfg.out.apply(ob,[ev]);};var handleHover=function(e){var p=(e.type=="mouseover"?e.fromElement:e.toElement)||e.relatedTarget;while(p&&p!=this){try{p=p.parentNode;}catch(e){p=this;}}if(p==this){return false;}var ev=jQuery.extend({},e);var ob=this;if(ob.hoverIntent_t){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);}if(e.type=="mouseover"){pX=ev.pageX;pY=ev.pageY;$(ob).bind("mousemove",track);if(ob.hoverIntent_s!=1){ob.hoverIntent_t=setTimeout(function(){compare(ev,ob);},cfg.interval);}}else{$(ob).unbind("mousemove",track);if(ob.hoverIntent_s==1){ob.hoverIntent_t=setTimeout(function(){delay(ev,ob);},cfg.timeout);}}};return this.mouseover(handleHover).mouseout(handleHover);};})(jQuery);

/* _script/wymeditor/wymeditor/jquery.wymeditor */

/**
 * @version 0.5-rc1
 *
 * WYMeditor : what you see is What You Mean web-based editor
 * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/
 * Dual licensed under the MIT (MIT-license.txt)
 * and GPL (GPL-license.txt) licenses.
 *
 * For further information visit:
 *        http://www.wymeditor.org/
 *
 * File: jquery.wymeditor.js
 *
 *        Main JS file with core classes and functions.
 *        See the documentation for more info.
 *
 * About: authors
 *
 *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)
 *        Volker Mische (vmx a-t gmx dotde)
 *        Scott Lewis (lewiscot a-t gmail dotcom)
 *        Bermi Ferrer (wymeditor a-t bermi dotorg)
 *        Daniel Reszka (d.reszka a-t wymeditor dotorg)
 *        Jonatan Lundin (jonatan.lundin a-t gmail dotcom)
 */

/*
   Namespace: WYMeditor
   Global WYMeditor namespace.
*/
if(!WYMeditor) var WYMeditor = {};

(function() {
    if ( !window.console || !console.firebug ) {
        var names = ["log", "debug", "info", "warn", "error", "assert", "dir", "dirxml",
        "group", "groupEnd", "time", "timeEnd", "count", "trace", "profile", "profileEnd"];

        WYMeditor.console = {};
        for (var i = 0; i < names.length; ++i)
            WYMeditor.console[names[i]] = function() {}

    } else WYMeditor.console = window.console;
})();

jQuery.extend(WYMeditor, {

/*
    Constants: Global WYMeditor constants.

    VERSION             - Defines WYMeditor version.
    INSTANCES           - An array of loaded WYMeditor.editor instances.
    STRINGS             - An array of loaded WYMeditor language pairs/values.
    SKINS               - An array of loaded WYMeditor skins.
    NAME                - The "name" attribute.
    INDEX               - A string replaced by the instance index.
    WYM_INDEX           - A string used to get/set the instance index.
    BASE_PATH           - A string replaced by WYMeditor's base path.
    SKIN_PATH           - A string replaced by WYMeditor's skin path.
    WYM_PATH            - A string replaced by WYMeditor's main JS file path.
    SKINS_DEFAULT_PATH  - The skins default base path.
    SKINS_DEFAULT_CSS   - The skins default CSS file.
    LANG_DEFAULT_PATH   - The language files default path.
    IFRAME_BASE_PATH    - A string replaced by the designmode iframe's base path.
    IFRAME_DEFAULT      - The iframe's default base path.
    JQUERY_PATH         - A string replaced by the computed jQuery path.
    DIRECTION           - A string replaced by the text direction (rtl or ltr).
    LOGO                - A string replaced by WYMeditor logo.
    TOOLS               - A string replaced by the toolbar's HTML.
    TOOLS_ITEMS         - A string replaced by the toolbar items.
    TOOL_NAME           - A string replaced by a toolbar item's name.
    TOOL_TITLE          - A string replaced by a toolbar item's title.
    TOOL_CLASS          - A string replaced by a toolbar item's class.
    CLASSES             - A string replaced by the classes panel's HTML.
    CLASSES_ITEMS       - A string replaced by the classes items.
    CLASS_NAME          - A string replaced by a class item's name.
    CLASS_TITLE         - A string replaced by a class item's title.
    CONTAINERS          - A string replaced by the containers panel's HTML.
    CONTAINERS_ITEMS    - A string replaced by the containers items.
    CONTAINER_NAME      - A string replaced by a container item's name.
    CONTAINER_TITLE     - A string replaced by a container item's title.
    CONTAINER_CLASS     - A string replaced by a container item's class.
    HTML                - A string replaced by the HTML view panel's HTML.
    IFRAME              - A string replaced by the designmode iframe.
    STATUS              - A string replaced by the status panel's HTML.
    DIALOG_TITLE        - A string replaced by a dialog's title.
    DIALOG_BODY         - A string replaced by a dialog's HTML body.
    BODY                - The BODY element.
    STRING              - The "string" type.
    BODY,DIV,P,
    H1,H2,H3,H4,H5,H6,
    PRE,BLOCKQUOTE,
    A,BR,IMG,
    TABLE,TD,TH,
    UL,OL,LI            - HTML elements string representation.
    CLASS,HREF,SRC,
    TITLE,ALT           - HTML attributes string representation.
    DIALOG_LINK         - A link dialog type.
    DIALOG_IMAGE        - An image dialog type.
    DIALOG_TABLE        - A table dialog type.
    DIALOG_PASTE        - A 'Paste from Word' dialog type.
    BOLD                - Command: (un)set selection to <strong>.
    ITALIC              - Command: (un)set selection to <em>.
    CREATE_LINK         - Command: open the link dialog or (un)set link.
    INSERT_IMAGE        - Command: open the image dialog or insert an image.
    INSERT_TABLE        - Command: open the table dialog.
    PASTE               - Command: open the paste dialog.
    INDENT              - Command: nest a list item.
    OUTDENT             - Command: unnest a list item.
    TOGGLE_HTML         - Command: display/hide the HTML view.
    FORMAT_BLOCK        - Command: set a block element to another type.
    PREVIEW             - Command: open the preview dialog.
    UNLINK              - Command: unset a link.
    INSERT_UNORDEREDLIST- Command: insert an unordered list.
    INSERT_ORDEREDLIST  - Command: insert an ordered list.
    MAIN_CONTAINERS     - An array of the main HTML containers used in WYMeditor.
    BLOCKS              - An array of the HTML block elements.
    KEY                 - Standard key codes.
    NODE                - Node types.

*/

    VERSION             : "0.5-rc1",
    INSTANCES           : [],
    STRINGS             : [],
    SKINS               : [],
    NAME                : "name",
    INDEX               : "{Wym_Index}",
    WYM_INDEX           : "wym_index",
    BASE_PATH           : "{Wym_Base_Path}",
    CSS_PATH            : "{Wym_Css_Path}",
    WYM_PATH            : "{Wym_Wym_Path}",
    SKINS_DEFAULT_PATH  : "skins/",
    SKINS_DEFAULT_CSS   : "skin.css",
    SKINS_DEFAULT_JS    : "skin.js",
    LANG_DEFAULT_PATH   : "lang/",
    IFRAME_BASE_PATH    : "{Wym_Iframe_Base_Path}",
    IFRAME_DEFAULT      : "iframe/default/",
    JQUERY_PATH         : "{Wym_Jquery_Path}",
    DIRECTION           : "{Wym_Direction}",
    LOGO                : "{Wym_Logo}",
    TOOLS               : "{Wym_Tools}",
    TOOLS_ITEMS         : "{Wym_Tools_Items}",
    TOOL_NAME           : "{Wym_Tool_Name}",
    TOOL_TITLE          : "{Wym_Tool_Title}",
    TOOL_CLASS          : "{Wym_Tool_Class}",
    CLASSES             : "{Wym_Classes}",
    CLASSES_ITEMS       : "{Wym_Classes_Items}",
    CLASS_NAME          : "{Wym_Class_Name}",
    CLASS_TITLE         : "{Wym_Class_Title}",
    CONTAINERS          : "{Wym_Containers}",
    CONTAINERS_ITEMS    : "{Wym_Containers_Items}",
    CONTAINER_NAME      : "{Wym_Container_Name}",
    CONTAINER_TITLE     : "{Wym_Containers_Title}",
    CONTAINER_CLASS     : "{Wym_Container_Class}",
    HTML                : "{Wym_Html}",
    IFRAME              : "{Wym_Iframe}",
    STATUS              : "{Wym_Status}",
    DIALOG_TITLE        : "{Wym_Dialog_Title}",
    DIALOG_BODY         : "{Wym_Dialog_Body}",
    STRING              : "string",
    BODY                : "body",
    DIV                 : "div",
    SPAN                : "span",
    P                   : "p",
    H1                  : "h1",
    H2                  : "h2",
    H3                  : "h3",
    H4                  : "h4",
    H5                  : "h5",
    H6                  : "h6",
    PRE                 : "pre",
    BLOCKQUOTE          : "blockquote",
    A                   : "a",
    BR                  : "br",
    IMG                 : "img",
    TABLE               : "table",
    TD                  : "td",
    TH                  : "th",
    UL                  : "ul",
    OL                  : "ol",
    LI                  : "li",
    CLASS               : "class",
    HREF                : "href",
    SRC                 : "src",
    TITLE               : "title",
    ALT                 : "alt",
    DIALOG_LINK         : "Link",
    DIALOG_IMAGE        : "Image",
    DIALOG_TABLE        : "Table",
    DIALOG_PASTE        : "Paste_From_Word",
    BOLD                : "Bold",
    ITALIC              : "Italic",
    CREATE_LINK         : "CreateLink",
    INSERT_IMAGE        : "InsertImage",
    INSERT_TABLE        : "InsertTable",
    INSERT_HTML         : "InsertHTML",
    PASTE               : "Paste",
    INDENT              : "Indent",
    OUTDENT             : "Outdent",
    TOGGLE_HTML         : "ToggleHtml",
    FORMAT_BLOCK        : "FormatBlock",
    PREVIEW             : "Preview",
    UNLINK		: "Unlink",
    INSERT_UNORDEREDLIST: "InsertUnorderedList",
    INSERT_ORDEREDLIST	: "InsertOrderedList",

    MAIN_CONTAINERS : new Array("p","h1","h2","h3","h4","h5","h6","pre","blockquote"),

    BLOCKS : new Array("address", "blockquote", "div", "dl",
	   "fieldset", "form", "h1", "h2", "h3", "h4", "h5", "h6", "hr",
	   "noscript", "ol", "p", "pre", "table", "ul", "dd", "dt",
	   "li", "tbody", "td", "tfoot", "th", "thead", "tr"),

    KEY : {
      BACKSPACE: 8,
      ENTER: 13,
      END: 35,
      HOME: 36,
      LEFT: 37,
      UP: 38,
      RIGHT: 39,
      DOWN: 40,
      CURSOR: new Array(37, 38, 39, 40),
      DELETE: 46
    },

    NODE : {
      ELEMENT: 1,
      ATTRIBUTE: 2,
      TEXT: 3
    },
	
    /*
        Class: WYMeditor.editor
        WYMeditor editor main class, instanciated for each editor occurrence.
    */

	editor : function(elem, options) {

        /*
            Constructor: WYMeditor.editor

            Initializes main values (index, elements, paths, ...)
            and call WYMeditor.editor.init which initializes the editor.

            Parameters:

                elem - The HTML element to be replaced by the editor.
                options - The hash of options.

            Returns:

                Nothing.

            See Also:

                <WYMeditor.editor.init>
        */

        //store the instance in the INSTANCES array and store the index
        this._index = WYMeditor.INSTANCES.push(this) - 1;
        //store the element replaced by the editor
        this._element = elem;
        //store the options
        this._options = options;
        //store the element's inner value
        this._html = jQuery(elem).val();

        //store the HTML option, if any
        if(this._options.html) this._html = this._options.html;
        //get or compute the base path (where the main JS file is located)
        this._options.basePath = this._options.basePath
        || this.computeBasePath();
        //get or set the skin path (where the skin files are located)
        this._options.skinPath = this._options.skinPath
        || this._options.basePath + WYMeditor.SKINS_DEFAULT_PATH
           + this._options.skin + '/';
        //get or compute the main JS file location
        this._options.wymPath = this._options.wymPath
        || this.computeWymPath();
        //get or set the language files path
        this._options.langPath = this._options.langPath
        || this._options.basePath + WYMeditor.LANG_DEFAULT_PATH;
        //get or set the designmode iframe's base path
        this._options.iframeBasePath = this._options.iframeBasePath
        || this._options.basePath + WYMeditor.IFRAME_DEFAULT;
        //get or compute the jQuery JS file location
        this._options.jQueryPath = this._options.jQueryPath
        || this.computeJqueryPath();

        //initialize the editor instance
        this.init();
	
	}

});


/********** JQUERY **********/

/**
 * Replace an HTML element by WYMeditor
 *
 * @example jQuery(".wymeditor").wymeditor(
 *        {
 *
 *        }
 *      );
 * @desc Example description here
 * 
 * @name WYMeditor
 * @description WYMeditor is a web-based WYSIWYM XHTML editor
 * @param Hash hash A hash of parameters
 * @option Integer iExample Description here
 * @option String sExample Description here
 *
 * @type jQuery
 * @cat Plugins/WYMeditor
 * @author Jean-Francois Hovinne
 */
jQuery.fn.wymeditor = function(options) {

  options = jQuery.extend({

    html:       "",
    
    basePath:   false,
    
    skinPath:    false,
    
    wymPath:    false,
    
    iframeBasePath: false,
    
    jQueryPath: false,
    
    styles: false,
    
    stylesheet: false,
    
    skin:       "default",
    initSkin:   true,
    loadSkin:   true,

    lang:       "en",

    direction:  "ltr",

    boxHtml:   "<div class='wym_box'>"
              + "<div class='wym_area_top'>" 
              + WYMeditor.TOOLS
              + "</div>"
              + "<div class='wym_area_left'></div>"
              + "<div class='wym_area_right'>"
              + WYMeditor.CONTAINERS
              + WYMeditor.CLASSES
              + "</div>"
              + "<div class='wym_area_main'>"
              + WYMeditor.HTML
              + WYMeditor.IFRAME
              + WYMeditor.STATUS
              + "</div>"
              + "<div class='wym_area_bottom'>"
              + WYMeditor.LOGO
              + "</div>"
              + "</div>",

    logoHtml:  "<a class='wym_wymeditor_link' "
              + "href='http://www.wymeditor.org/'>WYMeditor</a>",

    iframeHtml:"<div class='wym_iframe wym_section'>"
              + "<iframe "
              + "src='"
              + WYMeditor.IFRAME_BASE_PATH
              + "wymiframe.html' "
              + "onload='this.contentWindow.parent.WYMeditor.INSTANCES["
              + WYMeditor.INDEX + "].initIframe(this)'"
              + "></iframe>"
              + "</div>",
              
    editorStyles: [],

    toolsHtml: "<div class='wym_tools wym_section'>"
              + "<h2>{Tools}</h2>"
              + "<ul>"
              + WYMeditor.TOOLS_ITEMS
              + "</ul>"
              + "</div>",
              
    toolsItemHtml:   "<li class='"
                        + WYMeditor.TOOL_CLASS
                        + "'><a href='#' name='"
                        + WYMeditor.TOOL_NAME
                        + "' title='"
                        + WYMeditor.TOOL_TITLE
                        + "'>"
                        + WYMeditor.TOOL_TITLE
                        + "</a></li>",

    toolsItems: [
        {'name': 'Bold', 'title': 'Strong', 'css': 'wym_tools_strong'}, 
        {'name': 'Italic', 'title': 'Emphasis', 'css': 'wym_tools_emphasis'},
        {'name': 'Superscript', 'title': 'Superscript',
            'css': 'wym_tools_superscript'},
        {'name': 'Subscript', 'title': 'Subscript',
            'css': 'wym_tools_subscript'},
        {'name': 'InsertOrderedList', 'title': 'Ordered_List',
            'css': 'wym_tools_ordered_list'},
        {'name': 'InsertUnorderedList', 'title': 'Unordered_List',
            'css': 'wym_tools_unordered_list'},
        {'name': 'Indent', 'title': 'Indent', 'css': 'wym_tools_indent'},
        {'name': 'Outdent', 'title': 'Outdent', 'css': 'wym_tools_outdent'},
        {'name': 'Undo', 'title': 'Undo', 'css': 'wym_tools_undo'},
        {'name': 'Redo', 'title': 'Redo', 'css': 'wym_tools_redo'},
        {'name': 'CreateLink', 'title': 'Link', 'css': 'wym_tools_link'},
        {'name': 'Unlink', 'title': 'Unlink', 'css': 'wym_tools_unlink'},
        {'name': 'InsertImage', 'title': 'Image', 'css': 'wym_tools_image'},
        {'name': 'InsertTable', 'title': 'Table', 'css': 'wym_tools_table'},
        {'name': 'Paste', 'title': 'Paste_From_Word',
            'css': 'wym_tools_paste'},
        {'name': 'ToggleHtml', 'title': 'HTML', 'css': 'wym_tools_html'},
        {'name': 'Preview', 'title': 'Preview', 'css': 'wym_tools_preview'}
    ],

    containersHtml:    "<div class='wym_containers wym_section'>"
                        + "<h2>{Containers}</h2>"
                        + "<ul>"
                        + WYMeditor.CONTAINERS_ITEMS
                        + "</ul>"
                        + "</div>",
                        
    containersItemHtml:"<li class='"
                        + WYMeditor.CONTAINER_CLASS
                        + "'>"
                        + "<a href='#' name='"
                        + WYMeditor.CONTAINER_NAME
                        + "'>"
                        + WYMeditor.CONTAINER_TITLE
                        + "</a></li>",
                        
    containersItems: [
        {'name': 'P', 'title': 'Paragraph', 'css': 'wym_containers_p'},
        {'name': 'H1', 'title': 'Heading_1', 'css': 'wym_containers_h1'},
        {'name': 'H2', 'title': 'Heading_2', 'css': 'wym_containers_h2'},
        {'name': 'H3', 'title': 'Heading_3', 'css': 'wym_containers_h3'},
        {'name': 'H4', 'title': 'Heading_4', 'css': 'wym_containers_h4'},
        {'name': 'H5', 'title': 'Heading_5', 'css': 'wym_containers_h5'},
        {'name': 'H6', 'title': 'Heading_6', 'css': 'wym_containers_h6'},
        {'name': 'PRE', 'title': 'Preformatted', 'css': 'wym_containers_pre'},
        {'name': 'BLOCKQUOTE', 'title': 'Blockquote',
            'css': 'wym_containers_blockquote'},
        {'name': 'TH', 'title': 'Table_Header', 'css': 'wym_containers_th'}
    ],

    classesHtml:       "<div class='wym_classes wym_section'>"
                        + "<h2>{Classes}</h2><ul>"
                        + WYMeditor.CLASSES_ITEMS
                        + "</ul></div>",

    classesItemHtml:   "<li class='wym_classes_"
                        + WYMeditor.CLASS_NAME
                        + "'><a href='#' name='"
                        + WYMeditor.CLASS_NAME
                        + "'>"
                        + WYMeditor.CLASS_TITLE
                        + "</a></li>",

    classesItems:      [],

    statusHtml:        "<div class='wym_status wym_section'>"
                        + "<h2>{Status}</h2>"
                        + "</div>",

    htmlHtml:          "<div class='wym_html wym_section'>"
                        + "<h2>{Source_Code}</h2>"
                        + "<textarea class='wym_html_val'></textarea>"
                        + "</div>",

    boxSelector:       ".wym_box",
    toolsSelector:     ".wym_tools",
    toolsListSelector: " ul",
    containersSelector:".wym_containers",
    classesSelector:   ".wym_classes",
    htmlSelector:      ".wym_html",
    iframeSelector:    ".wym_iframe iframe",
    iframeBodySelector:".wym_iframe",
    statusSelector:    ".wym_status",
    toolSelector:      ".wym_tools a",
    containerSelector: ".wym_containers a",
    classSelector:     ".wym_classes a",
    htmlValSelector:   ".wym_html_val",
    
    hrefSelector:      ".wym_href",
    srcSelector:       ".wym_src",
    titleSelector:     ".wym_title",
    altSelector:       ".wym_alt",
    textSelector:      ".wym_text",
    
    rowsSelector:      ".wym_rows",
    colsSelector:      ".wym_cols",
    captionSelector:   ".wym_caption",
    summarySelector:   ".wym_summary",
    
    submitSelector:    ".wym_submit",
    cancelSelector:    ".wym_cancel",
    previewSelector:   "",
    
    dialogTypeSelector:    ".wym_dialog_type",
    dialogLinkSelector:    ".wym_dialog_link",
    dialogImageSelector:   ".wym_dialog_image",
    dialogTableSelector:   ".wym_dialog_table",
    dialogPasteSelector:   ".wym_dialog_paste",
    dialogPreviewSelector: ".wym_dialog_preview",
    
    updateSelector:    ".wymupdate",
    updateEvent:       "click",
    
    dialogFeatures:    "menubar=no,titlebar=no,toolbar=no,resizable=no"
                      + ",width=560,height=300,top=0,left=0",
    dialogFeaturesPreview: "menubar=no,titlebar=no,toolbar=no,resizable=no"
                      + ",scrollbars=yes,width=560,height=300,top=0,left=0",

    dialogHtml:      "<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'"
                      + " 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>"
                      + "<html dir='"
                      + WYMeditor.DIRECTION
                      + "'><head>"
                      + "<link rel='stylesheet' type='text/css'   media='screen'"
                      + " href='"
                      + WYMeditor.CSS_PATH
                      + "' />"
                      + "<title>"
                      + WYMeditor.DIALOG_TITLE
                      + "</title>"
                      + "<script type='text/javascript'"
                      + " src='"
                      + WYMeditor.JQUERY_PATH
                      + "'></script>"
                      + "<script type='text/javascript'"
                      + " src='"
                      + WYMeditor.WYM_PATH
                      + "'></script>"
                      + "</head>"
                      + WYMeditor.DIALOG_BODY
                      + "</html>",
                      
    dialogLinkHtml:  "<body class='wym_dialog wym_dialog_link'"
               + " onload='WYMeditor.INIT_DIALOG(" + WYMeditor.INDEX + ")'"
               + ">"
               + "<form>"
               + "<fieldset>"
               + "<input type='hidden' class='wym_dialog_type' value='"
               + WYMeditor.DIALOG_LINK
               + "' />"
               + "<legend>{Link}</legend>"
               + "<div class='row'>"
               + "<label>{URL}</label>"
               + "<input type='text' class='wym_href' value='' size='40' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Title}</label>"
               + "<input type='text' class='wym_title' value='' size='40' />"
               + "</div>"
               + "<div class='row row-indent'>"
               + "<input class='wym_submit' type='button'"
               + " value='{Submit}' />"
               + "<input class='wym_cancel' type='button'"
               + "value='{Cancel}' />"
               + "</div>"
               + "</fieldset>"
               + "</form>"
               + "</body>",
    
    dialogImageHtml:  "<body class='wym_dialog wym_dialog_image'"
               + " onload='WYMeditor.INIT_DIALOG(" + WYMeditor.INDEX + ")'"
               + ">"
               + "<form>"
               + "<fieldset>"
               + "<input type='hidden' class='wym_dialog_type' value='"
               + WYMeditor.DIALOG_IMAGE
               + "' />"
               + "<legend>{Image}</legend>"
               + "<div class='row'>"
               + "<label>{URL}</label>"
               + "<input type='text' class='wym_src' value='' size='40' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Alternative_Text}</label>"
               + "<input type='text' class='wym_alt' value='' size='40' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Title}</label>"
               + "<input type='text' class='wym_title' value='' size='40' />"
               + "</div>"
               + "<div class='row row-indent'>"
               + "<input class='wym_submit' type='button'"
               + " value='{Submit}' />"
               + "<input class='wym_cancel' type='button'"
               + "value='{Cancel}' />"
               + "</div>"
               + "</fieldset>"
               + "</form>"
               + "</body>",
    
    dialogTableHtml:  "<body class='wym_dialog wym_dialog_table'"
               + " onload='WYMeditor.INIT_DIALOG(" + WYMeditor.INDEX + ")'"
               + ">"
               + "<form>"
               + "<fieldset>"
               + "<input type='hidden' class='wym_dialog_type' value='"
               + WYMeditor.DIALOG_TABLE
               + "' />"
               + "<legend>{Table}</legend>"
               + "<div class='row'>"
               + "<label>{Caption}</label>"
               + "<input type='text' class='wym_caption' value='' size='40' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Summary}</label>"
               + "<input type='text' class='wym_summary' value='' size='40' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Number_Of_Rows}</label>"
               + "<input type='text' class='wym_rows' value='3' size='3' />"
               + "</div>"
               + "<div class='row'>"
               + "<label>{Number_Of_Cols}</label>"
               + "<input type='text' class='wym_cols' value='2' size='3' />"
               + "</div>"
               + "<div class='row row-indent'>"
               + "<input class='wym_submit' type='button'"
               + " value='{Submit}' />"
               + "<input class='wym_cancel' type='button'"
               + "value='{Cancel}' />"
               + "</div>"
               + "</fieldset>"
               + "</form>"
               + "</body>",

    dialogPasteHtml:  "<body class='wym_dialog wym_dialog_paste'"
               + " onload='WYMeditor.INIT_DIALOG(" + WYMeditor.INDEX + ")'"
               + ">"
               + "<form>"
               + "<input type='hidden' class='wym_dialog_type' value='"
               + WYMeditor.DIALOG_PASTE
               + "' />"
               + "<fieldset>"
               + "<legend>{Paste_From_Word}</legend>"
               + "<div class='row'>"
               + "<textarea class='wym_text' rows='10' cols='50'></textarea>"
               + "</div>"
               + "<div class='row'>"
               + "<input class='wym_submit' type='button'"
               + " value='{Submit}' />"
               + "<input class='wym_cancel' type='button'"
               + "value='{Cancel}' />"
               + "</div>"
               + "</fieldset>"
               + "</form>"
               + "</body>",

    dialogPreviewHtml: "<body class='wym_dialog wym_dialog_preview'"
                      + " onload='WYMeditor.INIT_DIALOG(" + WYMeditor.INDEX + ")'"
                      + "></body>",
                      
    dialogStyles: [],

    stringDelimiterLeft: "{",
    stringDelimiterRight:"}",
    
    preInit: null,
    preBind: null,
    postInit: null,
    
    preInitDialog: null,
    postInitDialog: null

  }, options);

  return this.each(function() {

    new WYMeditor.editor(jQuery(this),options);
  });
};

/* @name extend
 * @description Returns the WYMeditor instance based on its index
 */
jQuery.extend({
  wymeditors: function(i) {
    return (WYMeditor.INSTANCES[i]);
  }
});


/********** WYMeditor **********/

/* @name Wymeditor
 * @description WYMeditor class
 */

/* @name init
 * @description Initializes a WYMeditor instance
 */
WYMeditor.editor.prototype.init = function() {

  //load subclass - browser specific
  //unsupported browsers: do nothing
  if (jQuery.browser.msie) {
    var WymClass = new WYMeditor.WymClassExplorer(this);
  }
  else if (jQuery.browser.mozilla) {
    var WymClass = new WYMeditor.WymClassMozilla(this);
  }
  else if (jQuery.browser.opera) {
    var WymClass = new WYMeditor.WymClassOpera(this);
  }
  else if (jQuery.browser.safari) {
    var WymClass = new WYMeditor.WymClassSafari(this);
  }
  
  if(WymClass) {
  
      if(jQuery.isFunction(this._options.preInit)) this._options.preInit(this);

      var SaxListener = new WYMeditor.XhtmlSaxListener();
      jQuery.extend(SaxListener, WymClass);
      this.parser = new WYMeditor.XhtmlParser(SaxListener);
      
      if(this._options.styles || this._options.stylesheet){
        this.configureEditorUsingRawCss();
      }
      
      this.helper = new WYMeditor.XmlHelper();
      
      //extend the Wymeditor object
      //don't use jQuery.extend since 1.1.4
      //jQuery.extend(this, WymClass);
      for (var prop in WymClass) { this[prop] = WymClass[prop]; }

      //load wymbox
      this._box = jQuery(this._element).hide().after(this._options.boxHtml).next().addClass('wym_box_' + this._index);

      //store the instance index in wymbox and element replaced by editor instance
      //but keep it compatible with jQuery < 1.2.3, see #122
      if( jQuery.isFunction( jQuery.fn.data ) ) {
        jQuery.data(this._box.get(0), WYMeditor.WYM_INDEX, this._index);
        jQuery.data(this._element.get(0), WYMeditor.WYM_INDEX, this._index);
      }
      
      var h = WYMeditor.Helper;

      //construct the iframe
      var iframeHtml = this._options.iframeHtml;
      iframeHtml = h.replaceAll(iframeHtml, WYMeditor.INDEX, this._index);
      iframeHtml = h.replaceAll(iframeHtml, WYMeditor.IFRAME_BASE_PATH, this._options.iframeBasePath);
      
      //construct wymbox
      var boxHtml = jQuery(this._box).html();
      
      boxHtml = h.replaceAll(boxHtml, WYMeditor.LOGO, this._options.logoHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.TOOLS, this._options.toolsHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.CONTAINERS,this._options.containersHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.CLASSES, this._options.classesHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.HTML, this._options.htmlHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.IFRAME, iframeHtml);
      boxHtml = h.replaceAll(boxHtml, WYMeditor.STATUS, this._options.statusHtml);
      
      //construct tools list
      var aTools = eval(this._options.toolsItems);
      var sTools = "";

      for(var i = 0; i < aTools.length; i++) {
        var oTool = aTools[i];
        if(oTool.name && oTool.title)
          var sTool = this._options.toolsItemHtml;
          var sTool = h.replaceAll(sTool, WYMeditor.TOOL_NAME, oTool.name);
          sTool = h.replaceAll(sTool, WYMeditor.TOOL_TITLE, this._options.stringDelimiterLeft
            + oTool.title
            + this._options.stringDelimiterRight);
          sTool = h.replaceAll(sTool, WYMeditor.TOOL_CLASS, oTool.css);
          sTools += sTool;
      }

      boxHtml = h.replaceAll(boxHtml, WYMeditor.TOOLS_ITEMS, sTools);

      //construct classes list
      var aClasses = eval(this._options.classesItems);
      var sClasses = "";

      for(var i = 0; i < aClasses.length; i++) {
        var oClass = aClasses[i];
        if(oClass.name && oClass.title)
          var sClass = this._options.classesItemHtml;
          sClass = h.replaceAll(sClass, WYMeditor.CLASS_NAME, oClass.name);
          sClass = h.replaceAll(sClass, WYMeditor.CLASS_TITLE, oClass.title);
          sClasses += sClass;
      }

      boxHtml = h.replaceAll(boxHtml, WYMeditor.CLASSES_ITEMS, sClasses);
      
      //construct containers list
      var aContainers = eval(this._options.containersItems);
      var sContainers = "";

      for(var i = 0; i < aContainers.length; i++) {
        var oContainer = aContainers[i];
        if(oContainer.name && oContainer.title)
          var sContainer = this._options.containersItemHtml;
          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_NAME, oContainer.name);
          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_TITLE,
              this._options.stringDelimiterLeft
            + oContainer.title
            + this._options.stringDelimiterRight);
          sContainer = h.replaceAll(sContainer, WYMeditor.CONTAINER_CLASS, oContainer.css);
          sContainers += sContainer;
      }

      boxHtml = h.replaceAll(boxHtml, WYMeditor.CONTAINERS_ITEMS, sContainers);

      //l10n
      boxHtml = this.replaceStrings(boxHtml);
      
      //load html in wymbox
      jQuery(this._box).html(boxHtml);
      
      //hide the html value
      jQuery(this._box).find(this._options.htmlSelector).hide();
      
      //enable the skin
      this.loadSkin();
      
    }
};

WYMeditor.editor.prototype.toggleClassByName = function(sName) {
    var aClasses = eval(this._options.classesItems);
    var oClass = WYMeditor.Helper.findByName(aClasses, sName);
		//alert(oClass);
    if(oClass) {
      var jqexpr = oClass.expr; // the path to the element
      this.toggleClass(sName, jqexpr);
    } else {
			alert("Class "+sName+" not found");
		}
    this._iframe.contentWindow.focus(); //See #154
}

WYMeditor.editor.prototype.bindEvents = function() {

  //copy the instance
  var wym = this;
  
  //handle click event on tools buttons
  jQuery(this._box).find(this._options.toolSelector).click(function() {
    wym._iframe.contentWindow.focus(); //See #154
    wym.exec(jQuery(this).attr(WYMeditor.NAME));    
    return(false);
  });
  
  //handle click event on containers buttons
  jQuery(this._box).find(this._options.containerSelector).click(function() {
    wym.container(jQuery(this).attr(WYMeditor.NAME));
    return(false);
  });
  
  //handle keyup event on html value: set the editor value
  //handle focus/blur events to check if the element has focus, see #147
  jQuery(this._box).find(this._options.htmlValSelector)
    .keyup(function() { jQuery(wym._doc.body).html(jQuery(this).val());})
    .focus(function() { jQuery(this).toggleClass('hasfocus'); })
    .blur(function() { jQuery(this).toggleClass('hasfocus'); });

  //handle click event on classes buttons
  jQuery(this._box).find(this._options.classSelector).click(function() {
    var sName = jQuery(this).attr(WYMeditor.NAME);  // The name of the class
    wym.toggleClassByName(sName);
    return(false);
  });
  
  //handle event on update element
  jQuery(this._options.updateSelector)
    .bind(this._options.updateEvent, function() {
      wym.update();
  });
};

WYMeditor.editor.prototype.ready = function() {
  return(this._doc != null);
};


/********** METHODS **********/

/* @name box
 * @description Returns the WYMeditor container
 */
WYMeditor.editor.prototype.box = function() {
  return(this._box);
};

/* @name html
 * @description Get/Set the html value
 */
WYMeditor.editor.prototype.html = function(html) {

  if(typeof html === 'string') jQuery(this._doc.body).html(html);
  else return(jQuery(this._doc.body).html());
};

/* @name xhtml
 * @description Cleans up the HTML
 */
WYMeditor.editor.prototype.xhtml = function() {
    return this.parser.parse(this.html());
};

/* @name exec
 * @description Executes a button command
 */
WYMeditor.editor.prototype.exec = function(cmd) {
  
  //base function for execCommand
  //open a dialog or exec
  switch(cmd) {
    case WYMeditor.CREATE_LINK:
      var container = this.container();
      if(container || this._selected_image) this.dialog(WYMeditor.DIALOG_LINK);
    break;
    
    case WYMeditor.INSERT_IMAGE:
      this.dialog(WYMeditor.DIALOG_IMAGE);
    break;
    
    case WYMeditor.INSERT_TABLE:
      this.dialog(WYMeditor.DIALOG_TABLE);
    break;
    
    case WYMeditor.PASTE:
      this.dialog(WYMeditor.DIALOG_PASTE);
    break;
    
    case WYMeditor.TOGGLE_HTML:
      this.update();
      this.toggleHtml();
    break;
    
    case WYMeditor.PREVIEW:
      this.dialog(WYMeditor.PREVIEW, this._options.dialogFeaturesPreview);
    break;
    
    default:
      this._exec(cmd);
    break;
  }
};

/* @name container
 * @description Get/Set the selected container
 */
WYMeditor.editor.prototype.container = function(sType) {

  if(sType) {
  
    var container = null;
    
    if(sType.toLowerCase() == WYMeditor.TH) {
    
      container = this.container();
      
      //find the TD or TH container
      switch(container.tagName.toLowerCase()) {
      
        case WYMeditor.TD: case WYMeditor.TH:
          break;
        default:
          var aTypes = new Array(WYMeditor.TD,WYMeditor.TH);
          container = this.findUp(this.container(), aTypes);
          break;
      }
      
      //if it exists, switch
      if(container!=null) {
      
        sType = (container.tagName.toLowerCase() == WYMeditor.TD)? WYMeditor.TH: WYMeditor.TD;
        this.switchTo(container,sType);
        this.update();
      }
    } else {
  
      //set the container type
      var aTypes=new Array(WYMeditor.P,WYMeditor.H1,WYMeditor.H2,WYMeditor.H3,WYMeditor.H4,WYMeditor.H5,
      WYMeditor.H6,WYMeditor.PRE,WYMeditor.BLOCKQUOTE);
      container = this.findUp(this.container(), aTypes);
      
      if(container) {
  
        var newNode = null;
  
        //blockquotes must contain a block level element
        if(sType.toLowerCase() == WYMeditor.BLOCKQUOTE) {
        
          var blockquote = this.findUp(this.container(), WYMeditor.BLOCKQUOTE);
          
          if(blockquote == null) {
          
            newNode = this._doc.createElement(sType);
            container.parentNode.insertBefore(newNode,container);
            newNode.appendChild(container);
            this.setFocusToNode(newNode.firstChild);
            
          } else {
          
            var nodes = blockquote.childNodes;
            var lgt = nodes.length;
            var firstNode = null;
            
            if(lgt > 0) firstNode = nodes.item(0);
            for(var x=0; x<lgt; x++) {
              blockquote.parentNode.insertBefore(nodes.item(0),blockquote);
            }
            blockquote.parentNode.removeChild(blockquote);
            if(firstNode) this.setFocusToNode(firstNode);
          }
        }
        
        else this.switchTo(container,sType);
      
        this.update();
      }
    }
  }
  else return(this.selected());
};

/* @name toggleClass
 * @description Toggles class on selected element, or one of its parents
 */
WYMeditor.editor.prototype.toggleClass = function(sClass, jqexpr) {

  var container = (this._selected_image
                    ? this._selected_image
                    : jQuery(this.selected()));
  container = jQuery(container).parentsOrSelf(jqexpr);
  if (!jQuery(container).text()) {
  	//this._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.SPAN);
  	var selection = this._iframe.contentWindow.getSelection();
		var tag = (jqexpr.indexOf(",")>=0? "span": jqexpr);
  	this._exec(WYMeditor.INSERT_HTML, "<"+tag+" class='"+sClass+"'>"+selection+"</"+tag+">");   
  }
  jQuery(container).toggleClass(sClass);

  if(!jQuery(container).attr(WYMeditor.CLASS)) jQuery(container).removeAttr(this._class);

};

/* @name findUp
 * @description Returns the first parent or self container, based on its type
 */
WYMeditor.editor.prototype.findUp = function(node, filter) {

  //filter is a string or an array of strings

  if(node) {

      var tagname = node.tagName.toLowerCase();
      
      if(typeof(filter) == WYMeditor.STRING) {
    
        while(tagname != filter && tagname != WYMeditor.BODY) {
        
          node = node.parentNode;
          tagname = node.tagName.toLowerCase();
        }
      
      } else {
      
        var bFound = false;
        
        while(!bFound && tagname != WYMeditor.BODY) {
          for(var i = 0; i < filter.length; i++) {
            if(tagname == filter[i]) {
              bFound = true;
              break;
            }
          }
          if(!bFound) {
            node = node.parentNode;
            tagname = node.tagName.toLowerCase();
          }
        }
      }
      
      if(tagname != WYMeditor.BODY) return(node);
      else return(null);
      
  } else return(null);
};

/* @name switchTo
 * @description Switch the node's type
 */
WYMeditor.editor.prototype.switchTo = function(node,sType) {

  var newNode = this._doc.createElement(sType);
  var html = jQuery(node).html();
  node.parentNode.replaceChild(newNode,node);
  jQuery(newNode).html(html);
  this.setFocusToNode(newNode);
};

WYMeditor.editor.prototype.replaceStrings = function(sVal) {
  //check if the language file has already been loaded
  //if not, get it via a synchronous ajax call
  if(!WYMeditor.STRINGS[this._options.lang]) {
    try {
      eval(jQuery.ajax({url:this._options.langPath
        + this._options.lang + '.js', async:false}).responseText);
    } catch(e) {
        WYMeditor.console.error("WYMeditor: error while parsing language file.");
        return sVal;
    }
  }

  //replace all the strings in sVal and return it
  for (var key in WYMeditor.STRINGS[this._options.lang]) {
    sVal = WYMeditor.Helper.replaceAll(sVal, this._options.stringDelimiterLeft + key 
    + this._options.stringDelimiterRight,
    WYMeditor.STRINGS[this._options.lang][key]);
  };
  return(sVal);
};

WYMeditor.editor.prototype.encloseString = function(sVal) {

  return(this._options.stringDelimiterLeft
    + sVal
    + this._options.stringDelimiterRight);
};

/* @name status
 * @description Prints a status message
 */
WYMeditor.editor.prototype.status = function(sMessage) {

  //print status message
  jQuery(this._box).find(this._options.statusSelector).html(sMessage);
};

/* @name update
 * @description Updates the element and textarea values
 */
WYMeditor.editor.prototype.update = function() {

  var html = this.xhtml();
  jQuery(this._element).val(html);
  jQuery(this._box).find(this._options.htmlValSelector).not('.hasfocus').val(html); //#147
};

/* @name dialog
 * @description Opens a dialog box
 */
WYMeditor.editor.prototype.dialog = function( dialogType, dialogFeatures, bodyHtml ) {
  
  var features = dialogFeatures || this._wym._options.dialogFeatures;
  var wDialog = window.open('', 'dialog', features);

  if(wDialog) {

    var sBodyHtml = "";
    
    switch( dialogType ) {

      case(WYMeditor.DIALOG_LINK):
        sBodyHtml = this._options.dialogLinkHtml;
      break;
      case(WYMeditor.DIALOG_IMAGE):
        sBodyHtml = this._options.dialogImageHtml;
      break;
      case(WYMeditor.DIALOG_TABLE):
        sBodyHtml = this._options.dialogTableHtml;
      break;
      case(WYMeditor.DIALOG_PASTE):
        sBodyHtml = this._options.dialogPasteHtml;
      break;
      case(WYMeditor.PREVIEW):
        sBodyHtml = this._options.dialogPreviewHtml;
      break;

      default:
        sBodyHtml = bodyHtml;
    }
    
    var h = WYMeditor.Helper;

    //construct the dialog
    var dialogHtml = this._options.dialogHtml;
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.BASE_PATH, this._options.basePath);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIRECTION, this._options.direction);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.CSS_PATH, this._options.skinPath + WYMeditor.SKINS_DEFAULT_CSS);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.WYM_PATH, this._options.wymPath);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.JQUERY_PATH, this._options.jQueryPath);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIALOG_TITLE, this.encloseString( dialogType ));
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.DIALOG_BODY, sBodyHtml);
    dialogHtml = h.replaceAll(dialogHtml, WYMeditor.INDEX, this._index);
      
    dialogHtml = this.replaceStrings(dialogHtml);
    
    var doc = wDialog.document;
    doc.write(dialogHtml);
    doc.close();
  }
};

/* @name toggleHtml
 * @description Shows/Hides the HTML
 */
WYMeditor.editor.prototype.toggleHtml = function() {
  jQuery(this._box).find(this._options.htmlSelector).toggle();
};

WYMeditor.editor.prototype.uniqueStamp = function() {
	var now = new Date();
	return("wym-" + now.getTime());
};

WYMeditor.editor.prototype.paste = function(sData) {

  var sTmp;
  var container = this.selected();
	
  //split the data, using double newlines as the separator
  var aP = sData.split(this._newLine + this._newLine);
  var rExp = new RegExp(this._newLine, "g");

  //add a P for each item
  if(container && container.tagName.toLowerCase() != WYMeditor.BODY) {
    for(x = aP.length - 1; x >= 0; x--) {
        sTmp = aP[x];
        //simple newlines are replaced by a break
        sTmp = sTmp.replace(rExp, "<br />");
        jQuery(container).after("<p>" + sTmp + "</p>");
    }
  } else {
    for(x = 0; x < aP.length; x++) {
        sTmp = aP[x];
        //simple newlines are replaced by a break
        sTmp = sTmp.replace(rExp, "<br />");
        jQuery(this._doc.body).append("<p>" + sTmp + "</p>");
    }
  
  }
};

WYMeditor.editor.prototype.insert = function(html) {
    // Do we have a selection?
    if (this._iframe.contentWindow.getSelection().focusNode != null) {
        // Overwrite selection with provided html
        this._exec( WYMeditor.INSERT_HTML, html);
    } else {
        // Fall back to the internal paste function if there's no selection
        this.paste(html)
    }
};

WYMeditor.editor.prototype.wrap = function(left, right) {
    // Do we have a selection?
    if (this._iframe.contentWindow.getSelection().focusNode != null) {
        // Wrap selection with provided html
        this._exec( WYMeditor.INSERT_HTML, left + this._iframe.contentWindow.getSelection().toString() + right);
    }
};

WYMeditor.editor.prototype.unwrap = function() {
    // Do we have a selection?
    if (this._iframe.contentWindow.getSelection().focusNode != null) {
        // Unwrap selection
        this._exec( WYMeditor.INSERT_HTML, this._iframe.contentWindow.getSelection().toString() );
    }
};

WYMeditor.editor.prototype.setFocusToNode = function(node, toStart) {
    var range = this._doc.createRange(),
        selection = this._iframe.contentWindow.getSelection();
    toStart = toStart ? 0 : 1;
    
    range.selectNodeContents(node);
    selection.addRange(range);
    selection.collapse(node, toStart);
    this._iframe.contentWindow.focus();
};

WYMeditor.editor.prototype.addCssRules = function(doc, aCss) {
  var styles = doc.styleSheets[0];
  if(styles) {
    for(var i = 0; i < aCss.length; i++) {
      var oCss = aCss[i];
      if(oCss.name && oCss.css) this.addCssRule(styles, oCss);
    }
  }
};

/********** CONFIGURATION **********/

WYMeditor.editor.prototype.computeBasePath = function() {
  return jQuery(jQuery.grep(jQuery('script'), function(s){
    return (s.src && s.src.match(/jquery\.wymeditor(\.pack|\.min|\.packed)?\.js(\?.*)?$/ ))
  })).attr('src').replace(/jquery\.wymeditor(\.pack|\.min|\.packed)?\.js(\?.*)?$/, '');
};

WYMeditor.editor.prototype.computeWymPath = function() {
  return jQuery(jQuery.grep(jQuery('script'), function(s){
    return (s.src && s.src.match(/jquery\.wymeditor(\.pack|\.min|\.packed)?\.js(\?.*)?$/ ))
  })).attr('src');
};

WYMeditor.editor.prototype.computeJqueryPath = function() {
  return jQuery(jQuery.grep(jQuery('script'), function(s){
    return (s.src && s.src.match(/jquery(-(.*)){0,1}(\.pack|\.min|\.packed)?\.js(\?.*)?$/ ))
  })).attr('src');
};

WYMeditor.editor.prototype.computeCssPath = function() {
  return jQuery(jQuery.grep(jQuery('link'), function(s){
   return (s.href && s.href.match(/wymeditor\/skins\/(.*)screen\.css(\?.*)?$/ ))
  })).attr('href');
};

WYMeditor.editor.prototype.configureEditorUsingRawCss = function() {

  var CssParser = new WYMeditor.WymCssParser();
  if(this._options.stylesheet){
    CssParser.parse(jQuery.ajax({url: this._options.stylesheet,async:false}).responseText);
  }else{
    CssParser.parse(this._options.styles, false);
  }

  if(this._options.classesItems.length == 0) {
    this._options.classesItems = CssParser.css_settings.classesItems;
		//alert(this._options.classesItems);
  }
  if(this._options.editorStyles.length == 0) {
    this._options.editorStyles = CssParser.css_settings.editorStyles;
  }
  if(this._options.dialogStyles.length == 0) {
    this._options.dialogStyles = CssParser.css_settings.dialogStyles;
  }
};

/********** EVENTS **********/

WYMeditor.editor.prototype.listen = function() {
    //don't use jQuery.find() on the iframe body
    //because of MSIE + jQuery + expando issue (#JQ1143)
    //jQuery(this._doc.body).find("*").bind("mouseup", this.mouseup);

    jQuery(this._doc.body).bind("mousedown", this.mousedown);
};

WYMeditor.editor.prototype.mousedown = function(evt) {
    var wym = WYMeditor.INSTANCES[this.ownerDocument.title];
    wym._selected_image = (evt.target.tagName.toLowerCase() == WYMeditor.IMG) ? evt.target : null;
};

/********** SKINS **********/

/*
 * Function: WYMeditor.loadCss
 *      Loads a stylesheet in the document.
 *
 * Parameters:
 *      href - The CSS path.
 */
WYMeditor.loadCss = function(href) {
    
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;

    var head = jQuery('head').get(0);
    head.appendChild(link);
};

/*
 *  Function: WYMeditor.editor.loadSkin
 *      Loads the skin CSS and initialization script (if needed).
 */
WYMeditor.editor.prototype.loadSkin = function() {

    //does the user want to automatically load the CSS (default: yes)?
    //we also test if it hasn't been already loaded by another instance
    //see below for a better (second) test
    if(this._options.loadSkin && !WYMeditor.SKINS[this._options.skin]) {

        //check if it hasn't been already loaded
        //so we don't load it more than once
        //(we check the existing <link> elements)

        var found = false;
        var rExp = new RegExp(this._options.skin
             + '\/' + WYMeditor.SKINS_DEFAULT_CSS + '$');

        jQuery('link').each( function() {
            if(this.href.match(rExp)) found = true;
        });

        //load it, using the skin path
        if(!found) WYMeditor.loadCss( this._options.skinPath
            + WYMeditor.SKINS_DEFAULT_CSS );
    }

    //put the classname (ex. wym_skin_default) on wym_box
    jQuery(this._box).addClass( "wym_skin_" + this._options.skin );

    //does the user want to use some JS to initialize the skin (default: yes)?
    //also check if it hasn't already been loaded by another instance
    if(this._options.initSkin && !WYMeditor.SKINS[this._options.skin]) {

        eval(jQuery.ajax({url:this._options.skinPath
            + WYMeditor.SKINS_DEFAULT_JS, async:false}).responseText);
    }

    //init the skin, if needed
    if(WYMeditor.SKINS[this._options.skin]
    && WYMeditor.SKINS[this._options.skin].init)
       WYMeditor.SKINS[this._options.skin].init(this);

};


/********** DIALOGS **********/

WYMeditor.INIT_DIALOG = function(index) {

  var wym = window.opener.WYMeditor.INSTANCES[index];
  var doc = window.document;
  var selected = wym.selected();
  var dialogType = jQuery(wym._options.dialogTypeSelector).val();
  var sStamp = wym.uniqueStamp();

  switch(dialogType) {

  case WYMeditor.DIALOG_LINK:
    //ensure that we select the link to populate the fields
    if(selected && selected.tagName && selected.tagName.toLowerCase != WYMeditor.A)
      selected = jQuery(selected).parentsOrSelf(WYMeditor.A);

    //fix MSIE selection if link image has been clicked
    if(!selected && wym._selected_image)
      selected = jQuery(wym._selected_image).parentsOrSelf(WYMeditor.A);
  break;

  }

  //pre-init functions
  if(jQuery.isFunction(wym._options.preInitDialog))
    wym._options.preInitDialog(wym,window);

  //add css rules from options
  var styles = doc.styleSheets[0];
  var aCss = eval(wym._options.dialogStyles);

  wym.addCssRules(doc, aCss);

  //auto populate fields if selected container (e.g. A)
  if(selected) {
    jQuery(wym._options.hrefSelector).val(jQuery(selected).attr(WYMeditor.HREF));
    jQuery(wym._options.srcSelector).val(jQuery(selected).attr(WYMeditor.SRC));
    jQuery(wym._options.titleSelector).val(jQuery(selected).attr(WYMeditor.TITLE));
    jQuery(wym._options.altSelector).val(jQuery(selected).attr(WYMeditor.ALT));
  }

  //auto populate image fields if selected image
  if(wym._selected_image) {
    jQuery(wym._options.dialogImageSelector + " " + wym._options.srcSelector)
      .val(jQuery(wym._selected_image).attr(WYMeditor.SRC));
    jQuery(wym._options.dialogImageSelector + " " + wym._options.titleSelector)
      .val(jQuery(wym._selected_image).attr(WYMeditor.TITLE));
    jQuery(wym._options.dialogImageSelector + " " + wym._options.altSelector)
      .val(jQuery(wym._selected_image).attr(WYMeditor.ALT));
  }

  jQuery(wym._options.dialogLinkSelector + " "
    + wym._options.submitSelector).click(function() {
      var sUrl = jQuery(wym._options.hrefSelector).val();
      if(sUrl.length > 0) {
        var link;
        
        if (selected[0] && selected[0].tagName.toLowerCase() == WYMeditor.A) {
            link = selected;
        } else {
            wym._exec(WYMeditor.CREATE_LINK, sStamp);
            link = jQuery("a[href=" + sStamp + "]", wym._doc.body);
        }

        link.attr(WYMeditor.HREF, sUrl)
            .attr(WYMeditor.TITLE, jQuery(wym._options.titleSelector).val());

      }
      window.close();
  });

  jQuery(wym._options.dialogImageSelector + " "
    + wym._options.submitSelector).click(function() {

      var sUrl = jQuery(wym._options.srcSelector).val();
      if(sUrl.length > 0) {

        wym._exec(WYMeditor.INSERT_IMAGE, sStamp);

        jQuery("img[src$=" + sStamp + "]", wym._doc.body)
            .attr(WYMeditor.SRC, sUrl)
            .attr(WYMeditor.TITLE, jQuery(wym._options.titleSelector).val())
            .attr(WYMeditor.ALT, jQuery(wym._options.altSelector).val());
      }
      window.close();
  });

  jQuery(wym._options.dialogTableSelector + " "
    + wym._options.submitSelector).click(function() {

      var iRows = jQuery(wym._options.rowsSelector).val();
      var iCols = jQuery(wym._options.colsSelector).val();

      if(iRows > 0 && iCols > 0) {

        var table = wym._doc.createElement(WYMeditor.TABLE);
        var newRow = null;
		var newCol = null;

		var sCaption = jQuery(wym._options.captionSelector).val();

		//we create the caption
		var newCaption = table.createCaption();
		newCaption.innerHTML = sCaption;

		//we create the rows and cells
		for(x=0; x<iRows; x++) {
			newRow = table.insertRow(x);
			for(y=0; y<iCols; y++) {newRow.insertCell(y);}
		}

        //set the summary attr
        jQuery(table).attr('summary',
            jQuery(wym._options.summarySelector).val());

        //append the table after the selected container
        var node = jQuery(wym.findUp(wym.container(),
          WYMeditor.MAIN_CONTAINERS)).get(0);
        if(!node || !node.parentNode) jQuery(wym._doc.body).append(table);
        else jQuery(node).after(table);
      }
      window.close();
  });

  jQuery(wym._options.dialogPasteSelector + " "
    + wym._options.submitSelector).click(function() {

      var sText = jQuery(wym._options.textSelector).val();
      wym.paste(sText);
      window.close();
  });

  jQuery(wym._options.dialogPreviewSelector + " "
    + wym._options.previewSelector)
    .html(wym.xhtml());

  //cancel button
  jQuery(wym._options.cancelSelector).mousedown(function() {
    window.close();
  });

  //pre-init functions
  if(jQuery.isFunction(wym._options.postInitDialog))
    wym._options.postInitDialog(wym,window);

};

/********** XHTML LEXER/PARSER **********/

/*
* @name xml
* @description Use these methods to generate XML and XHTML compliant tags and
* escape tag attributes correctly
* @author Bermi Ferrer - http://bermi.org
* @author David Heinemeier Hansson http://loudthinking.com
*/
WYMeditor.XmlHelper = function()
{
  this._entitiesDiv = document.createElement('div');
  return this;
};


/*
* @name tag
* @description
* Returns an empty HTML tag of type *name* which by default is XHTML
* compliant. Setting *open* to true will create an open tag compatible
* with HTML 4.0 and below. Add HTML attributes by passing an attributes
* array to *options*. For attributes with no value like (disabled and
* readonly), give it a value of true in the *options* array.
*
* Examples:
*
*   this.tag('br')
*    # => <br />
*   this.tag ('br', false, true)
*    # => <br>
*   this.tag ('input', jQuery({type:'text',disabled:true }) )
*    # => <input type="text" disabled="disabled" />
*/
WYMeditor.XmlHelper.prototype.tag = function(name, options, open)
{
  options = options || false;
  open = open || false;
  return '<'+name+(options ? this.tagOptions(options) : '')+(open ? '>' : ' />');
};

/*
* @name contentTag
* @description
* Returns a XML block tag of type *name* surrounding the *content*. Add
* XML attributes by passing an attributes array to *options*. For attributes
* with no value like (disabled and readonly), give it a value of true in
* the *options* array. You can use symbols or strings for the attribute names.
*
*   this.contentTag ('p', 'Hello world!' )
*    # => <p>Hello world!</p>
*   this.contentTag('div', this.contentTag('p', "Hello world!"), jQuery({class : "strong"}))
*    # => <div class="strong"><p>Hello world!</p></div>
*   this.contentTag("select", options, jQuery({multiple : true}))
*    # => <select multiple="multiple">...options...</select>
*/
WYMeditor.XmlHelper.prototype.contentTag = function(name, content, options)
{
  options = options || false;
  return '<'+name+(options ? this.tagOptions(options) : '')+'>'+content+'</'+name+'>';
};

/*
* @name cdataSection
* @description
* Returns a CDATA section for the given +content+.  CDATA sections
* are used to escape blocks of text containing characters which would
* otherwise be recognized as markup. CDATA sections begin with the string
* <tt>&lt;![CDATA[</tt> and } with (and may not contain) the string
* <tt>]]></tt>.
*/
WYMeditor.XmlHelper.prototype.cdataSection = function(content)
{
  return '<![CDATA['+content+']]>';
};


/*
* @name escapeOnce
* @description
* Returns the escaped +xml+ without affecting existing escaped entities.
*
*  this.escapeOnce( "1 > 2 &amp; 3")
*    # => "1 &gt; 2 &amp; 3"
*/
WYMeditor.XmlHelper.prototype.escapeOnce = function(xml)
{
  return this._fixDoubleEscape(this.escapeEntities(xml));
};

/*
* @name _fixDoubleEscape
* @description
* Fix double-escaped entities, such as &amp;amp;, &amp;#123;, etc.
*/
WYMeditor.XmlHelper.prototype._fixDoubleEscape = function(escaped)
{
  return escaped.replace(/&amp;([a-z]+|(#\d+));/ig, "&$1;");
};

/*
* @name tagOptions
* @description
* Takes an array like the one generated by Tag.parseAttributes
*  [["src", "http://www.editam.com/?a=b&c=d&amp;f=g"], ["title", "Editam, <Simplified> CMS"]]
* or an object like {src:"http://www.editam.com/?a=b&c=d&amp;f=g", title:"Editam, <Simplified> CMS"}
* and returns a string properly escaped like
* ' src = "http://www.editam.com/?a=b&amp;c=d&amp;f=g" title = "Editam, &lt;Simplified&gt; CMS"'
* which is valid for strict XHTML
*/
WYMeditor.XmlHelper.prototype.tagOptions = function(options)
{
  var xml = this;
  xml._formated_options = '';

  for (var key in options) {
    var formated_options = '';
    var value = options[key];
    if(typeof value != 'function' && value.length > 0) {

      if(parseInt(key) == key && typeof value == 'object'){
        key = value.shift();
        value = value.pop();
      }
      if(key != '' && value != ''){
        xml._formated_options += ' '+key+'="'+xml.escapeOnce(value)+'"';
      }
    }
  }
  return xml._formated_options;
};

/*
* @name escapeEntities
* @description
* Escapes XML/HTML entities <, >, & and ". If seccond parameter is set to false it
* will not escape ". If set to true it will also escape '
*/
WYMeditor.XmlHelper.prototype.escapeEntities = function(string, escape_quotes)
{
  this._entitiesDiv.innerHTML = string;
  this._entitiesDiv.textContent = string;
  var result = this._entitiesDiv.innerHTML;
  if(typeof escape_quotes == 'undefined'){
    if(escape_quotes != false) result = result.replace('"', '&quot;');
    if(escape_quotes == true)  result = result.replace('"', '&#039;');
  }
  return result;
};

/*
* Parses a string conatining tag attributes and values an returns an array formated like
*  [["src", "http://www.editam.com"], ["title", "Editam, Simplified CMS"]]
*/
WYMeditor.XmlHelper.prototype.parseAttributes = function(tag_attributes)
{
  // Use a compounded regex to match single quoted, double quoted and unquoted attribute pairs
  var result = [];
  var matches = tag_attributes.split(/((=\s*")(")("))|((=\s*\')(\')(\'))|((=\s*[^>\s]*))/g);
  if(matches.toString() != tag_attributes){
    for (var k in matches) {
      var v = matches[k];
      if(typeof v != 'function' && v.length != 0){
        var re = new RegExp('(\\w+)\\s*'+v);
        if(match = tag_attributes.match(re) ){
          var value = v.replace(/^[\s=]+/, "");
          var delimiter = value.charAt(0);
          delimiter = delimiter == '"' ? '"' : (delimiter=="'"?"'":'');
          if(delimiter != ''){
            value = delimiter == '"' ? value.replace(/^"|"+$/g, '') :  value.replace(/^'|'+$/g, '');
          }
          tag_attributes = tag_attributes.replace(match[0],'');
          result.push([match[1] , value]);
        }
      }
    }
  }
  return result;
};

/**
* XhtmlValidator for validating tag attributes
*
* @author Bermi Ferrer - http://bermi.org
*/
WYMeditor.XhtmlValidator = {
  "_attributes":
  {
    "core":
    {
      "except":[
      "base",
      "head",
      "html",
      "meta",
      "param",
      "script",
      "style",
      "title"
      ],
      "attributes":[
      "class",
      "id",
      "style",
      "title",
      "accesskey",
      "tabindex"
      ]
    },
    "language":
    {
      "except":[
      "base",
      "br",
      "hr",
      "iframe",
      "param",
      "script"
      ],
      "attributes":
      {
        "dir":[
        "ltr",
        "rtl"
        ],
        "0":"lang",
        "1":"xml:lang"
      }
    },
    "keyboard":
    {
      "attributes":
      {
        "accesskey":/^(\w){1}$/,
        "tabindex":/^(\d)+$/
      }
    }
  },
  "_events":
  {
    "window":
    {
      "only":[
      "body"
      ],
      "attributes":[
      "onload",
      "onunload"
      ]
    },
    "form":
    {
      "only":[
      "form",
      "input",
      "textarea",
      "select",
      "a",
      "label",
      "button"
      ],
      "attributes":[
      "onchange",
      "onsubmit",
      "onreset",
      "onselect",
      "onblur",
      "onfocus"
      ]
    },
    "keyboard":
    {
      "except":[
      "base",
      "bdo",
      "br",
      "frame",
      "frameset",
      "head",
      "html",
      "iframe",
      "meta",
      "param",
      "script",
      "style",
      "title"
      ],
      "attributes":[
      "onkeydown",
      "onkeypress",
      "onkeyup"
      ]
    },
    "mouse":
    {
      "except":[
      "base",
      "bdo",
      "br",
      "head",
      "html",
      "meta",
      "param",
      "script",
      "style",
      "title"
      ],
      "attributes":[
      "onclick",
      "ondblclick",
      "onmousedown",
      "onmousemove",
      "onmouseover",
      "onmouseout",
      "onmouseup"
      ]
    }
  },
  "_tags":
  {
    "a":
    {
      "attributes":
      {
        "0":"charset",
        "1":"coords",
        "2":"href",
        "3":"hreflang",
        "4":"name",
        "rel":/^(alternate|designates|stylesheet|start|next|prev|contents|index|glossary|copyright|chapter|section|subsection|appendix|help|bookmark| |shortcut|icon)+$/,
        "rev":/^(alternate|designates|stylesheet|start|next|prev|contents|index|glossary|copyright|chapter|section|subsection|appendix|help|bookmark| |shortcut|icon)+$/,
        "shape":/^(rect|rectangle|circ|circle|poly|polygon)$/,
        "5":"type"
      }
    },
    "0":"abbr",
    "1":"acronym",
    "2":"address",
    "area":
    {
      "attributes":
      {
        "0":"alt",
        "1":"coords",
        "2":"href",
        "nohref":/^(true|false)$/,
        "shape":/^(rect|rectangle|circ|circle|poly|polygon)$/
      },
      "required":[
      "alt"
      ]
    },
    "3":"b",
    "base":
    {
      "attributes":[
      "href"
      ],
      "required":[
      "href"
      ]
    },
    "bdo":
    {
      "attributes":
      {
        "dir":/^(ltr|rtl)$/
      },
      "required":[
      "dir"
      ]
    },
    "4":"big",
    "blockquote":
    {
      "attributes":[
      "cite"
      ]
    },
    "5":"body",
    "6":"br",
    "button":
    {
      "attributes":
      {
        "disabled":/^(disabled)$/,
        "type":/^(button|reset|submit)$/,
        "0":"value"
      },
      "inside":"form"
    },
    "7":"caption",
    "8":"cite",
    "9":"code",
    "col":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify)$/,
        "0":"char",
        "1":"charoff",
        "span":/^(\d)+$/,
        "valign":/^(top|middle|bottom|baseline)$/,
        "2":"width"
      },
      "inside":"colgroup"
    },
    "colgroup":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify)$/,
        "0":"char",
        "1":"charoff",
        "span":/^(\d)+$/,
        "valign":/^(top|middle|bottom|baseline)$/,
        "2":"width"
      }
    },
    "10":"dd",
    "del":
    {
      "attributes":
      {
        "0":"cite",
        "datetime":/^([0-9]){8}/
      }
    },
    "11":"div",
    "12":"dfn",
    "13":"dl",
    "14":"dt",
    "15":"em",
    "fieldset":
    {
      "inside":"form"
    },
    "form":
    {
      "attributes":
      {
        "0":"action",
        "1":"accept",
        "2":"accept-charset",
        "3":"enctype",
        "method":/^(get|post)$/
      },
      "required":[
      "action"
      ]
    },
    "head":
    {
      "attributes":[
      "profile"
      ]
    },
    "16":"h1",
    "17":"h2",
    "18":"h3",
    "19":"h4",
    "20":"h5",
    "21":"h6",
    "22":"hr",
    "html":
    {
      "attributes":[
      "xmlns"
      ]
    },
    "23":"i",
    "img":
    {
      "attributes":[
      "alt",
      "src",
      "height",
      "ismap",
      "longdesc",
      "usemap",
      "width"
      ],
      "required":[
      "alt",
      "src"
      ]
    },
    "input":
    {
      "attributes":
      {
        "0":"accept",
        "1":"alt",
        "checked":/^(checked)$/,
        "disabled":/^(disabled)$/,
        "maxlength":/^(\d)+$/,
        "2":"name",
        "readonly":/^(readonly)$/,
        "size":/^(\d)+$/,
        "3":"src",
        "type":/^(button|checkbox|file|hidden|image|password|radio|reset|submit|text)$/,
        "4":"value"
      },
      "inside":"form"
    },
    "ins":
    {
      "attributes":
      {
        "0":"cite",
        "datetime":/^([0-9]){8}/
      }
    },
    "24":"kbd",
    "label":
    {
      "attributes":[
      "for"
      ],
      "inside":"form"
    },
    "25":"legend",
    "26":"li",
    "link":
    {
      "attributes":
      {
        "0":"charset",
        "1":"href",
        "2":"hreflang",
        "media":/^(all|braille|print|projection|screen|speech|,|;| )+$/i,
        //next comment line required by Opera!
        /*"rel":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,*/
        "rel":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,
        "rev":/^(alternate|appendix|bookmark|chapter|contents|copyright|glossary|help|home|index|next|prev|section|start|stylesheet|subsection| |shortcut|icon)+$/i,
        "3":"type"
      },
      "inside":"head"
    },
    "map":
    {
      "attributes":[
      "id",
      "name"
      ],
      "required":[
      "id"
      ]
    },
    "meta":
    {
      "attributes":
      {
        "0":"content",
        "http-equiv":/^(content\-type|expires|refresh|set\-cookie)$/i,
        "1":"name",
        "2":"scheme"
      },
      "required":[
      "content"
      ]
    },
    "27":"noscript",
    "object":
    {
      "attributes":[
      "archive",
      "classid",
      "codebase",
      "codetype",
      "data",
      "declare",
      "height",
      "name",
      "standby",
      "type",
      "usemap",
      "width"
      ]
    },
    "28":"ol",
    "optgroup":
    {
      "attributes":
      {
        "0":"label",
        "disabled": /^(disabled)$/
      },
      "required":[
      "label"
      ]
    },
    "option":
    {
      "attributes":
      {
        "0":"label",
        "disabled":/^(disabled)$/,
        "selected":/^(selected)$/,
        "1":"value"
      },
      "inside":"select"
    },
    "29":"p",
    "param":
    {
      "attributes":
      {
        "0":"type",
        "valuetype":/^(data|ref|object)$/,
        "1":"valuetype",
        "2":"value"
      },
      "required":[
      "name"
      ]
    },
    "30":"pre",
    "q":
    {
      "attributes":[
      "cite"
      ]
    },
    "31":"samp",
    "script":
    {
      "attributes":
      {
        "type":/^(text\/ecmascript|text\/javascript|text\/jscript|text\/vbscript|text\/vbs|text\/xml)$/,
        "0":"charset",
        "defer":/^(defer)$/,
        "1":"src"
      },
      "required":[
      "type"
      ]
    },
    "select":
    {
      "attributes":
      {
        "disabled":/^(disabled)$/,
        "multiple":/^(multiple)$/,
        "0":"name",
        "1":"size"
      },
      "inside":"form"
    },
    "32":"small",
    "33":"span",
    "34":"strong",
    "style":
    {
      "attributes":
      {
        "0":"type",
        "media":/^(screen|tty|tv|projection|handheld|print|braille|aural|all)$/
      },
      "required":[
      "type"
      ]
    },
    "35":"sub",
    "36":"sup",
    "table":
    {
      "attributes":
      {
        "0":"border",
        "1":"cellpadding",
        "2":"cellspacing",
        "frame":/^(void|above|below|hsides|lhs|rhs|vsides|box|border)$/,
        "rules":/^(none|groups|rows|cols|all)$/,
        "3":"summary",
        "4":"width"
      }
    },
    "tbody":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify)$/,
        "0":"char",
        "1":"charoff",
        "valign":/^(top|middle|bottom|baseline)$/
      }
    },
    "td":
    {
      "attributes":
      {
        "0":"abbr",
        "align":/^(left|right|center|justify|char)$/,
        "1":"axis",
        "2":"char",
        "3":"charoff",
        "colspan":/^(\d)+$/,
        "4":"headers",
        "rowspan":/^(\d)+$/,
        "scope":/^(col|colgroup|row|rowgroup)$/,
        "valign":/^(top|middle|bottom|baseline)$/
      }
    },
    "textarea":
    {
      "attributes":[
      "cols",
      "rows",
      "disabled",
      "name",
      "readonly"
      ],
      "required":[
      "cols",
      "rows"
      ],
      "inside":"form"
    },
    "tfoot":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify)$/,
        "0":"char",
        "1":"charoff",
        "valign":/^(top|middle|bottom)$/,
        "2":"baseline"
      }
    },
    "th":
    {
      "attributes":
      {
        "0":"abbr",
        "align":/^(left|right|center|justify|char)$/,
        "1":"axis",
        "2":"char",
        "3":"charoff",
        "colspan":/^(\d)+$/,
        "4":"headers",
        "rowspan":/^(\d)+$/,
        "scope":/^(col|colgroup|row|rowgroup)$/,
        "valign":/^(top|middle|bottom|baseline)$/
      }
    },
    "thead":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify)$/,
        "0":"char",
        "1":"charoff",
        "valign":/^(top|middle|bottom|baseline)$/
      }
    },
    "37":"title",
    "tr":
    {
      "attributes":
      {
        "align":/^(right|left|center|justify|char)$/,
        "0":"char",
        "1":"charoff",
        "valign":/^(top|middle|bottom|baseline)$/
      }
    },
    "38":"tt",
    "39":"ul",
    "40":"var"
  },

  // Temporary skiped attributes
  skiped_attributes : [],
  skiped_attribute_values : [],

  getValidTagAttributes: function(tag, attributes)
  {
    var valid_attributes = {};
    var possible_attributes = this.getPossibleTagAttributes(tag);
    for(var attribute in attributes) {
      var value = attributes[attribute];
      var h = WYMeditor.Helper;
      if(!h.contains(this.skiped_attributes, attribute) && !h.contains(this.skiped_attribute_values, value)){
        if (typeof value != 'function' && h.contains(possible_attributes, attribute)) {
          if (this.doesAttributeNeedsValidation(tag, attribute)) {
            if(this.validateAttribute(tag, attribute, value)){
              valid_attributes[attribute] = value;
            }
          }else{
            valid_attributes[attribute] = value;
          }
        }
      }
    }
    return valid_attributes;
  },
  getUniqueAttributesAndEventsForTag : function(tag)
  {
    var result = [];

    if (this._tags[tag] && this._tags[tag]['attributes']) {
      for (k in this._tags[tag]['attributes']) {
        result.push(parseInt(k) == k ? this._tags[tag]['attributes'][k] : k);
      }
    }
    return result;
  },
  getDefaultAttributesAndEventsForTags : function()
  {
    var result = [];
    for (var key in this._events){
      result.push(this._events[key]);
    }
    for (var key in this._attributes){
      result.push(this._attributes[key]);
    }
    return result;
  },
  isValidTag : function(tag)
  {
    if(this._tags[tag]){
      return true;
    }
    for(var key in this._tags){
      if(this._tags[key] == tag){
        return true;
      }
    }
    return false;
  },
  getDefaultAttributesAndEventsForTag : function(tag)
  {
    var default_attributes = [];
    if (this.isValidTag(tag)) {
      var default_attributes_and_events = this.getDefaultAttributesAndEventsForTags();

      for(var key in default_attributes_and_events) {
        var defaults = default_attributes_and_events[key];
        if(typeof defaults == 'object'){
          var h = WYMeditor.Helper;
          if ((defaults['except'] && h.contains(defaults['except'], tag)) || (defaults['only'] && !h.contains(defaults['only'], tag))) {
            continue;
          }

          var tag_defaults = defaults['attributes'] ? defaults['attributes'] : defaults['events'];
          for(var k in tag_defaults) {
            default_attributes.push(typeof tag_defaults[k] != 'string' ? k : tag_defaults[k]);
          }
        }
      }
    }
    return default_attributes;
  },
  doesAttributeNeedsValidation: function(tag, attribute)
  {
    return this._tags[tag] && ((this._tags[tag]['attributes'] && this._tags[tag]['attributes'][attribute]) || (this._tags[tag]['required'] &&
     WYMeditor.Helper.contains(this._tags[tag]['required'], attribute)));
  },
  validateAttribute : function(tag, attribute, value)
  {
    if ( this._tags[tag] &&
      (this._tags[tag]['attributes'] && this._tags[tag]['attributes'][attribute] && value.length > 0 && !value.match(this._tags[tag]['attributes'][attribute])) || // invalid format
      (this._tags[tag] && this._tags[tag]['required'] && WYMeditor.Helper.contains(this._tags[tag]['required'], attribute) && value.length == 0) // required attribute
    ) {
      return false;
    }
    return typeof this._tags[tag] != 'undefined';
  },
  getPossibleTagAttributes : function(tag)
  {
    if (!this._possible_tag_attributes) {
      this._possible_tag_attributes = {};
    }
    if (!this._possible_tag_attributes[tag]) {
      this._possible_tag_attributes[tag] = this.getUniqueAttributesAndEventsForTag(tag).concat(this.getDefaultAttributesAndEventsForTag(tag));
    }
    return this._possible_tag_attributes[tag];
  }
};


/**
*    Compounded regular expression. Any of
*    the contained patterns could match and
*    when one does, it's label is returned.
*
*    Constructor. Starts with no patterns.
*    @param boolean case    True for case sensitive, false
*                            for insensitive.
*    @access public
*    @author Marcus Baker (http://lastcraft.com)
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.ParallelRegex = function(case_sensitive)
{
  this._case = case_sensitive;
  this._patterns = [];
  this._labels = [];
  this._regex = null;
  return this;
};


/**
*    Adds a pattern with an optional label.
*    @param string pattern      Perl style regex, but ( and )
*                                lose the usual meaning.
*    @param string label        Label of regex to be returned
*                                on a match.
*    @access public
*/
WYMeditor.ParallelRegex.prototype.addPattern = function(pattern, label)
{
  label = label || true;
  var count = this._patterns.length;
  this._patterns[count] = pattern;
  this._labels[count] = label;
  this._regex = null;
};

/**
*    Attempts to match all patterns at once against
*    a string.
*    @param string subject      String to match against.
*
*    @return boolean             True on success.
*    @return string match         First matched portion of
*                                subject.
*    @access public
*/
WYMeditor.ParallelRegex.prototype.match = function(subject)
{
  if (this._patterns.length == 0) {
    return [false, ''];
  }
  var matches = subject.match(this._getCompoundedRegex());

  if(!matches){
    return [false, ''];
  }
  var match = matches[0];
  for (var i = 1; i < matches.length; i++) {
    if (matches[i]) {
      return [this._labels[i-1], match];
    }
  }
  return [true, matches[0]];
};

/**
*    Compounds the patterns into a single
*    regular expression separated with the
*    "or" operator. Caches the regex.
*    Will automatically escape (, ) and / tokens.
*    @param array patterns    List of patterns in order.
*    @access private
*/
WYMeditor.ParallelRegex.prototype._getCompoundedRegex = function()
{
  if (this._regex == null) {
    for (var i = 0, count = this._patterns.length; i < count; i++) {
      this._patterns[i] = '(' + this._untokenizeRegex(this._tokenizeRegex(this._patterns[i]).replace(/([\/\(\)])/g,'\\$1')) + ')';
    }
    this._regex = new RegExp(this._patterns.join("|") ,this._getPerlMatchingFlags());
  }
  return this._regex;
};

/**
* Escape lookahead/lookbehind blocks
*/
WYMeditor.ParallelRegex.prototype._tokenizeRegex = function(regex)
{
  return regex.
  replace(/\(\?(i|m|s|x|U)\)/,     '~~~~~~Tk1\$1~~~~~~').
  replace(/\(\?(\-[i|m|s|x|U])\)/, '~~~~~~Tk2\$1~~~~~~').
  replace(/\(\?\=(.*)\)/,          '~~~~~~Tk3\$1~~~~~~').
  replace(/\(\?\!(.*)\)/,          '~~~~~~Tk4\$1~~~~~~').
  replace(/\(\?\<\=(.*)\)/,        '~~~~~~Tk5\$1~~~~~~').
  replace(/\(\?\<\!(.*)\)/,        '~~~~~~Tk6\$1~~~~~~').
  replace(/\(\?\:(.*)\)/,          '~~~~~~Tk7\$1~~~~~~');
};

/**
* Unscape lookahead/lookbehind blocks
*/
WYMeditor.ParallelRegex.prototype._untokenizeRegex = function(regex)
{
  return regex.
  replace(/~~~~~~Tk1(.{1})~~~~~~/,    "(?\$1)").
  replace(/~~~~~~Tk2(.{2})~~~~~~/,    "(?\$1)").
  replace(/~~~~~~Tk3(.*)~~~~~~/,      "(?=\$1)").
  replace(/~~~~~~Tk4(.*)~~~~~~/,      "(?!\$1)").
  replace(/~~~~~~Tk5(.*)~~~~~~/,      "(?<=\$1)").
  replace(/~~~~~~Tk6(.*)~~~~~~/,      "(?<!\$1)").
  replace(/~~~~~~Tk7(.*)~~~~~~/,      "(?:\$1)");
};


/**
*    Accessor for perl regex mode flags to use.
*    @return string       Perl regex flags.
*    @access private
*/
WYMeditor.ParallelRegex.prototype._getPerlMatchingFlags = function()
{
  return (this._case ? "m" : "mi");
};



/**
*    States for a stack machine.
*
*    Constructor. Starts in named state.
*    @param string start        Starting state name.
*    @access public
*    @author Marcus Baker (http://lastcraft.com)
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.StateStack = function(start)
{
  this._stack = [start];
  return this;
};

/**
*    Accessor for current state.
*    @return string       State.
*    @access public
*/
WYMeditor.StateStack.prototype.getCurrent = function()
{
  return this._stack[this._stack.length - 1];
};

/**
*    Adds a state to the stack and sets it
*    to be the current state.
*    @param string state        New state.
*    @access public
*/
WYMeditor.StateStack.prototype.enter = function(state)
{
  this._stack.push(state);
};

/**
*    Leaves the current state and reverts
*    to the previous one.
*    @return boolean    False if we drop off
*                       the bottom of the list.
*    @access public
*/
WYMeditor.StateStack.prototype.leave = function()
{
  if (this._stack.length == 1) {
    return false;
  }
  this._stack.pop();
  return true;
};


WYMeditor.LEXER_ENTER = 1;
WYMeditor.LEXER_MATCHED = 2;
WYMeditor.LEXER_UNMATCHED = 3;
WYMeditor.LEXER_EXIT = 4;
WYMeditor.LEXER_SPECIAL = 5;


/**
*    Accepts text and breaks it into tokens.
*    Some optimisation to make the sure the
*    content is only scanned by the PHP regex
*    parser once. Lexer modes must not start
*    with leading underscores.
*
*    Sets up the lexer in case insensitive matching
*    by default.
*    @param Parser parser  Handling strategy by reference.
*    @param string start            Starting handler.
*    @param boolean case            True for case sensitive.
*    @access public
*    @author Marcus Baker (http://lastcraft.com)
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.Lexer = function(parser, start, case_sensitive)
{
  start = start || 'accept';
  this._case = case_sensitive || false;
  this._regexes = {};
  this._parser = parser;
  this._mode = new WYMeditor.StateStack(start);
  this._mode_handlers = {};
  this._mode_handlers[start] = start;
  return this;
};

/**
*    Adds a token search pattern for a particular
*    parsing mode. The pattern does not change the
*    current mode.
*    @param string pattern      Perl style regex, but ( and )
*                                lose the usual meaning.
*    @param string mode         Should only apply this
*                                pattern when dealing with
*                                this type of input.
*    @access public
*/
WYMeditor.Lexer.prototype.addPattern = function(pattern, mode)
{
  var mode = mode || "accept";
  if (typeof this._regexes[mode] == 'undefined') {
    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);
  }
  this._regexes[mode].addPattern(pattern);
  if (typeof this._mode_handlers[mode] == 'undefined') {
    this._mode_handlers[mode] = mode;
  }
};

/**
*    Adds a pattern that will enter a new parsing
*    mode. Useful for entering parenthesis, strings,
*    tags, etc.
*    @param string pattern      Perl style regex, but ( and )
*                                lose the usual meaning.
*    @param string mode         Should only apply this
*                                pattern when dealing with
*                                this type of input.
*    @param string new_mode     Change parsing to this new
*                                nested mode.
*    @access public
*/
WYMeditor.Lexer.prototype.addEntryPattern = function(pattern, mode, new_mode)
{
  if (typeof this._regexes[mode] == 'undefined') {
    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);
  }
  this._regexes[mode].addPattern(pattern, new_mode);
  if (typeof this._mode_handlers[new_mode] == 'undefined') {
    this._mode_handlers[new_mode] = new_mode;
  }
};

/**
*    Adds a pattern that will exit the current mode
*    and re-enter the previous one.
*    @param string pattern      Perl style regex, but ( and )
*                                lose the usual meaning.
*    @param string mode         Mode to leave.
*    @access public
*/
WYMeditor.Lexer.prototype.addExitPattern = function(pattern, mode)
{
  if (typeof this._regexes[mode] == 'undefined') {
    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);
  }
  this._regexes[mode].addPattern(pattern, "__exit");
  if (typeof this._mode_handlers[mode] == 'undefined') {
    this._mode_handlers[mode] = mode;
  }
};

/**
*    Adds a pattern that has a special mode. Acts as an entry
*    and exit pattern in one go, effectively calling a special
*    parser handler for this token only.
*    @param string pattern      Perl style regex, but ( and )
*                                lose the usual meaning.
*    @param string mode         Should only apply this
*                                pattern when dealing with
*                                this type of input.
*    @param string special      Use this mode for this one token.
*    @access public
*/
WYMeditor.Lexer.prototype.addSpecialPattern =  function(pattern, mode, special)
{
  if (typeof this._regexes[mode] == 'undefined') {
    this._regexes[mode] = new WYMeditor.ParallelRegex(this._case);
  }
  this._regexes[mode].addPattern(pattern, '_'+special);
  if (typeof this._mode_handlers[special] == 'undefined') {
    this._mode_handlers[special] = special;
  }
};

/**
*    Adds a mapping from a mode to another handler.
*    @param string mode        Mode to be remapped.
*    @param string handler     New target handler.
*    @access public
*/
WYMeditor.Lexer.prototype.mapHandler = function(mode, handler)
{
  this._mode_handlers[mode] = handler;
};

/**
*    Splits the page text into tokens. Will fail
*    if the handlers report an error or if no
*    content is consumed. If successful then each
*    unparsed and parsed token invokes a call to the
*    held listener.
*    @param string raw        Raw HTML text.
*    @return boolean           True on success, else false.
*    @access public
*/
WYMeditor.Lexer.prototype.parse = function(raw)
{
  if (typeof this._parser == 'undefined') {
    return false;
  }

  var length = raw.length;
  var parsed;
  while (typeof (parsed = this._reduce(raw)) == 'object') {
    var raw = parsed[0];
    var unmatched = parsed[1];
    var matched = parsed[2];
    var mode = parsed[3];

    if (! this._dispatchTokens(unmatched, matched, mode)) {
      return false;
    }

    if (raw == '') {
      return true;
    }
    if (raw.length == length) {
      return false;
    }
    length = raw.length;
  }
  if (! parsed ) {
    return false;
  }

  return this._invokeParser(raw, WYMeditor.LEXER_UNMATCHED);
};

/**
*    Sends the matched token and any leading unmatched
*    text to the parser changing the lexer to a new
*    mode if one is listed.
*    @param string unmatched    Unmatched leading portion.
*    @param string matched      Actual token match.
*    @param string mode         Mode after match. A boolean
*                                false mode causes no change.
*    @return boolean             False if there was any error
*                                from the parser.
*    @access private
*/
WYMeditor.Lexer.prototype._dispatchTokens = function(unmatched, matched, mode)
{
  mode = mode || false;

  if (! this._invokeParser(unmatched, WYMeditor.LEXER_UNMATCHED)) {
    return false;
  }

  if (typeof mode == 'boolean') {
    return this._invokeParser(matched, WYMeditor.LEXER_MATCHED);
  }
  if (this._isModeEnd(mode)) {
    if (! this._invokeParser(matched, WYMeditor.LEXER_EXIT)) {
      return false;
    }
    return this._mode.leave();
  }
  if (this._isSpecialMode(mode)) {
    this._mode.enter(this._decodeSpecial(mode));
    if (! this._invokeParser(matched, WYMeditor.LEXER_SPECIAL)) {
      return false;
    }
    return this._mode.leave();
  }
  this._mode.enter(mode);

  return this._invokeParser(matched, WYMeditor.LEXER_ENTER);
};

/**
*    Tests to see if the new mode is actually to leave
*    the current mode and pop an item from the matching
*    mode stack.
*    @param string mode    Mode to test.
*    @return boolean        True if this is the exit mode.
*    @access private
*/
WYMeditor.Lexer.prototype._isModeEnd = function(mode)
{
  return (mode === "__exit");
};

/**
*    Test to see if the mode is one where this mode
*    is entered for this token only and automatically
*    leaves immediately afterwoods.
*    @param string mode    Mode to test.
*    @return boolean        True if this is the exit mode.
*    @access private
*/
WYMeditor.Lexer.prototype._isSpecialMode = function(mode)
{
  return (mode.substring(0,1) == "_");
};

/**
*    Strips the magic underscore marking single token
*    modes.
*    @param string mode    Mode to decode.
*    @return string         Underlying mode name.
*    @access private
*/
WYMeditor.Lexer.prototype._decodeSpecial = function(mode)
{
  return mode.substring(1);
};

/**
*    Calls the parser method named after the current
*    mode. Empty content will be ignored. The lexer
*    has a parser handler for each mode in the lexer.
*    @param string content        Text parsed.
*    @param boolean is_match      Token is recognised rather
*                                  than unparsed data.
*    @access private
*/
WYMeditor.Lexer.prototype._invokeParser = function(content, is_match)
{

  if (content === '') {
    return true;
  }
  var current = this._mode.getCurrent();
  var handler = this._mode_handlers[current];
  var result;
  eval('result = this._parser.' + handler + '(content, is_match);');
  return result;
};

/**
*    Tries to match a chunk of text and if successful
*    removes the recognised chunk and any leading
*    unparsed data. Empty strings will not be matched.
*    @param string raw         The subject to parse. This is the
*                               content that will be eaten.
*    @return array/boolean      Three item list of unparsed
*                               content followed by the
*                               recognised token and finally the
*                               action the parser is to take.
*                               True if no match, false if there
*                               is a parsing error.
*    @access private
*/
WYMeditor.Lexer.prototype._reduce = function(raw)
{
  var matched = this._regexes[this._mode.getCurrent()].match(raw);
  var match = matched[1];
  var action = matched[0];
  if (action) {
    var unparsed_character_count = raw.indexOf(match);
    var unparsed = raw.substr(0, unparsed_character_count);
    raw = raw.substring(unparsed_character_count + match.length);
    return [raw, unparsed, match, action];
  }
  return true;
};



/**
* This are the rules for breaking the XHTML code into events
* handled by the provided parser.
*
*    @author Marcus Baker (http://lastcraft.com)
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.XhtmlLexer = function(parser)
{
  jQuery.extend(this, new WYMeditor.Lexer(parser, 'Text'));

  this.mapHandler('Text', 'Text');

  this.addTokens();

  this.init();

  return this;
};


WYMeditor.XhtmlLexer.prototype.init = function()
{
};

WYMeditor.XhtmlLexer.prototype.addTokens = function()
{
  this.addCommentTokens('Text');
  this.addScriptTokens('Text');
  this.addCssTokens('Text');
  this.addTagTokens('Text');
};

WYMeditor.XhtmlLexer.prototype.addCommentTokens = function(scope)
{
  this.addEntryPattern("<!--", scope, 'Comment');
  this.addExitPattern("-->", 'Comment');
};

WYMeditor.XhtmlLexer.prototype.addScriptTokens = function(scope)
{
  this.addEntryPattern("<script", scope, 'Script');
  this.addExitPattern("</script>", 'Script');
};

WYMeditor.XhtmlLexer.prototype.addCssTokens = function(scope)
{
  this.addEntryPattern("<style", scope, 'Css');
  this.addExitPattern("</style>", 'Css');
};

WYMeditor.XhtmlLexer.prototype.addTagTokens = function(scope)
{
  this.addSpecialPattern("<\\s*[a-z0-9:\-]+\\s*>", scope, 'OpeningTag');
  this.addEntryPattern("<[a-z0-9:\-]+"+'[\\\/ \\\>]+', scope, 'OpeningTag');
  this.addInTagDeclarationTokens('OpeningTag');

  this.addSpecialPattern("</\\s*[a-z0-9:\-]+\\s*>", scope, 'ClosingTag');

};

WYMeditor.XhtmlLexer.prototype.addInTagDeclarationTokens = function(scope)
{
  this.addSpecialPattern('\\s+', scope, 'Ignore');

  this.addAttributeTokens(scope);

  this.addExitPattern('/>', scope);
  this.addExitPattern('>', scope);

};

WYMeditor.XhtmlLexer.prototype.addAttributeTokens = function(scope)
{
  this.addSpecialPattern("\\s*[a-z-_0-9]*:?[a-z-_0-9]+\\s*(?=\=)\\s*", scope, 'TagAttributes');

  this.addEntryPattern('=\\s*"', scope, 'DoubleQuotedAttribute');
  this.addPattern("\\\\\"", 'DoubleQuotedAttribute');
  this.addExitPattern('"', 'DoubleQuotedAttribute');

  this.addEntryPattern("=\\s*'", scope, 'SingleQuotedAttribute');
  this.addPattern("\\\\'", 'SingleQuotedAttribute');
  this.addExitPattern("'", 'SingleQuotedAttribute');

  this.addSpecialPattern('=\\s*[^>\\s]*', scope, 'UnquotedAttribute');
};



/**
* XHTML Parser.
*
* This XHTML parser will trigger the events available on on
* current SaxListener
*
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.XhtmlParser = function(Listener, mode)
{
  var mode = mode || 'Text';
  this._Lexer = new WYMeditor.XhtmlLexer(this);
  this._Listener = Listener;
  this._mode = mode;
  this._matches = [];
  this._last_match = '';
  this._current_match = '';

  return this;
};

WYMeditor.XhtmlParser.prototype.parse = function(raw)
{
  this._Lexer.parse(this.beforeParsing(raw));
  return this.afterParsing(this._Listener.getResult());
};

WYMeditor.XhtmlParser.prototype.beforeParsing = function(raw)
{
  if(raw.match(/class="MsoNormal"/) || raw.match(/ns = "urn:schemas-microsoft-com/)){
    // Usefull for cleaning up content pasted from other sources (MSWord)
    this._Listener.avoidStylingTagsAndAttributes();
  }
  return this._Listener.beforeParsing(raw);
};

WYMeditor.XhtmlParser.prototype.afterParsing = function(parsed)
{
  if(this._Listener._avoiding_tags_implicitly){
    this._Listener.allowStylingTagsAndAttributes();
  }
  return this._Listener.afterParsing(parsed);
};


WYMeditor.XhtmlParser.prototype.Ignore = function(match, state)
{
  return true;
};

WYMeditor.XhtmlParser.prototype.Text = function(text)
{
  this._Listener.addContent(text);
  return true;
};

WYMeditor.XhtmlParser.prototype.Comment = function(match, status)
{
  return this._addNonTagBlock(match, status, 'addComment');
};

WYMeditor.XhtmlParser.prototype.Script = function(match, status)
{
  return this._addNonTagBlock(match, status, 'addScript');
};

WYMeditor.XhtmlParser.prototype.Css = function(match, status)
{
  return this._addNonTagBlock(match, status, 'addCss');
};

WYMeditor.XhtmlParser.prototype._addNonTagBlock = function(match, state, type)
{
  switch (state){
    case WYMeditor.LEXER_ENTER:
    this._non_tag = match;
    break;
    case WYMeditor.LEXER_UNMATCHED:
    this._non_tag += match;
    break;
    case WYMeditor.LEXER_EXIT:
    switch(type) {
      case 'addComment':
      this._Listener.addComment(this._non_tag+match);
      break;
      case 'addScript':
      this._Listener.addScript(this._non_tag+match);
      break;
      case 'addCss':
      this._Listener.addCss(this._non_tag+match);
      break;
    }
  }
  return true;
};

WYMeditor.XhtmlParser.prototype.OpeningTag = function(match, state)
{
  switch (state){
    case WYMeditor.LEXER_ENTER:
    this._tag = this.normalizeTag(match);
    this._tag_attributes = {};
    break;
    case WYMeditor.LEXER_SPECIAL:
    this._callOpenTagListener(this.normalizeTag(match));
    break;
    case WYMeditor.LEXER_EXIT:
    this._callOpenTagListener(this._tag, this._tag_attributes);
  }
  return true;
};

WYMeditor.XhtmlParser.prototype.ClosingTag = function(match, state)
{
  this._callCloseTagListener(this.normalizeTag(match));
  return true;
};

WYMeditor.XhtmlParser.prototype._callOpenTagListener = function(tag, attributes)
{
  var  attributes = attributes || {};
  this.autoCloseUnclosedBeforeNewOpening(tag);

  if(this._Listener.isBlockTag(tag)){
    this._Listener._tag_stack.push(tag);
    this._Listener.fixNestingBeforeOpeningBlockTag(tag, attributes);
    this._Listener.openBlockTag(tag, attributes);
    this._increaseOpenTagCounter(tag);
  }else if(this._Listener.isInlineTag(tag)){
    this._Listener.inlineTag(tag, attributes);
  }else{
    this._Listener.openUnknownTag(tag, attributes);
    this._increaseOpenTagCounter(tag);
  }
  this._Listener.last_tag = tag;
  this._Listener.last_tag_opened = true;
  this._Listener.last_tag_attributes = attributes;
};

WYMeditor.XhtmlParser.prototype._callCloseTagListener = function(tag)
{
  if(this._decreaseOpenTagCounter(tag)){
    this.autoCloseUnclosedBeforeTagClosing(tag);

    if(this._Listener.isBlockTag(tag)){
      var expected_tag = this._Listener._tag_stack.pop();
      if(expected_tag == false){
        return;
      }else if(expected_tag != tag){
        tag = expected_tag;
      }
      this._Listener.closeBlockTag(tag);
    }else{
      this._Listener.closeUnknownTag(tag);
    }
  }else{
    this._Listener.closeUnopenedTag(tag);
  }
  this._Listener.last_tag = tag;
  this._Listener.last_tag_opened = false;
};

WYMeditor.XhtmlParser.prototype._increaseOpenTagCounter = function(tag)
{
  this._Listener._open_tags[tag] = this._Listener._open_tags[tag] || 0;
  this._Listener._open_tags[tag]++;
};

WYMeditor.XhtmlParser.prototype._decreaseOpenTagCounter = function(tag)
{
  if(this._Listener._open_tags[tag]){
    this._Listener._open_tags[tag]--;
    if(this._Listener._open_tags[tag] == 0){
      this._Listener._open_tags[tag] = undefined;
    }
    return true;
  }
  return false;
};

WYMeditor.XhtmlParser.prototype.autoCloseUnclosedBeforeNewOpening = function(new_tag)
{
  this._autoCloseUnclosed(new_tag, false);
};

WYMeditor.XhtmlParser.prototype.autoCloseUnclosedBeforeTagClosing = function(tag)
{
  this._autoCloseUnclosed(tag, true);
};

WYMeditor.XhtmlParser.prototype._autoCloseUnclosed = function(new_tag, closing)
{
  var closing = closing || false;
  if(this._Listener._open_tags){
    for (var tag in this._Listener._open_tags) {
      var counter = this._Listener._open_tags[tag];
      if(counter > 0 && this._Listener.shouldCloseTagAutomatically(tag, new_tag, closing)){
        this._callCloseTagListener(tag, true);
      }
    }
  }
};

WYMeditor.XhtmlParser.prototype.getTagReplacements = function()
{
  return this._Listener.getTagReplacements();
};

WYMeditor.XhtmlParser.prototype.normalizeTag = function(tag)
{
  tag = tag.replace(/^([\s<\/>]*)|([\s<\/>]*)$/gm,'').toLowerCase();
  var tags = this._Listener.getTagReplacements();
  if(tags[tag]){
    return tags[tag];
  }
  return tag;
};

WYMeditor.XhtmlParser.prototype.TagAttributes = function(match, state)
{
  if(WYMeditor.LEXER_SPECIAL == state){
    this._current_attribute = match;
  }
  return true;
};

WYMeditor.XhtmlParser.prototype.DoubleQuotedAttribute = function(match, state)
{
  if(WYMeditor.LEXER_UNMATCHED == state){
    this._tag_attributes[this._current_attribute] = match;
  }
  return true;
};

WYMeditor.XhtmlParser.prototype.SingleQuotedAttribute = function(match, state)
{
  if(WYMeditor.LEXER_UNMATCHED == state){
    this._tag_attributes[this._current_attribute] = match;
  }
  return true;
};

WYMeditor.XhtmlParser.prototype.UnquotedAttribute = function(match, state)
{
  this._tag_attributes[this._current_attribute] = match.replace(/^=/,'');
  return true;
};



/**
* XHTML Sax parser.
*
*    @author Bermi Ferrer (http://bermi.org)
*/
WYMeditor.XhtmlSaxListener = function()
{
  this.output = '';
  this.helper = new WYMeditor.XmlHelper();
  this._open_tags = {};
  this.validator = WYMeditor.XhtmlValidator;
  this._tag_stack = [];
  this.avoided_tags = [];

  this.entities = {
    '&nbsp;':'&#160;','&iexcl;':'&#161;','&cent;':'&#162;',
    '&pound;':'&#163;','&curren;':'&#164;','&yen;':'&#165;',
    '&brvbar;':'&#166;','&sect;':'&#167;','&uml;':'&#168;',
    '&copy;':'&#169;','&ordf;':'&#170;','&laquo;':'&#171;',
    '&not;':'&#172;','&shy;':'&#173;','&reg;':'&#174;',
    '&macr;':'&#175;','&deg;':'&#176;','&plusmn;':'&#177;',
    '&sup2;':'&#178;','&sup3;':'&#179;','&acute;':'&#180;',
    '&micro;':'&#181;','&para;':'&#182;','&middot;':'&#183;',
    '&cedil;':'&#184;','&sup1;':'&#185;','&ordm;':'&#186;',
    '&raquo;':'&#187;','&frac14;':'&#188;','&frac12;':'&#189;',
    '&frac34;':'&#190;','&iquest;':'&#191;','&Agrave;':'&#192;',
    '&Aacute;':'&#193;','&Acirc;':'&#194;','&Atilde;':'&#195;',
    '&Auml;':'&#196;','&Aring;':'&#197;','&AElig;':'&#198;',
    '&Ccedil;':'&#199;','&Egrave;':'&#200;','&Eacute;':'&#201;',
    '&Ecirc;':'&#202;','&Euml;':'&#203;','&Igrave;':'&#204;',
    '&Iacute;':'&#205;','&Icirc;':'&#206;','&Iuml;':'&#207;',
    '&ETH;':'&#208;','&Ntilde;':'&#209;','&Ograve;':'&#210;',
    '&Oacute;':'&#211;','&Ocirc;':'&#212;','&Otilde;':'&#213;',
    '&Ouml;':'&#214;','&times;':'&#215;','&Oslash;':'&#216;',
    '&Ugrave;':'&#217;','&Uacute;':'&#218;','&Ucirc;':'&#219;',
    '&Uuml;':'&#220;','&Yacute;':'&#221;','&THORN;':'&#222;',
    '&szlig;':'&#223;','&agrave;':'&#224;','&aacute;':'&#225;',
    '&acirc;':'&#226;','&atilde;':'&#227;','&auml;':'&#228;',
    '&aring;':'&#229;','&aelig;':'&#230;','&ccedil;':'&#231;',
    '&egrave;':'&#232;','&eacute;':'&#233;','&ecirc;':'&#234;',
    '&euml;':'&#235;','&igrave;':'&#236;','&iacute;':'&#237;',
    '&icirc;':'&#238;','&iuml;':'&#239;','&eth;':'&#240;',
    '&ntilde;':'&#241;','&ograve;':'&#242;','&oacute;':'&#243;',
    '&ocirc;':'&#244;','&otilde;':'&#245;','&ouml;':'&#246;',
    '&divide;':'&#247;','&oslash;':'&#248;','&ugrave;':'&#249;',
    '&uacute;':'&#250;','&ucirc;':'&#251;','&uuml;':'&#252;',
    '&yacute;':'&#253;','&thorn;':'&#254;','&yuml;':'&#255;',
    '&OElig;':'&#338;','&oelig;':'&#339;','&Scaron;':'&#352;',
    '&scaron;':'&#353;','&Yuml;':'&#376;','&fnof;':'&#402;',
    '&circ;':'&#710;','&tilde;':'&#732;','&Alpha;':'&#913;',
    '&Beta;':'&#914;','&Gamma;':'&#915;','&Delta;':'&#916;',
    '&Epsilon;':'&#917;','&Zeta;':'&#918;','&Eta;':'&#919;',
    '&Theta;':'&#920;','&Iota;':'&#921;','&Kappa;':'&#922;',
    '&Lambda;':'&#923;','&Mu;':'&#924;','&Nu;':'&#925;',
    '&Xi;':'&#926;','&Omicron;':'&#927;','&Pi;':'&#928;',
    '&Rho;':'&#929;','&Sigma;':'&#931;','&Tau;':'&#932;',
    '&Upsilon;':'&#933;','&Phi;':'&#934;','&Chi;':'&#935;',
    '&Psi;':'&#936;','&Omega;':'&#937;','&alpha;':'&#945;',
    '&beta;':'&#946;','&gamma;':'&#947;','&delta;':'&#948;',
    '&epsilon;':'&#949;','&zeta;':'&#950;','&eta;':'&#951;',
    '&theta;':'&#952;','&iota;':'&#953;','&kappa;':'&#954;',
    '&lambda;':'&#955;','&mu;':'&#956;','&nu;':'&#957;',
    '&xi;':'&#958;','&omicron;':'&#959;','&pi;':'&#960;',
    '&rho;':'&#961;','&sigmaf;':'&#962;','&sigma;':'&#963;',
    '&tau;':'&#964;','&upsilon;':'&#965;','&phi;':'&#966;',
    '&chi;':'&#967;','&psi;':'&#968;','&omega;':'&#969;',
    '&thetasym;':'&#977;','&upsih;':'&#978;','&piv;':'&#982;',
    '&ensp;':'&#8194;','&emsp;':'&#8195;','&thinsp;':'&#8201;',
    '&zwnj;':'&#8204;','&zwj;':'&#8205;','&lrm;':'&#8206;',
    '&rlm;':'&#8207;','&ndash;':'&#8211;','&mdash;':'&#8212;',
    '&lsquo;':'&#8216;','&rsquo;':'&#8217;','&sbquo;':'&#8218;',
    '&ldquo;':'&#8220;','&rdquo;':'&#8221;','&bdquo;':'&#8222;',
    '&dagger;':'&#8224;','&Dagger;':'&#8225;','&bull;':'&#8226;',
    '&hellip;':'&#8230;','&permil;':'&#8240;','&prime;':'&#8242;',
    '&Prime;':'&#8243;','&lsaquo;':'&#8249;','&rsaquo;':'&#8250;',
    '&oline;':'&#8254;','&frasl;':'&#8260;','&euro;':'&#8364;',
    '&image;':'&#8465;','&weierp;':'&#8472;','&real;':'&#8476;',
    '&trade;':'&#8482;','&alefsym;':'&#8501;','&larr;':'&#8592;',
    '&uarr;':'&#8593;','&rarr;':'&#8594;','&darr;':'&#8595;',
    '&harr;':'&#8596;','&crarr;':'&#8629;','&lArr;':'&#8656;',
    '&uArr;':'&#8657;','&rArr;':'&#8658;','&dArr;':'&#8659;',
    '&hArr;':'&#8660;','&forall;':'&#8704;','&part;':'&#8706;',
    '&exist;':'&#8707;','&empty;':'&#8709;','&nabla;':'&#8711;',
    '&isin;':'&#8712;','&notin;':'&#8713;','&ni;':'&#8715;',
    '&prod;':'&#8719;','&sum;':'&#8721;','&minus;':'&#8722;',
    '&lowast;':'&#8727;','&radic;':'&#8730;','&prop;':'&#8733;',
    '&infin;':'&#8734;','&ang;':'&#8736;','&and;':'&#8743;',
    '&or;':'&#8744;','&cap;':'&#8745;','&cup;':'&#8746;',
    '&int;':'&#8747;','&there4;':'&#8756;','&sim;':'&#8764;',
    '&cong;':'&#8773;','&asymp;':'&#8776;','&ne;':'&#8800;',
    '&equiv;':'&#8801;','&le;':'&#8804;','&ge;':'&#8805;',
    '&sub;':'&#8834;','&sup;':'&#8835;','&nsub;':'&#8836;',
    '&sube;':'&#8838;','&supe;':'&#8839;','&oplus;':'&#8853;',
    '&otimes;':'&#8855;','&perp;':'&#8869;','&sdot;':'&#8901;',
    '&lceil;':'&#8968;','&rceil;':'&#8969;','&lfloor;':'&#8970;',
    '&rfloor;':'&#8971;','&lang;':'&#9001;','&rang;':'&#9002;',
    '&loz;':'&#9674;','&spades;':'&#9824;','&clubs;':'&#9827;',
    '&hearts;':'&#9829;','&diams;':'&#9830;'};

    this.block_tags = ["a", "abbr", "acronym", "address", "area", "b",
    "base", "bdo", "big", "blockquote", "body", "button",
    "caption", "cite", "code", "col", "colgroup", "dd", "del", "div",
    "dfn", "dl", "dt", "em", "fieldset", "form", "head", "h1", "h2",
    "h3", "h4", "h5", "h6", "html", "i", "ins",
    "kbd", "label", "legend", "li", "map", "noscript",
    "object", "ol", "optgroup", "option", "p", "param", "pre", "q",
    "samp", "script", "select", "small", "span", "strong", "style",
    "sub", "sup", "table", "tbody", "td", "textarea", "tfoot", "th",
    "thead", "title", "tr", "tt", "ul", "var", "extends"];


    this.inline_tags = ["br", "hr", "img", "input"];

    return this;
};

WYMeditor.XhtmlSaxListener.prototype.shouldCloseTagAutomatically = function(tag, now_on_tag, closing)
{
  var closing = closing || false;
  if(tag == 'td'){
    if((closing && now_on_tag == 'tr') || (!closing && now_on_tag == 'td')){
      return true;
    }
  }
  if(tag == 'option'){
    if((closing && now_on_tag == 'select') || (!closing && now_on_tag == 'option')){
      return true;
    }
  }
  return false;
};

WYMeditor.XhtmlSaxListener.prototype.beforeParsing = function(raw)
{
  this.output = '';
  return raw;
};

WYMeditor.XhtmlSaxListener.prototype.afterParsing = function(xhtml)
{
  xhtml = this.replaceNamedEntities(xhtml);
  xhtml = this.joinRepeatedEntities(xhtml);
  xhtml = this.removeEmptyTags(xhtml);
  xhtml = this.removeBrInPre(xhtml);
  return xhtml;
};

WYMeditor.XhtmlSaxListener.prototype.replaceNamedEntities = function(xhtml)
{
  for (var entity in this.entities) {
    xhtml = xhtml.replace(new RegExp(entity, 'g'), this.entities[entity]);
  }
  return xhtml;
};

WYMeditor.XhtmlSaxListener.prototype.joinRepeatedEntities = function(xhtml)
{
  var tags = 'em|strong|sub|sup|acronym|pre|del|address';
  return xhtml.replace(new RegExp('<\/('+tags+')><\\1>' ,''),'').
  replace(new RegExp('(\s*<('+tags+')>\s*){2}(.*)(\s*<\/\\2>\s*){2}' ,''),'<\$2>\$3<\$2>');
};

WYMeditor.XhtmlSaxListener.prototype.removeEmptyTags = function(xhtml)
{
  return xhtml.replace(new RegExp('<('+this.block_tags.join("|").replace(/\|td/,'').replace(/\|th/, '')+')>(<br \/>|&#160;|&nbsp;|\\s)*<\/\\1>' ,'g'),'');
};

WYMeditor.XhtmlSaxListener.prototype.removeBrInPre = function(xhtml)
{
  var matches = xhtml.match(new RegExp('<pre[^>]*>(.*?)<\/pre>','gmi'));
  if(matches) {
    for(var i=0; i<matches.length; i++) {
      xhtml = xhtml.replace(matches[i], matches[i].replace(new RegExp('<br \/>', 'g'), String.fromCharCode(13,10)));
    }
  }
  return xhtml;
};

WYMeditor.XhtmlSaxListener.prototype.getResult = function()
{
  return this.output;
};

WYMeditor.XhtmlSaxListener.prototype.getTagReplacements = function()
{
  return {'b':'strong', 'i':'em'};
};

WYMeditor.XhtmlSaxListener.prototype.addContent = function(text)
{
  this.output += text;
};

WYMeditor.XhtmlSaxListener.prototype.addComment = function(text)
{
  if(this.remove_comments){
    this.output += text;
  }
};

WYMeditor.XhtmlSaxListener.prototype.addScript = function(text)
{
  if(!this.remove_scripts){
    this.output += text;
  }
};

WYMeditor.XhtmlSaxListener.prototype.addCss = function(text)
{
  if(!this.remove_embeded_styles){
    this.output += text;
  }
};

WYMeditor.XhtmlSaxListener.prototype.openBlockTag = function(tag, attributes)
{
  this.output += this.helper.tag(tag, this.validator.getValidTagAttributes(tag, attributes), true);
};

WYMeditor.XhtmlSaxListener.prototype.inlineTag = function(tag, attributes)
{
  this.output += this.helper.tag(tag, this.validator.getValidTagAttributes(tag, attributes));
};

WYMeditor.XhtmlSaxListener.prototype.openUnknownTag = function(tag, attributes)
{
  //this.output += this.helper.tag(tag, attributes, true);
};

WYMeditor.XhtmlSaxListener.prototype.closeBlockTag = function(tag)
{
  this.output = this.output.replace(/<br \/>$/, '')+this._getClosingTagContent('before', tag)+"</"+tag+">"+this._getClosingTagContent('after', tag);
};

WYMeditor.XhtmlSaxListener.prototype.closeUnknownTag = function(tag)
{
  //this.output += "</"+tag+">";
};

WYMeditor.XhtmlSaxListener.prototype.closeUnopenedTag = function(tag)
{
  this.output += "</"+tag+">";
};

WYMeditor.XhtmlSaxListener.prototype.avoidStylingTagsAndAttributes = function()
{
  this.avoided_tags = ['div','span'];
  this.validator.skiped_attributes = ['style'];
  this.validator.skiped_attribute_values = ['MsoNormal','main1']; // MS Word attributes for class
  this._avoiding_tags_implicitly = true;
};

WYMeditor.XhtmlSaxListener.prototype.allowStylingTagsAndAttributes = function()
{
  this.avoided_tags = [];
  this.validator.skiped_attributes = [];
  this.validator.skiped_attribute_values = [];
  this._avoiding_tags_implicitly = false;
};

WYMeditor.XhtmlSaxListener.prototype.isBlockTag = function(tag)
{
  return !WYMeditor.Helper.contains(this.avoided_tags, tag) && WYMeditor.Helper.contains(this.block_tags, tag);
};

WYMeditor.XhtmlSaxListener.prototype.isInlineTag = function(tag)
{
  return !WYMeditor.Helper.contains(this.avoided_tags, tag) && WYMeditor.Helper.contains(this.inline_tags, tag);
};

WYMeditor.XhtmlSaxListener.prototype.insertContentAfterClosingTag = function(tag, content)
{
  this._insertContentWhenClosingTag('after', tag, content);
};

WYMeditor.XhtmlSaxListener.prototype.insertContentBeforeClosingTag = function(tag, content)
{
  this._insertContentWhenClosingTag('before', tag, content);
};

WYMeditor.XhtmlSaxListener.prototype.fixNestingBeforeOpeningBlockTag = function(tag, attributes)
{
    if(tag != 'li' && (tag == 'ul' || tag == 'ol') && this.last_tag && !this.last_tag_opened && this.last_tag == 'li'){
      this.output = this.output.replace(/<\/li>$/, '');
      this.insertContentAfterClosingTag(tag, '</li>');
    }
};

WYMeditor.XhtmlSaxListener.prototype._insertContentWhenClosingTag = function(position, tag, content)
{
  if(!this['_insert_'+position+'_closing']){
    this['_insert_'+position+'_closing'] = [];
  }
  if(!this['_insert_'+position+'_closing'][tag]){
    this['_insert_'+position+'_closing'][tag] = [];
  }
  this['_insert_'+position+'_closing'][tag].push(content);
};

WYMeditor.XhtmlSaxListener.prototype._getClosingTagContent = function(position, tag)
{
  if( this['_insert_'+position+'_closing'] &&
      this['_insert_'+position+'_closing'][tag] &&
      this['_insert_'+position+'_closing'][tag].length > 0){
        return this['_insert_'+position+'_closing'][tag].pop();
  }
  return '';
};


/********** CSS PARSER **********/


WYMeditor.WymCssLexer = function(parser, only_wym_blocks)
{
  var only_wym_blocks = (typeof only_wym_blocks == 'undefined' ? true : only_wym_blocks);

  jQuery.extend(this, new WYMeditor.Lexer(parser, (only_wym_blocks?'Ignore':'WymCss')));

  this.mapHandler('WymCss', 'Ignore');

  if(only_wym_blocks == true){
    this.addEntryPattern("/\\\x2a[<\\s]*WYMeditor[>\\s]*\\\x2a/", 'Ignore', 'WymCss');
    this.addExitPattern("/\\\x2a[<\/\\s]*WYMeditor[>\\s]*\\\x2a/", 'WymCss');
  }

  this.addSpecialPattern("[\\sa-z1-6]*\\\x2e[a-z-_0-9]+", 'WymCss', 'WymCssStyleDeclaration');

  this.addEntryPattern("/\\\x2a", 'WymCss', 'WymCssComment');
  this.addExitPattern("\\\x2a/", 'WymCssComment');

  this.addEntryPattern("\x7b", 'WymCss', 'WymCssStyle');
  this.addExitPattern("\x7d", 'WymCssStyle');

  this.addEntryPattern("/\\\x2a", 'WymCssStyle', 'WymCssFeedbackStyle');
  this.addExitPattern("\\\x2a/", 'WymCssFeedbackStyle');

  return this;
};

WYMeditor.WymCssParser = function()
{
  this._in_style = false;
  this._has_title = false;
  this.only_wym_blocks = true;
  this.css_settings = {'classesItems':[], 'editorStyles':[], 'dialogStyles':[]};
  return this;
};

WYMeditor.WymCssParser.prototype.parse = function(raw, only_wym_blocks)
{
  var only_wym_blocks = (typeof only_wym_blocks == 'undefined' ? this.only_wym_blocks : only_wym_blocks);
  this._Lexer = new WYMeditor.WymCssLexer(this, only_wym_blocks);
  this._Lexer.parse(raw);
};

WYMeditor.WymCssParser.prototype.Ignore = function(match, state)
{
  return true;
};

WYMeditor.WymCssParser.prototype.WymCssComment = function(text, status)
{
  if(text.match(/end[a-z0-9\s]*wym[a-z0-9\s]*/mi)){
    return false;
  }
  if(status == WYMeditor.LEXER_UNMATCHED){
    if(!this._in_style){
      this._has_title = true;
      this._current_item = {'title':WYMeditor.Helper.trim(text)};
    }else{
      if(this._current_item[this._current_element]){
        if(!this._current_item[this._current_element].expressions){
          this._current_item[this._current_element].expressions = [text];
        }else{
          this._current_item[this._current_element].expressions.push(text);
        }
      }
    }
    this._in_style = true;
  }
  return true;
};

WYMeditor.WymCssParser.prototype.WymCssStyle = function(match, status)
{
  if(status == WYMeditor.LEXER_UNMATCHED){
    match = WYMeditor.Helper.trim(match);
    if(match != ''){
      this._current_item[this._current_element].style = match;
    }
  }else if (status == WYMeditor.LEXER_EXIT){
    this._in_style = false;
    this._has_title = false;
    this.addStyleSetting(this._current_item);
  }
  return true;
};

WYMeditor.WymCssParser.prototype.WymCssFeedbackStyle = function(match, status)
{
  if(status == WYMeditor.LEXER_UNMATCHED){
    this._current_item[this._current_element].feedback_style = match.replace(/^([\s\/\*]*)|([\s\/\*]*)$/gm,'');
  }
  return true;
};

WYMeditor.WymCssParser.prototype.WymCssStyleDeclaration = function(match)
{
  match = match.replace(/^([\s\.]*)|([\s\.*]*)$/gm, '');

  var tag = '';
  if(match.indexOf('.') > 0){
    var parts = match.split('.');
    this._current_element = parts[1];
    var tag = parts[0];
  }else{
    this._current_element = match;
  }

  if(!this._has_title){
    this._current_item = {'title':(!tag?'':tag.toUpperCase()+': ')+this._current_element};
    this._has_title = true;
  }

  if(!this._current_item[this._current_element]){
    this._current_item[this._current_element] = {'name':this._current_element};
  }
  if(tag){
    if(!this._current_item[this._current_element].tags){
      this._current_item[this._current_element].tags = [tag];
    }else{
      this._current_item[this._current_element].tags.push(tag);
    }
  }
  return true;
};

WYMeditor.WymCssParser.prototype.addStyleSetting = function(style_details)
{
  for (var name in style_details){
    var details = style_details[name];
    if(typeof details == 'object' && name != 'title'){

      this.css_settings.classesItems.push({
        'name': WYMeditor.Helper.trim(details.name),
        'title': style_details.title,
        'expr' : WYMeditor.Helper.trim((details.expressions||details.tags).join(', '))
      });
      if(details.feedback_style){
        this.css_settings.editorStyles.push({
          'name': '.'+ WYMeditor.Helper.trim(details.name),
          'css': details.feedback_style
        });
      }
      if(details.style){
        this.css_settings.dialogStyles.push({
          'name': '.'+ WYMeditor.Helper.trim(details.name),
          'css': details.style
        });
      }
    }
  }
};

/********** HELPERS **********/

jQuery.fn.isPhantomNode = function() {
  if (this[0].nodeType == 3)
    return !(/[^\t\n\r ]/.test(this[0].data));

  return false;
};

WYMeditor.isPhantomNode = function(n) {
  if (n.nodeType == 3)
    return !(/[^\t\n\r ]/.test(n.data));

  return false;
};

WYMeditor.isPhantomString = function(str) {
    return !(/[^\t\n\r ]/.test(str));
};

jQuery.fn.parentsOrSelf = function(jqexpr) {
  var n = this;

  if (n[0].nodeType == 3)
    n = n.parents().slice(0,1);

  if (n.filter(jqexpr).size() == 1)
    return n;
  else
    return n.parents(jqexpr).slice(0,1);
};


WYMeditor.Helper = {

    //replace all instances of 'old' by 'rep' in 'str' string
    replaceAll: function(str, old, rep) {
        var rExp = new RegExp(old, "g");
        return(str.replace(rExp, rep));
    },

    //insert 'inserted' at position 'pos' in 'str' string
    insertAt: function(str, inserted, pos) {
        return(str.substr(0,pos) + inserted + str.substring(pos));
    },

    //trim 'str' string
    trim: function(str) {
        return str.replace(/^(\s*)|(\s*)$/gm,'');
    },

    //return true if 'arr' array contains 'elem', or false
    contains: function(arr, elem) {
        for (var i = 0; i < arr.length; i++) {
            if (arr[i] === elem) return true;
        }
        return false;
    },

    //return 'item' position in 'arr' array, or -1
    indexOf: function(arr, item) {
        var ret=-1;
        for(var i = 0; i < arr.length; i++) {
            if (arr[i] == item) {
                ret = i;
                break;
            }
        }
	    return(ret);
    },

    //return 'item' object in 'arr' array, checking its 'name' property, or null
    findByName: function(arr, name) {
        for(var i = 0; i < arr.length; i++) {
            var item = arr[i];
            if(item.name == name) return(item);
        }
        return(null);
    }
};


/*
 * WYMeditor : what you see is What You Mean web-based editor
 * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/
 * Dual licensed under the MIT (MIT-license.txt)
 * and GPL (GPL-license.txt) licenses.
 *
 * For further information visit:
 *        http://www.wymeditor.org/
 *
 * File Name:
 *        jquery.wymeditor.explorer.js
 *        MSIE specific class and functions.
 *        See the documentation for more info.
 *
 * File Authors:
 *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)
 *        Bermi Ferrer (wymeditor a-t bermi dotorg)
 *        Frdric Palluel-Lafleur (fpalluel a-t gmail dotcom)
 *        Jonatan Lundin (jonatan.lundin a-t gmail dotcom)
 */

WYMeditor.WymClassExplorer = function(wym) {

    this._wym = wym;
    this._class = "className";
    this._newLine = "\r\n";

};

WYMeditor.WymClassExplorer.prototype.initIframe = function(iframe) {

    //This function is executed twice, though it is called once!
    //But MSIE needs that, otherwise designMode won't work.
    //Weird.
    
    this._iframe = iframe;
    this._doc = iframe.contentWindow.document;
    
    //add css rules from options
    var styles = this._doc.styleSheets[0];
    var aCss = eval(this._options.editorStyles);

    this.addCssRules(this._doc, aCss);

    this._doc.title = this._wym._index;

    //set the text direction
    jQuery('html', this._doc).attr('dir', this._options.direction);
    
    //init html value
    jQuery(this._doc.body).html(this._wym._html);
    
    //handle events
    var wym = this;
    
    this._doc.body.onfocus = function()
      {wym._doc.designMode = "on"; wym._doc = iframe.contentWindow.document;};
    this._doc.onbeforedeactivate = function() {wym.saveCaret();};
    this._doc.onkeyup = function() {
      wym.saveCaret();
      wym.keyup();
    };
    this._doc.onclick = function() {wym.saveCaret();};
    
    this._doc.body.onbeforepaste = function() {
      wym._iframe.contentWindow.event.returnValue = false;
    };
    
    this._doc.body.onpaste = function() {
      wym._iframe.contentWindow.event.returnValue = false;
      wym.paste(window.clipboardData.getData("Text"));
    };
    
    //callback can't be executed twice, so we check
    if(this._initialized) {
      
      //pre-bind functions
      if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);
      
      //bind external events
      this._wym.bindEvents();
      
      //post-init functions
      if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);
      
      //add event listeners to doc elements, e.g. images
      this.listen();
    }
    
    this._initialized = true;
    
    //init designMode
    this._doc.designMode="on";
    try{
        // (bermi's note) noticed when running unit tests on IE6
        // Is this really needed, it trigger an unexisting property on IE6
        this._doc = iframe.contentWindow.document; 
    }catch(e){}
};

WYMeditor.WymClassExplorer.prototype._exec = function(cmd,param) {

    switch(cmd) {
    
    case WYMeditor.INDENT: case WYMeditor.OUTDENT:
    
        var container = this.findUp(this.container(), WYMeditor.LI);
        if(container) {
            var ancestor = container.parentNode.parentNode;
            if(container.parentNode.childNodes.length>1
              || ancestor.tagName.toLowerCase() == WYMeditor.OL
              || ancestor.tagName.toLowerCase() == WYMeditor.UL)
              this._doc.execCommand(cmd);
        }
    break;
    default:
        if(param) this._doc.execCommand(cmd,false,param);
        else this._doc.execCommand(cmd);
    break;
	}

};

WYMeditor.WymClassExplorer.prototype.selected = function() {

    var caretPos = this._iframe.contentWindow.document.caretPos;
        if(caretPos!=null) {
            if(caretPos.parentElement!=undefined)
              return(caretPos.parentElement());
        }
};

WYMeditor.WymClassExplorer.prototype.saveCaret = function() {

    this._doc.caretPos = this._doc.selection.createRange();
};

WYMeditor.WymClassExplorer.prototype.addCssRule = function(styles, oCss) {

    styles.addRule(oCss.name, oCss.css);
};

WYMeditor.WymClassExplorer.prototype.insert = function(html) {

    // Get the current selection
    var range = this._doc.selection.createRange();

    // Check if the current selection is inside the editor
    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {
        try {
            // Overwrite selection with provided html
            range.pasteHTML(html);
        } catch (e) { }
    } else {
        // Fall back to the internal paste function if there's no selection
        this.paste(html);
    }
};

WYMeditor.WymClassExplorer.prototype.wrap = function(left, right) {

    // Get the current selection
    var range = this._doc.selection.createRange();

    // Check if the current selection is inside the editor
    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {
        try {
            // Overwrite selection with provided html
            range.pasteHTML(left + range.text + right);
        } catch (e) { }
    }
};

WYMeditor.WymClassExplorer.prototype.unwrap = function() {

    // Get the current selection
    var range = this._doc.selection.createRange();

    // Check if the current selection is inside the editor
    if ( jQuery(range.parentElement()).parents( this._options.iframeBodySelector ).is('*') ) {
        try {
            // Unwrap selection
            var text = range.text;
            this._exec( 'Cut' );
            range.pasteHTML( text );
        } catch (e) { }
    }
};

WYMeditor.WymClassExplorer.prototype.keyup = function() {
  this._selected_image = null;
};

WYMeditor.WymClassExplorer.prototype.setFocusToNode = function(node, toStart) {
    var range = this._doc.selection.createRange();
    toStart = toStart ? true : false;
    
    range.moveToElementText(node);
    range.collapse(toStart);
    range.select();
    node.focus();
};

/*
 * WYMeditor : what you see is What You Mean web-based editor
 * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/
 * Dual licensed under the MIT (MIT-license.txt)
 * and GPL (GPL-license.txt) licenses.
 *
 * For further information visit:
 *        http://www.wymeditor.org/
 *
 * File Name:
 *        jquery.wymeditor.mozilla.js
 *        Gecko specific class and functions.
 *        See the documentation for more info.
 *
 * File Authors:
 *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)
 *        Volker Mische (vmx a-t gmx dotde)
 *        Bermi Ferrer (wymeditor a-t bermi dotorg)
 *        Frdric Palluel-Lafleur (fpalluel a-t gmail dotcom)
 *        Jonatan Lundin (jonatan.lundin a-t gmail dotcom)
 */

WYMeditor.WymClassMozilla = function(wym) {

    this._wym = wym;
    this._class = "class";
    this._newLine = "\n";
};

WYMeditor.WymClassMozilla.prototype.initIframe = function(iframe) {
    var wym = this;
    
    this._iframe = iframe;
    this._doc = iframe.contentDocument;
    
    //add css rules from options
    
    var styles = this._doc.styleSheets[0];    
    var aCss = eval(this._options.editorStyles);
    
    this.addCssRules(this._doc, aCss);

    this._doc.title = this._wym._index;

    //set the text direction
    jQuery('html', this._doc).attr('dir', this._options.direction);
    
    //init html value
    this.html(this._wym._html);
    
    //init designMode
    this.enableDesignMode();
    
    //pre-bind functions
    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);
    
    //bind external events
    this._wym.bindEvents();
    
    //bind editor keydown events
    //jQuery(this._doc).bind("keydown", this.keydown);
    jQuery(this._doc).bind("keypress", this.keydown);   // works better with Hebrew keyboard layout
    
    //bind editor keyup events
    jQuery(this._doc).bind("keyup", this.keyup);
    
    //bind editor focus events (used to reset designmode - Gecko bug)
    jQuery(this._doc).bind("focus", function () { 
        // Fix scope
        wym.enableDesignMode.call(wym);
    });
    
    //post-init functions
    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);
    
    //add event listeners to doc elements, e.g. images
    this.listen();
};

/* @name html
 * @description Get/Set the html value
 */
WYMeditor.WymClassMozilla.prototype.html = function(html) {

  if(typeof html === 'string') {
  
    //disable designMode
    try { this._doc.designMode = "off"; } catch(e) { };
    
    //replace em by i and strong by bold
    //(designMode issue)
    html = html.replace(/<em(\b[^>]*)>/gi, "<i$1>")
      .replace(/<\/em>/gi, "</i>")
      .replace(/<strong(\b[^>]*)>/gi, "<b$1>")
      .replace(/<\/strong>/gi, "</b>");

    //update the html body
    jQuery(this._doc.body).html(html);
    
    //re-init designMode
    this.enableDesignMode();
  }
  else return(jQuery(this._doc.body).html());
};

WYMeditor.WymClassMozilla.prototype._exec = function(cmd,param) {

    if(!this.selected()) return(false);

    switch(cmd) {
    
    case WYMeditor.INDENT: case WYMeditor.OUTDENT:
    
        var focusNode = this.selected();    
        var sel = this._iframe.contentWindow.getSelection();
        var anchorNode = sel.anchorNode;
        if(anchorNode.nodeName == "#text") anchorNode = anchorNode.parentNode;
        
        focusNode = this.findUp(focusNode, WYMeditor.BLOCKS);
        anchorNode = this.findUp(anchorNode, WYMeditor.BLOCKS);
        
        if(focusNode && focusNode == anchorNode
          && focusNode.tagName.toLowerCase() == WYMeditor.LI) {

            var ancestor = focusNode.parentNode.parentNode;

            if(focusNode.parentNode.childNodes.length>1
              || ancestor.tagName.toLowerCase() == WYMeditor.OL
              || ancestor.tagName.toLowerCase() == WYMeditor.UL)
                this._doc.execCommand(cmd,'',null);
        }

    break;
    
    default:

        if(param) this._doc.execCommand(cmd,'',param);
        else this._doc.execCommand(cmd,'',null);
    }
    
    //set to P if parent = BODY
    var container = this.selected();
    if(container.tagName.toLowerCase() == WYMeditor.BODY)
        this._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);
};

/* @name selected
 * @description Returns the selected container
 */
WYMeditor.WymClassMozilla.prototype.selected = function() {

    var sel = this._iframe.contentWindow.getSelection();
    var node = sel.focusNode;
    if(node) {
        if(node.nodeName == "#text") return(node.parentNode);
        else return(node);
    } else return(null);
};

WYMeditor.WymClassMozilla.prototype.addCssRule = function(styles, oCss) {

    styles.insertRule(oCss.name + " {" + oCss.css + "}",
        styles.cssRules.length);
};


WYMeditor.WymClassMozilla.prototype.keydown = function(evt) {

  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  var container = null;  
	var keycode = evt.which;
	if (keycode>=97)
		keycode -= 32;  // convert to upper case
  //alert(evt.type);
  if(evt.ctrlKey){
    if(keycode == 66){
      //CTRL+b => STRONG
			evt.preventDefault();
      wym._exec(WYMeditor.BOLD);
      return false;
    }
    if(keycode == 68){
      //CTRL+d => advanced class
      wym.toggleClassByName("advanced");
      return false;
    }
    if(keycode == 70){
      //CTRL+f => future class
      wym.toggleClassByName("future");
      return false;
    }
    if(keycode == 73){
      //CTRL+i => EMPHASIS
      wym._exec(WYMeditor.ITALIC);
      return false;
    }
    if(keycode == 80){
      //CTRL+p => Parshanim
      wym.toggleClassByName("mfrj");
      return false;
    }
    if(keycode == 81 || keycode==47){
      //CTRL+q => Quote psuq
      wym.toggleClassByName("psuq");
      return false;
    }
    if(keycode == 83){
      //CTRL+s => Small
      wym.toggleClassByName("small");
      return false;
    }
    if(keycode == 85){
      //CTRL+U => Underline
      wym.toggleClassByName("u");
      return false;
    }
  }

  else if(evt.keyCode == 13) {
    if(!evt.shiftKey){
      //fix PRE bug #73
      container = wym.selected();
      if(container && container.tagName.toLowerCase() == WYMeditor.PRE) {
        evt.preventDefault();
        wym.insert('<p></p>');
      }
    }
  }
};


WYMeditor.WymClassMozilla.prototype.keyup = function(evt) {

  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  
  wym._selected_image = null;
  var container = null;

  if(evt.keyCode == 13 && !evt.shiftKey) {
  
    //RETURN key
    //cleanup <br><br> between paragraphs
    jQuery(wym._doc.body).children(WYMeditor.BR).remove();
  }
  
  if(evt.keyCode != 8
       && evt.keyCode != 17
       && evt.keyCode != 46
       && evt.keyCode != 224
       && !evt.metaKey
       && !evt.ctrlKey) {
      
    //NOT BACKSPACE, NOT DELETE, NOT CTRL, NOT COMMAND
    //text nodes replaced by P
    
    container = wym.selected();
    var name = container.tagName.toLowerCase();

    //fix forbidden main containers
    if(
      name == "strong" ||
      name == "b" ||
      name == "em" ||
      name == "i" ||
      name == "sub" ||
      name == "sup" ||
      name == "a"

    ) name = container.parentNode.tagName.toLowerCase();

    if(name == WYMeditor.BODY) wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);
  }
};

WYMeditor.WymClassMozilla.prototype.enableDesignMode = function() {
    if(this._doc.designMode == "off") {
      try {
        this._doc.designMode = "on";
        this._doc.execCommand("styleWithCSS", '', false);
      } catch(e) { }
    }
};

WYMeditor.WymClassMozilla.prototype.openBlockTag = function(tag, attributes)
{
  var attributes = this.validator.getValidTagAttributes(tag, attributes);

  // Handle Mozilla styled spans
  if(tag == 'span' && attributes.style){
    var new_tag = this.getTagForStyle(attributes.style);
    if(new_tag){
      this._tag_stack.pop();
      var tag = new_tag;
      this._tag_stack.push(new_tag);
      attributes.style = '';
    }else{
      return;
    }
  }
  
  this.output += this.helper.tag(tag, attributes, true);
};

WYMeditor.WymClassMozilla.prototype.getTagForStyle = function(style) {

  if(/bold/.test(style)) return 'strong';
  if(/italic/.test(style)) return 'em';
  if(/sub/.test(style)) return 'sub';
  if(/super/.test(style)) return 'sup';
  return false;
};

/*
 * WYMeditor : what you see is What You Mean web-based editor
 * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/
 * Dual licensed under the MIT (MIT-license.txt)
 * and GPL (GPL-license.txt) licenses.
 *
 * For further information visit:
 *        http://www.wymeditor.org/
 *
 * File Name:
 *        jquery.wymeditor.opera.js
 *        Opera specific class and functions.
 *        See the documentation for more info.
 *
 * File Authors:
 *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)
 */

WYMeditor.WymClassOpera = function(wym) {

    this._wym = wym;
    this._class = "class";
    this._newLine = "\r\n";
};

WYMeditor.WymClassOpera.prototype.initIframe = function(iframe) {

    this._iframe = iframe;
    this._doc = iframe.contentWindow.document;
    
    //add css rules from options
    var styles = this._doc.styleSheets[0];    
    var aCss = eval(this._options.editorStyles);

    this.addCssRules(this._doc, aCss);

    this._doc.title = this._wym._index;

    //set the text direction
    jQuery('html', this._doc).attr('dir', this._options.direction);
    
    //init designMode
    this._doc.designMode = "on";

    //init html value
    this.html(this._wym._html);
    
    //pre-bind functions
    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);
    
    //bind external events
    this._wym.bindEvents();
    
    //bind editor keydown events
    jQuery(this._doc).bind("keydown", this.keydown);

    //bind editor events
    jQuery(this._doc).bind("keyup", this.keyup);
    
    //post-init functions
    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);
    
    //add event listeners to doc elements, e.g. images
    this.listen();
};

WYMeditor.WymClassOpera.prototype._exec = function(cmd,param) {

    if(param) this._doc.execCommand(cmd,false,param);
    else this._doc.execCommand(cmd);

};

WYMeditor.WymClassOpera.prototype.selected = function() {

    var sel=this._iframe.contentWindow.getSelection();
    var node=sel.focusNode;
    if(node) {
        if(node.nodeName=="#text")return(node.parentNode);
        else return(node);
    } else return(null);
};

WYMeditor.WymClassOpera.prototype.addCssRule = function(styles, oCss) {

    styles.insertRule(oCss.name + " {" + oCss.css + "}",
        styles.cssRules.length);
};


var xTriggered = 0;

WYMeditor.WymClassOpera.prototype.keydown = function(evt) {
  
  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  var sel = wym._iframe.contentWindow.getSelection();
  startNode = sel.getRangeAt(0).startContainer;

  //Get a P instead of no container
  if(!jQuery(startNode).parentsOrSelf(
                WYMeditor.MAIN_CONTAINERS.join(","))[0]
      && !jQuery(startNode).parentsOrSelf('li')
      && evt.keyCode != WYMeditor.KEY.ENTER
      && evt.keyCode != WYMeditor.KEY.LEFT
      && evt.keyCode != WYMeditor.KEY.UP
      && evt.keyCode != WYMeditor.KEY.RIGHT
      && evt.keyCode != WYMeditor.KEY.DOWN
      && evt.keyCode != WYMeditor.KEY.BACKSPACE
      && evt.keyCode != WYMeditor.KEY.DELETE)
      wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);

};

WYMeditor.WymClassOpera.prototype.keyup = function(evt) {

  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  wym._selected_image = null;
};
/*
 * WYMeditor : what you see is What You Mean web-based editor
 * Copyright (c) 2005 - 2009 Jean-Francois Hovinne, http://www.wymeditor.org/
 * Dual licensed under the MIT (MIT-license.txt)
 * and GPL (GPL-license.txt) licenses.
 *
 * For further information visit:
 *        http://www.wymeditor.org/
 *
 * File Name:
 *        jquery.wymeditor.safari.js
 *        Safari specific class and functions.
 *        See the documentation for more info.
 *
 * File Authors:
 *        Jean-Francois Hovinne (jf.hovinne a-t wymeditor dotorg)
 *        Scott Lewis (lewiscot a-t gmail dotcom)
 */

WYMeditor.WymClassSafari = function(wym) {

    this._wym = wym;
    this._class = "class";
    this._newLine = "\n";
};

WYMeditor.WymClassSafari.prototype.initIframe = function(iframe) {

    this._iframe = iframe;
    this._doc = iframe.contentDocument;
    
    //add css rules from options
    
    var styles = this._doc.styleSheets[0];    
    var aCss = eval(this._options.editorStyles);
    
    this.addCssRules(this._doc, aCss);

    this._doc.title = this._wym._index;

    //set the text direction
    jQuery('html', this._doc).attr('dir', this._options.direction);

    //init designMode
    this._doc.designMode = "on";
    
    //init html value
    this.html(this._wym._html);
    
    //pre-bind functions
    if(jQuery.isFunction(this._options.preBind)) this._options.preBind(this);
    
    //bind external events
    this._wym.bindEvents();
    
    //bind editor keydown events
    jQuery(this._doc).bind("keydown", this.keydown);
    
    //bind editor keyup events
    jQuery(this._doc).bind("keyup", this.keyup);
    
    //post-init functions
    if(jQuery.isFunction(this._options.postInit)) this._options.postInit(this);
    
    //add event listeners to doc elements, e.g. images
    this.listen();
};

WYMeditor.WymClassSafari.prototype._exec = function(cmd,param) {

    if(!this.selected()) return(false);

    switch(cmd) {
    
    case WYMeditor.INDENT: case WYMeditor.OUTDENT:
    
        var focusNode = this.selected();    
        var sel = this._iframe.contentWindow.getSelection();
        var anchorNode = sel.anchorNode;
        if(anchorNode.nodeName == "#text") anchorNode = anchorNode.parentNode;
        
        focusNode = this.findUp(focusNode, WYMeditor.BLOCKS);
        anchorNode = this.findUp(anchorNode, WYMeditor.BLOCKS);
        
        if(focusNode && focusNode == anchorNode
          && focusNode.tagName.toLowerCase() == WYMeditor.LI) {

            var ancestor = focusNode.parentNode.parentNode;

            if(focusNode.parentNode.childNodes.length>1
              || ancestor.tagName.toLowerCase() == WYMeditor.OL
              || ancestor.tagName.toLowerCase() == WYMeditor.UL)
                this._doc.execCommand(cmd,'',null);
        }

    break;

    case WYMeditor.INSERT_ORDEREDLIST: case WYMeditor.INSERT_UNORDEREDLIST:

        this._doc.execCommand(cmd,'',null);

        //Safari creates lists in e.g. paragraphs.
        //Find the container, and remove it.
        var focusNode = this.selected();
        var container = this.findUp(focusNode, WYMeditor.MAIN_CONTAINERS);
        if(container) jQuery(container).replaceWith(jQuery(container).html());

    break;
    
    default:

        if(param) this._doc.execCommand(cmd,'',param);
        else this._doc.execCommand(cmd,'',null);
    }
    
    //set to P if parent = BODY
    var container = this.selected();
    if(container && container.tagName.toLowerCase() == WYMeditor.BODY)
        this._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P);

};

/* @name selected
 * @description Returns the selected container
 */
WYMeditor.WymClassSafari.prototype.selected = function() {

    var sel = this._iframe.contentWindow.getSelection();
    var node = sel.focusNode;
    if(node) {
        if(node.nodeName == "#text") return(node.parentNode);
        else return(node);
    } else return(null);
};

WYMeditor.WymClassSafari.prototype.addCssRule = function(styles, oCss) {

    styles.insertRule(oCss.name + " {" + oCss.css + "}",
        styles.cssRules.length);
};


WYMeditor.WymClassSafari.prototype.keydown = function(evt) {
  
  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  
  if(evt.ctrlKey){
    if(evt.keyCode == 66){
      //CTRL+b => STRONG
      wym._exec(WYMeditor.BOLD);
      return false;
    }
    if(evt.keyCode == 73){
      //CTRL+i => EMPHASIS
      wym._exec(WYMeditor.ITALIC);
      return false;
    }
  }
};

WYMeditor.WymClassSafari.prototype.keyup = function(evt) {

  //'this' is the doc
  var wym = WYMeditor.INSTANCES[this.title];
  
  wym._selected_image = null;
  var container = null;

  if(evt.keyCode == 13 && !evt.shiftKey) {
  
    //RETURN key
    //cleanup <br><br> between paragraphs
    jQuery(wym._doc.body).children(WYMeditor.BR).remove();
    
    //fix PRE bug #73
    container = wym.selected();
    if(container && container.tagName.toLowerCase() == WYMeditor.PRE)
        wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P); //create P after PRE
  }

  //fix #112
  if(evt.keyCode == 13 && evt.shiftKey) {
    wym._exec('InsertLineBreak');
  }
  
  if(evt.keyCode != 8
       && evt.keyCode != 17
       && evt.keyCode != 46
       && evt.keyCode != 224
       && !evt.metaKey
       && !evt.ctrlKey) {
      
    //NOT BACKSPACE, NOT DELETE, NOT CTRL, NOT COMMAND
    //text nodes replaced by P
    
    container = wym.selected();
    var name = container.tagName.toLowerCase();

    //fix forbidden main containers
    if(
      name == "strong" ||
      name == "b" ||
      name == "em" ||
      name == "i" ||
      name == "sub" ||
      name == "sup" ||
      name == "a" ||
      name == "span" //fix #110

    ) name = container.parentNode.tagName.toLowerCase();

    if(name == WYMeditor.BODY || name == WYMeditor.DIV) wym._exec(WYMeditor.FORMAT_BLOCK, WYMeditor.P); //fix #110 for DIV
  }
};

WYMeditor.WymClassSafari.prototype.openBlockTag = function(tag, attributes)
{
  var attributes = this.validator.getValidTagAttributes(tag, attributes);

  // Handle Safari styled spans
  if(tag == 'span' && attributes.style) {
    var new_tag = this.getTagForStyle(attributes.style);
    if(new_tag){
      this._tag_stack.pop();
      var tag = new_tag;
      this._tag_stack.push(new_tag);
      attributes.style = '';
      
      //should fix #125 - also removed the xhtml() override
      if(typeof attributes['class'] == 'string')
        attributes['class'] = attributes['class'].replace(/apple-style-span/gi, '');
    
    } else {
      return;
    }
  }
  
  this.output += this.helper.tag(tag, attributes, true);
};

WYMeditor.WymClassSafari.prototype.getTagForStyle = function(style) {

  if(/bold/.test(style)) return 'strong';
  if(/italic/.test(style)) return 'em';
  if(/sub/.test(style)) return 'sub';
  if(/super/.test(style)) return 'sup';
  return false;
};


/* _script/vars0 */

var path_from_root_to_document;
if (document.getElementsByName) {
	theArray = document.getElementsByName('jmQovc');
	path_from_root_to_document = theArray[0].content;
}
else if (document.all)
	path_from_root_to_document = document.all.jmQovc.content;
else
	path_from_root_to_document = window.location.href.replace(/^.*:\/\/\/?[^\/]*\/(.*)[.][^.]*$/, "$1");

var relative_depth=0;
for (i=0; i<path_from_root_to_document.length; ++i)
	if (path_from_root_to_document.charAt(i)=='/') relative_depth++;

var path_from_document_to_root = '';
for (i=0; i<relative_depth; ++i)
	path_from_document_to_root += '../';
/*
/_script/combine_js.php?files=_script/jquery-1.3.1.min+_script/jquery.hoverIntent.min+_script/vars0+_script/cookies+_script/rtelang/en+_script/rte+_script/elements+_script/form_validation+_script/fields+_script/arguments+_script/sites+_script/dates/dates+_script/templates+_script/magrim+http://www.google.com/friendconnect/script/friendconnect.js+_script/search+_script/etc+_script/jquery.taconite&out=_script/vars&minify=1
*/


/* _script/cookies */


/* arguments:
   name - name of the cookie
   value - value of the cookie
   [expirationDays] - expiration date of the cookie, in days from today
     (defaults to end of current session)
   [path] - path for which the cookie is valid
     (defaults to path of calling document)
   [domain] - domain for which the cookie is valid
     (defaults to domain of calling document)
   [secure] - Boolean value indicating if the cookie transmission requires
     a secure transmission
   * an argument defaults when it is assigned null as a placeholder
   * a null placeholder is not required for trailing omitted arguments
*/

function setCookie(name, value, expirationDays, path, domain, secure) {
  var expires = null;
  if (expirationDays) {
     // create an instance of the Date object
     expires = new Date();
     // fix the bug in Navigator 2.0, Macintosh
     fixDate(expires);
     expires.setTime(expires.getTime() + expirationDays * 24 * 60 * 60 * 1000);
  }
  var curCookie = name + "=" + escape(value) +
      ((expires) ? "; expires=" + expires.toGMTString() : "") +
      ((path) ? "; path=" + path : "") +
      ((domain) ? "; domain=" + domain : "") +
      ((secure) ? "; secure" : "");
  document.cookie = curCookie;
}


/*
  name - name of the desired cookie
  return string containing value of specified cookie or ""
  if cookie does not exist
*/

function getCookie(name) {
  var dc = document.cookie;
  var prefix = name + "=";
  var begin = dc.indexOf("; " + prefix);
  if (begin == -1) {
    begin = dc.indexOf(prefix);
    if (begin != 0) return "";       // instead of null
  } else
    begin += 2;
  var end = document.cookie.indexOf(";", begin);
  if (end == -1)
    end = dc.length;
  return unescape(dc.substring(begin + prefix.length, end));
}


/*
   name - name of the cookie
   [path] - path of the cookie (must be same as path used to create cookie)
   [domain] - domain of the cookie (must be same as domain used to
     create cookie)
   path and domain default if assigned null or omitted if no explicit
     argument proceeds
*/

function deleteCookie(name, path, domain) {
  if (getCookie(name)) {
    document.cookie = name + "=" +
    ((path) ? "; path=" + path : "") +
    ((domain) ? "; domain=" + domain : "") +
    "; expires=Thu, 01-Jan-70 00:00:01 GMT";
  }
}


function fixDate(date) {
  var base = new Date(0);
  var skew = base.getTime();
  if (skew > 0)
    date.setTime(date.getTime() - skew);
}




/* _script/elements */




function isAlien(a) {
   return isObject(a) && typeof a.constructor != 'function';
}

function isArray(a) {
    return isObject(a) && a.constructor == Array;
}

function isBoolean(a) {
    return typeof a == 'boolean';
}

function isEmpty(o) {
    var i, v;
    if (isObject(o)) {
        for (i in o) {
            v = o[i];
            if (isUndefined(v) && isFunction(v)) {
                return false;
            }
        }
    }
    return true;
}

function isFunction(a) {
    return typeof a == 'function';
}

function isNull(a) {
    return typeof a == 'object' && !a;
}

function isNumber(a) {
    return typeof a == 'number' && isFinite(a);
}

function isObject(a) {
    return (a && typeof a == 'object') || isFunction(a);
}

function isString(a) {
    return typeof a == 'string';
}

function isUndefined(a) {
    return typeof a == 'undefined';
} 



function getFirstElementNamed(theName) {
	theArray = document.getElementsByName(theName);
	if (theArray.length>0)
		return theArray[0].content;
	else
		return null;
}

function getElement(obj) {
	if (isString(obj))
		return document.getElementById(obj);
	else
		return obj;
}


function mark(obj) {	getElement(obj).style.color='green'}
function unmark(obj) {	getElement(obj).style.color=''}



function setdisplay(obj, value) {
	var e = getElement(obj);
	if (!e)
		throw('cant setdisplay of '+obj+' to '+value);
	if (!e.style)  // no style - can't change it
		return;

	if (value=='switch')
		value = (e.style.display=='none'? '': 'none');
	e.style.display = value;
}
function show(obj) {setdisplay(obj,'');}
function hide(obj) {setdisplay(obj,'none');}
function showorhide(obj, value) {
	if (arguments.length==1)
		setdisplay(obj,'switch');
	else if (value)
		setdisplay(obj,'');
	else
		setdisplay(obj,'nonw');
}


function setdisplayGroup(elements, display) {
	for (var i=0; i<elements.length; ++i)
		setdisplay(elements[i], display);
}
function showGroup(n) {setdisplayGroup(n,'')};
function hideGroup(n) {setdisplayGroup(n,'none')};
function showorhideGroup(n) {setdisplayGroup(n,'switch')};


function setdisplayByClass(c, display) {
	var alltags = document.all? document.all: document.getElementsByTagName('*');
	for (i in alltags) {
		obj = alltags[i];
		if (obj.className == c) {
			//alert("setting display of obj");
			setdisplay(obj, display);
		}
	}
}
function showByClass(c) {setdisplayByClass(c,'')};
function hideByClass(c) {setdisplayByClass(c,'none')};
function showorhideByClass(c) {setdisplayByClass(c,'switch')};


function setdisplaySiblings(element, display) {
	var siblings = element.parentNode.childNodes;
	for (var i=0; i<siblings.length; ++i) {
		var child = siblings[i];
		if (child!=element)
			setdisplay(child, display);
	}
}
function showSiblings(n) {setdisplaySiblings(n,'')};
function hideSiblings(n) {setdisplaySiblings(n,'none')};
function showorhideSiblings(n) {setdisplaySiblings(n,'switch')};


function setdisplayByName(n, display) { setdisplayGroup(document.getElementsByName(n)); }
function showByName(n) {setdisplayByName(n,'')};
function hideByName(n) {setdisplayByName(n,'none')};
function showorhideByName(n) {setdisplayByName(n,'switch')};



/* show_only_siblings(obj, delay_milliseconds) - Show only the siblings of the given object, after a delay of "delay" milliseconds */
var object_to_show;
var timeout_id = 0;
function show_only_siblings(obj, delay_milliseconds) {
	object_to_show = obj;
	if (!delay_milliseconds) delay_milliseconds=500;
	if (timeout_id) clearTimeout(timeout_id);
	timeout_id = setTimeout(
		"hideByClass('dor2');showSiblings(object_to_show);",
		delay_milliseconds);
}


var theCurrentLanguage = '';

function showSingleLanguage(l) {
	regexp = new RegExp(l);
	var alltags = document.all? document.all: document.getElementsByTagName('*');
	for (i in alltags) {
		obj = alltags[i];
		if (!obj || isFunction(obj) || !obj.lang) continue;
		if (regexp.test(obj.lang)) {
			obj.style.display='';
		}
		else if (obj.lang.length>0 && obj.tagName!='HTML' && obj.tagName!='BODY' && obj.tagName!='META' && obj.style) 
			obj.style.display='none';
	}
	theCurrentLanguage = l;
}



function activate(obj) {
	if (obj.hiddenText)
		obj.innerHTML=obj.hiddenText;
}
function deactivate(obj) {
	if (obj.innerHTML.length > 0) {
		alert(obj.innerHTML)
		obj.hiddenText = obj.innerHTML;
		obj.innerHTML="";
	}
}


var ContentEditableSupportedCache;
var undefined;
function ContentEditableSupported() {
  if (ContentEditableSupportedCache == undefined) {
    ContentEditableSupportedCache = false;
    document.write("<span id='test' style='line-height:0'>&nbsp;</span>");
    testElement = document.getElementById("test");
    if (testElement != null) {
      if (testElement["contentEditable"] != null) {
        ContentEditableSupportedCache = true;
      }
    }
  }
  return ContentEditableSupportedCache;
}

function makeEditable(theElement, isEditable) {
	if (theElement) {
		theElement.contentEditable=isEditable;
		theElement.className = isEditable? 'edited': '';
	}
}

function AllPropertiesOf(object) {
	result = "<div dir=ltr>";
	for (i in object) {
		if (!/function/.test(object[i]))
			result += ("<br>" + i + ": " + object[i] + "\n");
	} 
	result += "</div>";
	return result;
}

function AllFunctionsOf(object) {
	result = "<div dir=ltr>";
	for (i in object) {
		if (/function/.test(object[i]))
			result += ("<br>" + i + ": " + object[i] + "\n");
	} 
	result += "</div>";
	return result;
}

function bilingual(lang, lang2, tag, he_text, en_text) {
	if (lang2)
		return "<" + tag + " dir='ltr' lang='en'>" + en_text + "</" + tag + ">\n<" + tag + " dir='rtl' lang='he'>" + he_text + "</" + tag + ">\n";
	else {
		theText = (lang=='en'? en_text: he_text);
		if (tag=="div" || tag=="span")          // don't add the tag - it's redundant
			return theText;
		else 
			return "<" + tag + ">" + theText + "</" + tag + ">";
	}
}





function markOnly(theButton) {
	try {
		for (i=1; i<10; ++i)
			unmark('button' + i);
	} catch(e) {}
	mark(theButton);
}

function buttonHTML(id, action, title, description) {
	if (!action || !title) 
		return "<td id='" + id + "'>";
	else {
		action = "markOnly('" + id + "');" + action;
		return "<td id='" + id + "'><button title='" + description.replace(/["]/g,"").replace(/[']/g,"") + "' onclick=\"" + action + "\">" + title + "</button>&nbsp;";
	}
}

function buttonGroup() {
	theText = '<p class="buttons" id="buttons">' + 
		'<table class="buttons"><tr>';
	for (i=0; i<arguments.length; i += 3)
		theText += buttonHTML('button' + (i/3 + 1), arguments[i], arguments[i+1], arguments[i+2]);
	theText += 
		'</table>'+
		'</p>';
	return theText;
}


function addEvent(elm, evType, fn, useCapture)
{
  if (elm.addEventListener){
    elm.addEventListener(evType, fn, useCapture);
    return true;
  } else if (elm.attachEvent){
    var r = elm.attachEvent("on"+evType, fn);
    return r;
  } else {
    alert("Handler could not be removed");
  }
}

/* _script/form_validation */

/**
 * 1. create the validator over a row in your form. this row should have a label, and a method to indicate of errors.
 * 	var my_row = $('div.form_row');
 * 2. Add a validator function, and a parameter which it will receive
 * 	my_row.validation.add(function(field){return !(!(field.value); }, my_row.find('input').get(0));
 * 3. You can get the validation object using my_row.validation.get();
 * 4. To run the validator use my_row.run(); it will return true if valid, false if not valid, and will notify the row of errors.
 */
jQuery.fn.extend({
	// is_v is the validation function, param is its parameter
	validation_unshift : function (is_v, param) {
		var v_arr = this.data("validation");
		if (!v_arr)
			v_arr = new Array();
		v_arr.unshift({'is_v':is_v,'param':param});
		this.data("validation",v_arr);
		return this;
	},
	validation_push : function (is_v, param) {
		var v_arr = this.data("validation");
		if (!v_arr)
			v_arr = new Array();
		v_arr.push({'is_v':is_v,'param':param});
		this.data("validation",v_arr);
		return this;
	},
	validation_clear_errors : function () {
		this.find('label,legend,fieldset').removeClass('wrong').attr('title','').end().find('span.wrong').remove();		
	},
	validation_run : function() {
		var v_arr = this.data("validation");
		this.validation_clear_errors();
		if (!v_arr)
			return true; // No validators
		var l = v_arr.length;
		for (var i = 0; i < l; i++) {
			var v_obj = v_arr[i];
			switch (v_obj.is_v(v_obj.param)) {
				case false: return false; break;
				case 'valid': return true; break;
				// case true: continue 2; break;
			}
		}
		return true;
	}
});

function validator_handler(e) {
	var res = $(this).closest(".row").validation_run();
	if (e && e.type && e.type == 'keypress') 
		res = true; // Don't return false on key press - it will disable keyboard
	else
		if (res) $(this).trigger('field_validated'); // Trigger update in background
	if (!res && e) e.stopImmediatePropagation(); // Enough validators
	return res;
}
function on_submit_form(){
	window.form_cancled = false;
	$('.wrong').removeClass('wrong');
	var form_rows = $(this).find("div.row");
	window.GrowlValidatorSetError = true
	for (var i = 0; i < form_rows.length; i++) {
		if (!$(form_rows[i]).validation_run()) {
			window.form_cancled = true;
			window.GrowlValidatorSetError = false;
			return false;
		}
	}
	window.GrowlValidatorSetError = false;
	return true;
}
function RadioSetError(field, errorMessage) {
    var legend = field.closest('.radio_fieldset').find('p.legend').andSelf().find('legend,fieldset').andSelf(); 
    legend.addClass('wrong');
    legend.attr('title',errorMessage);
    if (window.GrowlValidatorSetError)
		$.jGrowl(errorMessage, {sticky:true});
}
function ValidatorSetError(field, errorMessage, silent) {
	var label = field.closest('div.row').find('label'); 
	silent = (silent == null) ? false : silent;
	label.addClass('wrong');
	label.attr('title',errorMessage);
	label.parents('.category_close').find('h3').trigger('click');
	if (!silent && window.GrowlValidatorSetError) 
		$.jGrowl(errorMessage, {sticky:true});
}
function ValidatorUnsetError(field) {
	field.parents('div.row').find('label,legend,fieldset').removeClass('wrong').attr('title','').end().find('span.wrong').remove();
}
function ValidatePassword(field, errorMessage) {
    if (!field) {
		$.jGrowl(static_text["missing fields"] + errorMessage, {sticky:true});
	    return false;
	}
	var a = field.val();
	if (a.length <= 3 && a.length > 0) {
        ValidatorSetError(field, errorMessage + static_text["password length"]);
        return false;
    }
    return true;
}

function ValidateBirthday (year_field, month_field, day_field, errorMessage, tooYoungMessage, current) {
    var today=new Date();
    if (!year_field || !month_field || !day_field) {
		$.jGrowl(static_text["missing fields"] + errorMessage, {sticky:true});
	    return false;
	}
	var year_val = parseInt(year_field.val());
	var month_val = parseInt(month_field.val());
	var day_val = parseInt(day_field.val());
	if (($(current).attr("name") && !$(current).val())) {
        ValidatorSetError(year_field, errorMessage);
		return false;
	} else if (!year_val || !month_val || !day_val) {
		// If there is a "current" birth_day field - it's probably valid otherwise we would already return by the statement above.
		// If it is valid - then we need a silent error
		ValidatorSetError(year_field, errorMessage);
			return false;
	}
    if((year_val  > today.getFullYear()-18) || 
       (year_val == today.getFullYear()-18 && month_val  > today.getMonth()+1) || 
       (year_val == today.getFullYear()-18 && month_val == today.getMonth()+1 && day_val > today.getDate()))
       {
        ValidatorSetError(year_field, tooYoungMessage);
        return false;
    }
    return true;
}

function ValidateFieldPresent(field, errorMessage) {
	if (!field) {
		return false;
		//$.jGrowl(static_text["missing fields"] + errorMessage, {sticky:true});
		//return false;
	}
	return true;
}

function ValidateInputNotEmpty(field, errorMessage) {
	// If the fields isnt' present, it best that it won't trigger an error otherwise the user couldn't fill in the form.
	if (!ValidateFieldPresent(field, errorMessage) || !field.val)
		return true; 
	if (!field.val()) {
		ValidatorSetError(field, errorMessage);
		return false;
	}
	return true;
}

function ValidateSelect(field, errorMessage) {
    if (!ValidateFieldPresent(field, errorMessage))
        return true;
	if (!field.get(0).selectedIndex) {
	    ValidatorSetError (field, errorMessage);
		return false;
	}
	return true;
}

function ValidateEmail(field) {
	var email = field.val();
	var email_error_message;
	email_error_message = get_email_string_validation_error_message(email);
	if (email && email_error_message) {
		ValidatorSetError (field, email_error_message);
		return false;
	}
	return true;
}

function ValidateEqual(field1, field2, errorMessage) {
    if (!ValidateFieldPresent(field1, errorMessage))
        return false; 
    if (!ValidateFieldPresent(field2, errorMessage))
        return false; 
	if (field1.val() != field2.val()) {
	    ValidatorSetError (field2, errorMessage);
		return false;
	}
	return true;
}

function ValidateChecked(field, errorMessage) {
	if (field.attr("disabled"))
		return true;
		
    if (!ValidateFieldPresent(field, errorMessage))
        return false; 
	if (!field.filter(':checked').length) {
	    ValidatorSetError (field, errorMessage);
		return false;
	}
	return true;
}

function ValidateRadioChecked(field, errorMessage) {
	if (!field.filter(':checked').length) {
	    RadioSetError (field, errorMessage);
		return false;
	}
	return true;
}

function ValidateAllOrNone(fields, errorMessage) {
/*
	for (var i=0; i<fields.length; ++i) {

	}
	return true;
*/
}

function ValidateNotEmpty(field, fieldName, youForgotLabel) {
	if (!youForgotLabel)
		youForgotLabel = sprintf(static_text["you forgot"],fieldName);
	return ValidateInputNotEmpty(field, youForgotLabel + fieldName + ".");
}

function ValidateAllNotEmpty(theForm, youForgotLabel) {
	var all_ok = true;
	for (var i=1; i<arguments.length; ++i) {
		fieldInternalName = arguments[i];
		fieldName = fieldInternalName.replace(/_/g," ");
	    all_ok = all_ok && ValidateNotEmpty(theForm[fieldInternalName], fieldName, youForgotLabel);
	}
    return all_ok;
}


/**
 * @see admin/make_js.php (relevant_properties)
 * @see email_validation_system.php get_email_string_validation_error_message()
 */
function get_email_string_validation_error_message(email_address) {
	var forbidden_chars = {
		"comma": ",", 
		"semicolon": ";",  
		"space": " ", 
		"quote": "\"", 
		"apostrophe": "\'",
		"greater_than": ">",
		"less_than": "<"
		};
	var forbidden_leading_chars = {
		"dot": ".",
		"at_sign": "@"
		};
	var forbidden_trailing_chars = forbidden_leading_chars;

	if (!email_address)
		return static_text["missing fields"];

	message = sprintf(static_text["email invalid"],email_address);
	if (email_address.indexOf('@') == -1) {
		return message + static_text["email invalid no at"];
	}

	for (var bad_char in forbidden_chars) {
		if (email_address.indexOf(forbidden_chars[bad_char]) > -1) {
			return message + sprintf(static_text["email invalid forbidden char"],static_text[bad_char],forbidden_chars[bad_char]);
		}
	}

	for (var bad_char in forbidden_leading_chars) {
		if (email_address.charAt(0) == forbidden_leading_chars[bad_char]) {
			return message + sprintf(static_text["email invalid forbidden leading char"],static_text[bad_char],forbidden_leading_chars[bad_char]);
		}
	}

	for (var bad_char in forbidden_trailing_chars) {
		if (email_address.charAt(email_address.length-1) == forbidden_trailing_chars[bad_char]) {
			return message + sprintf(static_text["email invalid forbidden trailing char"],static_text[bad_char],forbidden_trailing_chars[bad_char]);
		}
	}

	return "";
}

/* _script/fields */



var lang = document.body && document.body.lang? document.body.lang: 'he';


var title_without_quotes = document.title.replace(/["]/g,"").replace(/[']/g,"");

var submitLabel = (lang=='en'? "submit": "");
var saveLabel =   (lang=='en'? "[s]ave changes": " ");
var undoLabel =   (lang=='en'? "return to the non-formal version": "   - ");
var formatLabel =   (lang=='en'? "match destination formatting": "  ");
var versionsLabel =   (lang=='en'? "show former versions": "  ");

var nameLabel = (lang=='en'? 'user name': ' ');
var passwordLabel = (lang=='en'? 'password': '');
var subjectLabel = (lang=='en'? 'subject': '');
var youForgotLabel = (lang=='en'? 'You forgot to fill in the ': '  '); // for ValidateNotEmpty
var authorLabel = (lang=='en'? 'Author - if different than username': '  -    /');


function setCookies (name, email, rememberme, password) {
   if (name) setCookie('name',name.value,365,"/",null,null);   // remember the name and email for a year
   if (email) {setCookie('email',email.value, 365,"/",null,null);} // remember the name and email for a year
   if (rememberme && rememberme.checked && password) {
      setCookie('password',password.value,null,"/",null,null); // remember the password only for this session
   }
   else {
      deleteCookie('password',"/");
   }
}



titleInputHidden = '<input type="hidden" name="title" value="'+title_without_quotes+'">' + 
             '<input type="hidden" name="titlechanged" value="">';
languageInputHidden = '<input type="hidden" name="lang" value="' + lang + '">';



titleInputVisible = '<input type="text" disabled="disabled" name="title" size="50" value="" />';

authorInputVisible = '<p>' + authorLabel + ': <input type="text" name="author" size="50" value="" />' + '</p>';

languageInputVisible = '<select size=1 name="lang">' + 
	(lang=='en'? 
		'<option value="en" selected="selected">English' + '<option value="he">' : 
		'<option value="he" selected="selected">' + '<option value="en">English'  ) + 
	'</select>&nbsp;';

	
function bodyclass_title(the_bodyclass_text, the_bodyclass) {
	if (the_bodyclass_text == ' ')
		alert(':       ,         ,   !');
	
	if (the_bodyclass == 'new')
		return '';
	else
		return the_bodyclass_text + 
		(lang=='en'? ": ": " : ") +
		title_without_quotes;
}

bodyclassInput = '<select size="1" name="bodyclass" onchange="theAddForm.lang.selectedIndex=0; if (selectedIndex>0) {this.form.title.value=bodyclass_title(options[selectedIndex].text, options[selectedIndex].value); this.form.title.disabled=false;}">' + 
  '<option value="" selected="selected">' + (lang=='en'? '* add what? *': '*  ? *') + 
'</select>';

bodyclassInput_short = '<input type="hidden" name="bodyclass" value="short">';


function validate(theForm) {
	if (
		/*ValidateNotEmpty(theForm.username, nameLabel, youForgotLabel) &&*/
		ValidateNotEmpty(theForm.title, subjectLabel, youForgotLabel) &&
		/*(!passwordIsRequired || ValidateNotEmpty(theForm.password, passwordLabel, youForgotLabel))*/
		1
		) {
			setCookies (theForm.username, theForm.email, theForm.rememberme, theForm.password); 
			return true;
	}
	else 
		return false;
}

function formHeader(formId, target, action) {
	if (!action)
		action = path_from_document_to_root + '_script/rewrite.php?to=add';
	theHeader = "<form method='post' id='" + formId + "'" +
		" enctype='multipart/form-data'" +
		(target? " target='" + target + "'": "") +
		" action='" + action + "'" +
		" onsubmit='return validate(this)'>" + 
		"\n";
	return theHeader;
}


function idFields(path_from_root_to_document,usernameHint,passwordHint,emailHint) {
	theText =  
	'<table>\n'+
	'<tr>' + 
		'<td><label>' + (lang=='en'? 'user n<u>a</u>me:': '<u></u> :') + '</label>' + 
		'<td><input type="text" name="username" accesskey="a" value="' +  getCookie('name') +  '" size="50">' + 
		'<br /><small>' + usernameHint + '</small>' +
	'<tr>' + 
		'<td><label>' + (lang=='en'? "<u>p</u>assword:": ":") + '</label>' + 
	 	'<td><input accesskey="p" type="password" name="password" value="' + getCookie('password') + '">' + 
		'<br /><small>' + passwordHint + '</small>' +
	(emailHint==undefined? "": 
	'<tr>' +
		'<td><label>' + (lang=='en'? "<u>e</u>mail / published at:": " /  :") + '</label>' + 
		'<td><input accesskey="e" type="text" name="email" value="' + getCookie('email') + '" size="50">' + 
		'<br /><small>' + emailHint + '</small>') +
	'<tr>' + 
		'<td style="text-align:left"><input accesskey="k" name="rememberme" type="checkbox"' + (getCookie('name')? ' checked="checked"': '') + '>' + 
		'<td><label>' + (lang=='en'? "<u>k</u>eep my details on this computer": "   <u></u>    (   )") + '</label>' + 
		'' + 
	'<input type="hidden" name="followup" value='+path_from_root_to_document+'>'+
	'<input type="hidden" name="file" value='+path_from_root_to_document+'>'+
	"</table>\n";
	return theText;
	// both "followup" and "file" are sent - to handle Holam bug in MSIE
}


function idFields_short(path_from_root_to_document) {
	theText =  
	'<input type="hidden" name="username" value="-">'+
	'<input type="hidden" name="password" value="-">'+
	'<input type="hidden" name="followup" value='+path_from_root_to_document+'>'+
	/*'Additional info (optional): <input type="text" name="email" value="">' + */
	'<input type="hidden" name="file" value='+path_from_root_to_document+'>';
	return theText;
}


/* _script/arguments */




var path_from_root_to_document, theAuthor, theReceiver, theTvnit;
if (document.getElementsByName) {
	path_from_root_to_document = getFirstElementNamed('jmQovc');
	theAuthor = getFirstElementNamed('author');
	theReceiver = getFirstElementNamed('receiver');
	theTvnit = getFirstElementNamed('tvnit');
	theLang2 = getFirstElementNamed('lang2');
}
else if (document.all) {
	path_from_root_to_document = document.all.jmQovc.content;
	theAuthor = document.all.author.content;
	theReceiver = document.all.receiver.content;
	theTvnit = document.all.tvnit.content;
	theLang2 = document.all.lang2.content;
}
else {
	path_from_root_to_document = window.location.href.replace(/^.*:\/\/\/?[^\/]*\/(.*)[.][^.]*$/, "$1");
	theAuthor = "";
	theReceiver = "";
	theTvnit = "";
	theLang2 = "";
}








/* _script/sites */


var server = "http://tora.us.fm/";

var relative_depth=0;
for (i=0; i<path_from_root_to_document.length; ++i) {
	if (path_from_root_to_document.charAt(i)=='/') relative_depth++;
}

var path_from_document_to_site = '';
for (i=1; i<relative_depth; ++i) {
	path_from_document_to_site += '../';
}

function fileparse(theFullPath) {
	hasDirectory = /[\/\\]/.test(theFullPath);
	hasExtension = /\.[^\/\\\.]*$/.test(theFullPath);
	if (hasDirectory && hasExtension)
		return /^(.*)[\/\\]([^\/\\]*)(\.[^\/\\\.]*)$/.exec(theFullPath);
	else if (hasDirectory && !hasExtension)
		return /^(.*)[\/\\]([^\/\\]*)()$/.exec(theFullPath);
	else if (!hasDirectory && hasExtension)
		return /^()(.*)(\.[^\/\\\.]*)$/.exec(theFullPath);
	else
		return /^()(.*)()$/.exec(theFullPath);
}

var site, path_from_site_to_document, path_from_document_to_document, siomt;
path_components = /^([^\/\\]*)\/(.*)$/.exec(path_from_root_to_document);
if (path_components) {
	site = path_components[1];
	path_from_site_to_document = path_components[2];
	path_components = fileparse(path_from_root_to_document);
	path_from_document_to_document = path_components[2] + path_components[3];
	siomt = path_components[3]? "": ".html";
} else {
	site = "";
	path_from_site_to_document = path_from_root_to_document;
	path_from_document_to_document = path_from_root_to_document;
	siomt = ".html";
}

var absolute_site_url = server + site;
var absolute_document_url = absolute_site_url + "/" + path_from_site_to_document + siomt;

var path_from_site_to_cgi = "../cgi-bin";
var filepath_from_cgi_to_site = (/localhost|127.0.0.1/.test(document.URL))? "../"+site : "../httpdocs/"+site;
var linkpath_from_cgi_to_site = "../"+site;
var path_from_document_to_cgi = path_from_document_to_site + path_from_site_to_cgi;


var passwordIsRequired = false;
var site_name, usernameHint, passwordHint, emailHint;
if (document.body.lang=='en') {
	site_name='site';
	usernameHint = '';
	passwordHint = '(If you leave blank, your changes will enter a non-formal version)';
	emailHint = '(optional)';
}
else {
	site_name='';
	usernameHint = '';
	passwordHint = '(   ,   .      )';
	emailHint = '(  )';
}

if (site=='tnk1') {
	site_name='  ';
	passwordHint = '(   ,    3    ,  .  ,      )';
	passwordIsRequired = true;
}
else if ((site=='nxt') || (site=='~nachat')) {
	site_name='   ';
}
else if (site=='tokxot')
	site_name='  ';
else if (site=='limudim')
	site_name='    ';
else if (site=='fuelcell')
	site_name='      ';
else if (site=='js')
	site_name='Javascript Algorithm Encyclopedia';
else if (site=='tryg')
	site_name='  ';
else if (site=='erelsgl')
	site_name='   ';
else if (site=='levisegal') {
	passwordIsRequired = true;
	site_name='  --';
}
else if (site=='dugma') {
	usernameHint = '(  ,    "")';
	passwordHint = '(  ,    "")';
	passwordIsRequired = true;
	site_name=' ';
}
else if (site=='demo') {
	usernameHint = '(for the demo site, use "admin")';
	passwordHint = '(for the demo site, use "admin")';
	passwordIsRequired = true;
	site_name='English Demonstration site';
}


/* _script/dates/dates */


var sunsetMinuteOfDayGMT = new Array(12);
sunsetMinuteOfDayGMT[0] = 15*60 + 1;
sunsetMinuteOfDayGMT[1] = 15*60 + 28;
sunsetMinuteOfDayGMT[2] = 15*60 + 49;
sunsetMinuteOfDayGMT[3] = 16*60 + 9;
sunsetMinuteOfDayGMT[4] = 16*60 + 30;
sunsetMinuteOfDayGMT[5] = 16*60 + 48;
sunsetMinuteOfDayGMT[6] = 16*60 + 49;
sunsetMinuteOfDayGMT[7] = 16*60 + 26;
sunsetMinuteOfDayGMT[8] = 15*60 + 50;
sunsetMinuteOfDayGMT[9] = 15*60 + 11;
sunsetMinuteOfDayGMT[10] = 14*60 + 44;
sunsetMinuteOfDayGMT[11] = 14*60 + 40;


function isShabbat() {
	now = new Date();
	currentWeekday = now.getDay()+1;
	currentMinuteOfDayGMT = now.getHours()*60 + now.getMinutes() + now.getTimezoneOffset();
	meanSunsetMinuteOfDayGMT = sunsetMinuteOfDayGMT[now.getMonth()];
	return (currentWeekday==6 && currentMinuteOfDayGMT>meanSunsetMinuteOfDayGMT) ||
	       (currentWeekday==7 && currentMinuteOfDayGMT<meanSunsetMinuteOfDayGMT);
	return weekday;
}


/* _script/templates */





var theBnim, theBnimArray, theWrittenBnim;  
function AnalyzeBnim() {  // called from  a <script> block afterwards
	//start = new Date();
	theBnim = document.getElementById('ulbnim');
	theBnimArray = theBnim.innerHTML.replace(/<\/li>/ig,"").split(/<li>/i);
	if (theBnimArray[0].length<10)  {
		theBnimArray.shift();
	}
	theWrittenBnim = new Array(theBnimArray.length);
	theBnim.style.display = 'none';
}

var theBnimHash;
function CreateHash() {
	theBnimHash = new Array();
	theRegexp = new RegExp("^((<a[^<>]*>)?)([^<>]*?)([0-9-]+:)((.|\r|\n)*)$");

	for (var i=theBnimArray.length-1; i>=0; --i) {
		bn = theBnimArray[i];
		parts = theRegexp.exec(bn);
		if (parts!=null) {
			psuq = parts[4];
			rest = parts[1] + parts[3] + parts[5];
		}
		else {
			psuq = 0;
			rest = bn;
		}
		
		if (! theBnimHash[psuq] ) {
			theBnimHash[psuq] = new Array();
		}
		theBnimHash[psuq].push(i);
		theBnimArray[i] = rest;
	}
	
}


function replace_type_with_typeimage(bn) {
   if (site=='tnk1')
      return bn.
            replace(/ : /, ": ").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/tw.gif>").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/srt.gif>").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/storybook.gif>").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/games.gif>").
            replace(/:/, "").
            replace(/ :/, "").
            replace(/ :/, "").
            replace(/ :/, "<img title='' src="+path_from_document_to_site+"_themes/ein_knisa.gif> :").
            replace(/:/, "").
            replace(/:/, "").
            replace(/:/, "").
            replace(/:/, "").
            replace(/  :/, "<img title=' ' src="+path_from_document_to_site+"_themes/jtil.gif> ").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/jtil.gif> ").
            replace(/:/, "<img title='' src="+path_from_document_to_site+"_themes/mcwa.gif> ").
            replace(/:/, "");
   else
      return bn;
}

function ktov_bnim(header, pattern, footer) {
   var regexp = new RegExp(pattern,"i");
   var regexp1 = new RegExp(">"+pattern, "i");
   var regexp2 = new RegExp("^"+pattern, "i");
   var theText = "";
   var numWritten = 0;
   for (i=0; i<theBnimArray.length; ++i) {
      var bn = theBnimArray[i];
      if (regexp1.test(bn) || regexp2.test(bn)) {
        if (/href/.test(bn) || !/: -/.test(bn)) {
          if (numWritten==0) theText += header;
          if (!/img/i.test(bn)) {
            theText += "<li>";
            bn = bn.replace(//, "<img title='' src="+path_from_document_to_site+"_themes/cyur.gif>");
          }
          bn = replace_type_with_typeimage(bn).replace(regexp,"");

          theText += bn + "</li>";
          ++numWritten;
          theWrittenBnim[i] = 1;
	}
      }
   }
   if (numWritten>0) theText += footer;
   document.write(theText);
}


function ktov_bnim_axrim(header, footer) {
   if (!header) header=""; 
   if (!footer) footer="";
   theText = "";
   numWritten = 0;
   for (i=0; i<theBnimArray.length; ++i) {
      if (!theWrittenBnim[i]) {
        bn = theBnimArray[i];
        if (/href/.test(bn) || !/: -/.test(bn)) {
          if (numWritten==0) theText += header;
          theText += ("<li>"+replace_type_with_typeimage(bn));
          ++numWritten;
        }
     }
   }
   if (numWritten>0) theText += footer;
   document.write(theText);
}

function ktov_bnim_tnk() {
	ktov_bnim('', ':', ' ');
	document.write (
			"<ol class='awsp_mpwrt'>");
				ktov_bnim('', ':', ' ');
				ktov_bnim('', ':', ' ');
	document.write (
			"</ol>");
					ktov_bnim('<h2></h2> <ol class="awsp_mpwrt"> ', '(|||||||||):', ' </ol>');
					ktov_bnim('<h2>  </h2> <ol class="awsp_mpwrt"> ', '( ||||):', ' </ol>');
					ktov_bnim('<h2> </h2> <ol class="awsp_mpwrt"> ', ':', ' </ol>');
					ktov_bnim('<h2>   </h2> <ol class="awsp_mpwrt"> ', '(  |  |):', ' </ol>');
	document.write ("<br style='clear:all' />");
}



function ktov_bnim_jorj() {
	hide(theBnim);
	ktov_bnim('', '_[^<>]*:', '');
	document.write (
		"<div class='tt_jorjim'>");
			ktov_bnim('<ul> ', '(||):', ' </ul>');
			ktov_bnim('<ul> ', '([^<>]*[^<>]*):', ' </ul>');
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
	document.write (
		"</div>" + 

		"<table class='milim_mjorj'><thead><col><col></thead><tbody>" + 
		"<tr><td>");
			ktov_bnim('<h3>  \'</h3> <ul> ', '1:', ' </ul>');
			ktov_bnim('<h3>  </h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3></h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3></h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
			ktov_bnim('', '[^<>]*[^<>]*:', '');
	document.write (
		"<td>");
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
			ktov_bnim('<h3> </h3> <ul> ', ':', ' </ul>');
	document.write (
		"</table>" + 
		"<table class='mamrim_mjorj'><thead><col><col></thead><tbody>" + 
		"<tr><td>");
			ktov_bnim('<h2></h2> <ul> ', ':', ' </ul>');
			ktov_bnim('<h2></h2> <ul> ', ':', ' </ul>');
	document.write (
		"<td>");
			ktov_bnim('<h2> </h2> <ul> ', '1:', ' </ul>');
			ktov_bnim('<h2></h2> <ul> ', '(||  |  | ):', ' </ul>');
	document.write (
		"</table>");
			ktov_bnim('<h3 id=bituy></h3> <ul> ', '[^<>]*[^<>]*:', ' </ul>');
	document.write ("<br style='clear:all' />");
}


function ktov_bnim_mcwa() {
	ktov_bnim("<div class='pswqym'> <h2></h2> <ul> ", ":", " </ul> </div>");
	ktov_bnim("<div class='femym'> <h2></h2> <ul> ", ":", " </ul> </div>");
	ktov_bnim("<div class='hgdrwt'> <h2> </h2> <ul> ", "(|):", " </ul> </div>");
	ktov_bnim("<div class='drkym'> <ul> ", ":", " </ul> </div>");
	ktov_bnim("<div class='sywwgym'> <h2>  (   )</h2> <ul> ", ":", " </ul> </div>");
}

function ktov_bnim_mcwot(tdirut) {
	ktov_bnim("", ":", "");
	
	document.write(
		"<table width='100%'>" + 
		"<tbody>" + 
		"<tr>" + 
		
		"<td class='drkym'>");
		ktov_bnim("<h2>   </h2> <ol class='TableSublists'>",
			":"," </ol>");

	document.write(
		"<td class='mcwwt'>");
		
	if (tdirut == 'erua') {
		ktov_bnim("<h2>     </h2> <ol class='TableSublists'>", 
			"(_|||_|_):", "</ol>");
		ktov_bnim("<h2>      </h2> <ol class='TableSublists'>",
			"(_|_|_):","</ol>");
		ktov_bnim("<h2>      </h2> <ol class='TableSublists'>",
			"_:","</ol>");
		ktov_bnim("<h2> </h2> <ol class='TableSublists'>",
			"(_|_):", " </ol>");
	}
	else if (tdirut == 'rcon') {
		ktov_bnim("<h2>      </h2> <ol class='TableSublists'>", 
			"(_|||_):", "</ol>");
		ktov_bnim("<h2>      </h2> <ol class='TableSublists'>",
			"(_|_|_):","</ol>");
		ktov_bnim("<h2>     </h2> <ol class='TableSublists'>",
			"(_|_):", "</ol>");
		ktov_bnim("<h2> </h2> <ol class='TableSublists'>",
			"(_|_):", " </ol>");
	}
	else if (tdirut == 'ecm') {
		ktov_bnim("<h2>      /  </h2> <ol class='TableSublists'>", 
			"(_|||_|_|_):", "</ol>");
		ktov_bnim("<h2>      </h2> <ol class='TableSublists'>",
			"_:","</ol>");
		ktov_bnim("<h2>     </h2> <ol class='TableSublists'>",
			"(_|_):", "</ol>");
		ktov_bnim("<h2> </h2> <ol class='TableSublists'>",
			"(_|_):", " </ol>");
	}
	else if (tdirut == 'mcwot') {
		ktov_bnim("<h2> </h2> <ol class='TableSublists'>", 
			"(_|||_|_|_|_|_|_|_):", "</ol>");
		ktov_bnim("<h2>   </h2> <ol class='TableSublists'>",
			"_:", " </ol>");
	}
	else /*if (tdirut == 'mcwot1')*/ {
		ktov_bnim("<ol class='TableSublists'>", 
			"(_|||_|_|_|_|_|_|_|_):", "</ol>");
	}

	document.write(
		"</table>" + 
		"<table width='100%'>" + 
		"<col width='*'>" + 
		"<tbody>" + 
		"<tr>" + 
		"<td class='qyjwrym'>");

		ktov_bnim_axrim("<h2>,  </h2> <ol class='TableSublists'>",
			"</ol>");
	document.write(
		"</table>");
}




/* _script/magrim */

var magrim_root = path_from_document_to_root + "tnk1/_magr/";
function table_link_item(table_name, table_description) {
	return "<li>" +
		"<b>" + table_name + "</b> (" +
		"<a href='" + magrim_root + table_name + ".sql'></a>, " +
		"<a href='" + magrim_root + table_name + ".txt'></a>): " +
		table_description +
		"</li>\n";
}
function show_table(table_name, table_description) {
	document.write(table_link_item(table_name, table_description));
}

function mdb_table_link_item(table_name, table_description) {
	return "<li>" +
		"<b>" + table_name + "</b> (" +
		"<a href='" + path_from_document_to_root + "tnk1/_mdb/" + table_name +  ".txt'></a>; <small>     </small>): " +
		table_description +
		"</li>\n";
}
function show_mdb_table(table_name, table_description) {
	document.write(mdb_table_link_item(table_name, table_description));
}

function show_table_warning() {
	document.write("<li>!     ( 2 &quot;).       ,         .           .       &quot;&quot;." + 
	"</li>\n" + 
	"<li>     1255,   utf-8.       ,    ." + 
	"</li>\n");
}


/* _script/search */



function submitGoogle(theForm) {
	theForm.ie.disabled=theForm.oe.disabled=theForm.hl.disabled=theForm.q.disabled=theForm.meta.disabled=theForm.num.disabled=theForm.lr.disabled=false; 
	theForm.mslul.disabled=theForm.erk.disabled=true; 
	theForm.q.value=theForm.erk.value+" site:www.tora.us.fm"; 
	theForm.action="http://www.google.co.il/search"; 
	theForm.submit(); 
	theForm.mslul.disabled=theForm.erk.disabled=false;
	theForm.ie.disabled=theForm.oe.disabled=theForm.hl.disabled=theForm.q.disabled=theForm.meta.disabled=theForm.num.disabled=theForm.lr.disabled=true;
}

function submitFindPsuq(theForm) {
	theForm.action=path_from_site_to_cgi + "/../_script/findpsuq.php"; 
	//theForm.mslul.value = "tnk1/_magr/psuqim_gross.csv";
	theForm.mslul.disabled=true; 
	theForm.submit();
}


function submitFind(theForm) {
	theForm.action= '../tnk1/mftx.php'; 
	theForm.mslul.value = site.replace(/nxt/,"tnk1");
	theForm.submit();
}

function submitFindTaconite(theForm) {
	baseurl = '../tnk1/mftx.php?site=tnk1&erk=' + theForm.erk.value + '&format=';
	if (typeof new_window=='undefined' || !new_window) {
		url = baseurl + "taconite";
		$.get(url); //Create AjaxRequest object

		$("#searchresults_anchor").show();
		$(".dor2").hide();
		$("#searchresults_anchor").siblings().show();
	}
	else {
		url = baseurl + "html";
		window.open(url);
	}
}

function goSfrPrq(sfr, prq) {
	if (sfr.length>0)
		top.location.href = "http://tora.us.fm/tnk1/prqim/t"+sfr+prq+".htm";
}



var values = Array (1,2,3,4,5,6,7,8,9,10,20,20,30,40,40,50,50,60,70,80,80,90,90,100,200,300,400);
var letters1 = ''.split('');
var letters2 = ''.split('');
var letters3 = ''.split('');
function number2hebrew(num) {
	heb = "";
	while (num > 400) {
		heb += "";
		num -= 400;
	}
	if (num >= 100) {
		heb += letters3[ Math.floor(num / 100) - 1 ];
		num %= 100;
	}
	if (num >= 10) {
		if (num == 15) {
			heb += "";
			num = 0;
		}
		else if (num == 16) {
			heb += "";
			num = 0;
		}
		else {
			heb += letters2[ Math.floor(num / 10) - 1 ];
			num %= 10;
		}
	}
	if (num >= 1) {
		heb += letters1[ num - 1 ];
	}
	
	return heb;
}




function setPrq(sfrIndex, prqElement) {
	prqElement.options.length=0;
	if (sfrIndex<=0) return;

	var kmuyot_prqim = new Array(50,40,27,36,34,24,21,31,24,22,25,66,52,48,14,4,9,1,4,7,3,3,3,2,14,3,29,36,150,42,31,4,8,12,5,10,12,10,13);
	var kmut_prqim = kmuyot_prqim[sfrIndex-1];

	prqElement.options[0] = new Option("-", "");
	for (var i=1; i<=kmut_prqim; ++i) {
		var kotrt = number2hebrew(i);
		var ktovt = (
			i<10? "0"+i:
			i<100? i:
			i<110? "a"+(i-100): 
			i<120? "b"+(i-110): 
			i<130? "c"+(i-120): 
			i<140? "d"+(i-130): 
			i<150? "e"+(i-140): 
			i<160? "f"+(i-150): "");
		prqElement.options[i] = new Option(kotrt, ktovt);
	}
}



/* _script/rtelang_en */


var lblSubmit 				 = "Submit"; // Button value for non-designMode() & non fullsceen RTE
var lblModeRichText 	 = "Switch to RichText Mode"; // Label of the Show Design view link
var lblModeHTML 			 = "Switch to HTML Mode"; // Label of the Show Code view link
var lblPreview				 = "Preview";
var lblSave 				 	 = "Save";
var lblPrint					 = "Print";
var lblSelectAll			 = "Select/Deselect All";
var lblSpellCheck			 = "Spell Check";
var lblCut						 = "Cut";
var lblCopy						 = "Copy";
var lblPaste					 = "Paste";
var lblPasteText       = "Paste as Plain Text";
var lblPasteWord       = "Paste From Word";
var lblUndo						 = "Undo";
var lblRedo						 = "Redo";
var lblHR							 = "Horizontal Rule";
var lblInsertChar			 = "Insert Special Character";
var lblBold						 = "Bold";
var lblItalic					 = "Italic";
var lblUnderline			 = "Underline";
var lblStrikeThrough   = "Strike Through";
var lblSuperscript		 = "Superscript";
var lblSubscript			 = "Subscript";
var lblAlgnLeft				 = "Align Left";
var lblAlgnCenter			 = "Center";
var lblAlgnRight			 = "Align Right";
var lblJustifyFull		 = "Justify Full";
var lblOL							 = "Ordered List";
var lblUL							 = "Unordered List";
var lblOutdent				 = "Outdent";
var lblIndent					 = "Indent";
var lblTextColor			 = "Text Color";
var lblBgColor				 = "Background Color";
var lblSearch					 = "Search And Replace";
var lblInsertLink			 = "Insert Link";
var lblAddImage				 = "Add Image";
var lblInsertTable		 = "Insert Table";
var lblWordCount       = "Word Count";
var lblUnformat        = "Unformat";

var lblFormat  = "<option value=\"\"  selected=\"selected\">Format</option>";
lblFormat     += "<option value=\"p\">Default Paragraph</option>";
lblFormat     += "<option value=\"div\">Default Division</option>";
lblFormat     += "<option value=\"cite\">Citation</option>";      
lblFormat     += "<option value=\"q\">Quotation</option>";
lblFormat     += "<option value=\"q.psuq\">Quotation - Bible Verse</option>";
lblFormat     += "<option value=\"q.mfrj\">Quotation - Bible Commentator</option>";
lblFormat     += "<option value=\"dfn\">Definition</option>";
lblFormat     += "<option value=\"blockquote\">Block quotation</option>";
lblFormat     += "<option value=\"h1\">Heading 1</option>";
lblFormat     += "<option value=\"h2\">Heading 2</option>";
lblFormat     += "<option value=\"h3\">Heading 3</option>";
lblFormat     += "<option value=\"div.advanced\">div for advanced readers</option>";
lblFormat     += "<option value=\"span.advanced\">span for advanced readers</option>";
lblFormat     += "<option value=\"div.future\">div for future research</option>";
lblFormat     += "<option value=\"span.future\">span for future research</option>";
lblFormat     += "<option value=\"div.requirements\">div of requirements</option>";
lblFormat     += "<option value=\"span.field\">field template</option>";
lblFormat     += "<option value=\"div.revisions\">revision history</option>";
lblFormat     += "<option value=\"span.versionid\">version identifier</option>";
lblFormat     += "<option value=\"span.notes\">span of notes</option>";
lblFormat     += "<option value=\"div.submit\">div of submit</option>";
lblFormat     += "<option value=\"div.notes\">div of notes</option>";
lblFormat     += "<option value=\"h4\">Heading 4</option>";
lblFormat     += "<option value=\"h5\">Heading 5</option>";
lblFormat     += "<option value=\"h6\">Heading 6</option>";
lblFormat     += "<option value=\"abbr\">Abbreviation</option>";
lblFormat     += "<option value=\"acronym\">Acronym</option>";
lblFormat     += "<option value=\"address\">Address</option>";
lblFormat     += "<option value=\"pre\">Preformatted Text</option>";
lblFormat     += "<option value=\"code\">Code</option>";
lblFormat     += "<option value=\"kbd\">Text for keyboard</option>";
lblFormat     += "<option value=\"var\">Variable</option>";
lblFormat     += "<option value=\"samp\">Sample</option>";
lblFormat     += "<option value=\"ins\">Inserted text</option>";
lblFormat     += "<option value=\"del\">Deleted text</option>";



var lblFont 					 =  "<option value=\"\"  selected=\"selected\">Font</option>";
lblFont 							 += "<option value=\"Arial, Helvetica, sans-serif\">Arial</option>";
lblFont 							 += "<option value=\"Courier New, Courier, mono\">Courier New</option>";
lblFont 							 += "<option value=\"Palatino Linotype\">Palatino Linotype</option>";
lblFont 							 += "<option value=\"Times New Roman, Times, serif\">Times New Roman</option>";
lblFont 							 += "<option value=\"Verdana, Arial, Helvetica, sans-serif\">Verdana</option>";
var lblSize 					 =  "<option value=\"\">Size</option>";
lblSize 							 += "<option value=\"1\">1</option>";
lblSize 							 += "<option value=\"2\">2</option>";
lblSize 							 += "<option value=\"3\">3</option>";
lblSize 							 += "<option value=\"4\">4</option>";
lblSize 							 += "<option value=\"5\">5</option>";
lblSize 							 += "<option value=\"6\">6</option>";
lblSize 							 += "<option value=\"7\">7</option>";

var lblErrorPreload 	 = "Error preloading content.";
var lblSearchConfirm 	 =  "The search expression [SF] was found [RUNCOUNT] time(s).\n\n"; // Leave in [SF], [RUNCOUNT] and [RW]
lblSearchConfirm			 += "Are you sure you want to replace these entries with [RW] ?\n";
var lblSearchAbort 		 = "Operation Aborted.";
var lblSearchNotFound	 = "was not found.";
var lblCountTotal	     = "Total Word Count";
var lblCountSelection    = "Selection Word Count"; // Added by Erel
var lblCountChar	     = "Available Characters";
var lblCountCharWarn   = "Warning! Your content is too long and may not save correctly.";

var lblLinkType			 	 = "Link Type";
var lblLinkOldA				 = "existing anchor";
var lblLinkNewA 	 		 = "new anchor";
var lblLinkNoA     		 = "No Existing Anchors";
var lblLinkAnchors 		 = "Anchors";
var lblLinkAddress		 = "Address";
var lblLinkText		 		 = "Link Text";
var lblLinkOpenIn			 = "Open Link In";
var lblLinkVal0        = "Please enter a url.";
var lblLinkSubmit 		 = "OK";
var lblLinkCancel			 = "Cancel";
var lblImageURL			 	 = "Image URL";
var lblImageAltText		 = "Alternative Text";
var lblImageBorder 	 	 = "Border";
var lblImageBorderPx 	 = "Pixels";
var lblImageVal0     	 = "Please indicate the \"Image URL\".";
var lblImageSubmit 		 = "OK";
var lblImageCancel		 = "Cancel";
var lblTableRows			 = "Rows";
var lblTableColumns		 = "Columns";
var lblTableWidth 	 	 = "Table width";
var lblTablePx     		 = "pixels";
var lblTablePercent 	 = "percent";
var lblTableBorder		 = "Border thickness";
var lblTablePadding		 = "Cell padding";
var lblTableSpacing		 = "Cell spacing";
var lblTableSubmit 		 = "OK";
var lblTableCancel		 = "Cancel";
var lblSearchFind			 = "Find what";
var lblSearchReplace 	 = "Replace with";
var lblSearchMatch     = "Match case";
var lblSearchWholeWord = "Find whole words only";
var lblSearchVal0			 = "You must enter something into \"Find what:\".";
var lblSearchSubmit		 = "OK";
var lblSearchCancel		 = "Cancel";
var lblPasteTextHint   = "Hint: To paste you can either right-click and choose \"Paste\" or use the key combination of Ctrl-V.<br><br>";
var lblPasteTextVal0   = "Please enter text."
var lblPasteTextSubmit = "OK";
var lblPasteTextCancel = "Cancel";
var lblPasteWordHint   = "Hint: To paste you can either right-click and choose \"Paste\" or use the key combination of Ctrl-V.<br><br>";
var lblPasteWordVal0   = "Please enter text."
var lblPasteWordSubmit = "OK";
var lblPasteWordCancel = "Cancel";


var lblAutoBR					 = "Use Auto Line Breaks";
var lblRawHTML			 	 = "Use Only Raw HTML";
var lblnon_designMode  = 'To use the Rich Text Editor, a <a href="http://www.mozilla.org/" target="_new">Mozilla 1.3+</a> browser (eg, <a href="http://www.mozilla.org/products/firefox/" target=_new>Firefox</a>) or <a href="http://www.microsoft.com/windows/ie/default.asp" target="_new">MS IE5+</a> (Windows) are required. Apple Safari, IE5(Mac) and Opera browsers are not currently supported and all text must be in HTML.';


/* _script/rte */






var minWidth = 640;					// minumum width
var wrapWidth = 1245; 			//width at which all icons will appear on one bar
var maxchar = 64000;        // maximum number of characters per save



var lang_direction = "ltr";           // localization attribute added by Erel
var lang = "en"; 						//xhtml language
var encoding = "iso-8859-1"; 		//xhtml encoding, english only use "iso-8859-1"
if (document.body.lang != "en") {
	lang_direction = "rtl";
	lang = "he";
	encoding = "windows-1255";
}





var zeroBorder = "#c0c0c0"; //guideline color - see showGuidelines()
var btnText = "submit";			//Button value for non-designMode() & fullsceen rte
var resize_fullsrcreen = true;

var keep_absolute = true; // !!!Disabled - see line 456 for details!!!!!  

var InsertChar;
var InsertTable;
var InsertLink;
var InsertImg;
var dlgReplace;
var dlgPasteText;
var dlgPasteWord;

var ua = navigator.userAgent.toLowerCase();
var isIE = ((ua.indexOf("msie") != -1) && (ua.indexOf("opera") == -1) && (ua.indexOf("webtv") == -1))? true:false;
var isIE7 = ((isIE) && (ua.indexOf("msie 7.") != -1))? true:false;
var	isChrome = (ua.indexOf("chrome") != -1)? true:false;
var	isGecko = (ua.indexOf("gecko") != -1 || isChrome)? true:false;
var	isSafari = (ua.indexOf("safari") != -1)? true:false;
var	isKonqueror = (ua.indexOf("konqueror") != -1)? true:false;

var rng;  // global range
var currentRTE;
var allRTEs = "";
var obj_width;
var obj_height;
var imagesPath;
var includesPath;
var cssFile;
var generateXHTML = true;
var isRichText = false;
if(document.getElementById && document.designMode /*&& !isSafari */&& !isKonqueror) isRichText = true;

function initRTE(imgPath, incPath, css, genXHTML){
	// CM 05/04/05 check args for compatibility with old RTE implementations
	if (arguments.length == 3) {
		genXHTML = generateXHTML;
	}
	//set paths vars
	imagesPath = imgPath;
	includesPath = incPath;
	cssFile = css;
	generateXHTML = genXHTML;
	if(isRichText) document.writeln('<style type="text/css">@import "' + includesPath + 'rte.css";</style>');
	if(!isIE){
	  minWidth = minWidth-48;
	  wrapWidth = wrapWidth-102;
	}
}


function setRTE(rte, html, css, readOnly) {
	document.getElementById('hdn' + rte).value = html;  
	if(document.all){
		enableDesignMode(rte, css? css: cssFile, readOnly);  // enableDesignMode(rte, html, css, readOnly);
	}else{
		document.getElementById(rte).contentDocument.body.innerHTML = html;
	}
}


/* Doesn't work on IE! */
function setRTESize(rte,width,height) {
	var oRTE = document.getElementById(rte);
	var sRTE = document.getElementById('size'+rte);
	var oBut1 = document.getElementById('Buttons1_'+rte);
	var oVS = document.getElementById('vs'+rte);

	if (isIE) {
		oRTE.style = "width:"+(width-2)+"px; height:"+height+"px";  // Doesn't work!
	}
	else {
		oRTE.style.width = "" + width-2 + "px";
		oRTE.style.height = "" + height + "px";
	}

	if (sRTE) sRTE.value = height;
	if (oBut1) oBut1.style.width = "" + width + "px";
	if (oVS) oVS.style.width = "" + width + "px";
}



function showHideRTE(rte, showHide) {
	var display = (showHide == 'show'? '': 'none');
	// not all parts exist for each rte, so we ignore errors
	try {document.getElementById('Buttons1_'+rte).style.display = display ; } catch(e) {}
	try {document.getElementById('Buttons2_'+rte).style.display = display ; } catch(e) {}
	try {document.getElementById('vs'+rte).style.display = display ; } catch(e) {}
	if (isIE) {	document.getElementById(rte).style.display = display;	}
	else showHideElement(rte, showHide, false);  // "true" causes an error in Mozilla
}



function writeRichText(rte, html, css, width, height, buttons, readOnly, fullscreen) {
	currentRTE = rte;
	if(allRTEs.length > 0) allRTEs += ";";
	allRTEs += rte;
	// CM 06/04/05 stops single quotes from messing everything up
	html=replaceIt(html,'\'','&apos;');
	// CM 05/04/05 a bit of juggling for compatibility with old RTE implementations
	if (arguments.length == 6) {
		fullscreen = false;
		readOnly = buttons;
		buttons = height;
		height = width;
		width = css;
		css = "";
	}
	
	var iconWrapWidth = wrapWidth;
	if(readOnly) buttons = false;
	if(fullscreen)
	{
		readOnly = false; // fullscreen is not readOnly and must show buttons
		buttons = true;
		// resize rte on resize if the option resize_fullsrcreen = true.
		if(isRichText && resize_fullsrcreen) window.onresize = resizeRTE;
		document.body.style.margin = "0px";
		document.body.style.overflow = "hidden";
		//adjust maximum table widths
		findSize("");
		width = obj_width;
		if(width < iconWrapWidth) {
			height = (obj_height - 83);
		}else{
			height = (obj_height - 55);
		}
		if (width < minWidth){
			document.body.style.overflow = "auto";
			if(isIE){
				height = obj_height-22;
			}else{
				height = obj_height-24;
			}
			width = minWidth;
		}
		var tablewidth = width;
	}else{
		fullscreen = false;
		iconWrapWidth = iconWrapWidth-25;
		//adjust minimum table widths
		if (buttons && (width < minWidth)) width = minWidth;
		if(isIE){
			var tablewidth = width;
		}else{
			var tablewidth = width + 4;
		}
	}
	if(isRichText){
		var rte_css = "";
		if(css.length > 0) {
			rte_css = css;
		}else{
			rte_css = cssFile;
		}
		document.writeln('<div class="rteDiv">'); // Erel: changed from "span" to "div"
		if(buttons){
			document.writeln('<table class="rteBk" cellpadding=0 cellspacing=0 id="Buttons1_'+rte+'" width="' + tablewidth + '">');
			document.writeln('<tbody><tr>');
			insertBar();
			//document.writeln('<td><input type="image" class="rteImg" src="'+imagesPath+'save.gif" alt="'+lblSave+'" title="'+lblSave+'" onmouseover="this.className=\'rteImgUp\'" onmouseout="this.className=\'rteImg\'" onmousedown="this.className=\'rteImgDn\'" onmouseup="this.className=\'rteImgUp\'"></td>');
			insertImg(lblPrint,"print.gif","rtePrint('"+rte+"')");
			insertSep();
			insertImg(lblSelectAll,"selectall.gif","toggleSelection('"+rte+"')");
			insertImg(lblUnformat,"unformat.gif","rteCommand('"+rte+"','removeformat')");
			insertSep();
			if(isIE){
				insertImg(lblCut,"cut.gif","rteCommand('"+rte+"','cut')");
				insertImg(lblCopy,"copy.gif","rteCommand('"+rte+"','copy')");
				insertImg(lblPaste,"paste.gif","rteCommand('"+rte+"','paste')");
			}
			insertImg(lblPasteText,"pastetext.gif","dlgLaunch('"+rte+"','text')");
			insertImg(lblPasteWord,"pasteword.gif","dlgLaunch('"+rte+"','word')");
			insertSep();
			insertImg(lblUndo,"undo.gif","rteCommand('"+rte+"','undo')");
			insertImg(lblRedo,"redo.gif","rteCommand('"+rte+"','redo')");
			insertSep();
			document.writeln('<td><select id="formatblock_'+rte+'" onchange="selectClass(\''+rte+'\', this.id);" style="font-size:14px;width:155px;height:20px;margin:1px;">');  // Erel 2006/05/26: replaced "selectFont" with "selectClass"; added 50px for longer-named styles
			document.writeln(lblFormat);
			document.writeln('</select></td><td>');
			document.writeln('<select id="fontname_'+rte+'" onchange="selectFont(\''+rte+'\', this.id)" style="font-size:14px;width:125px;height:20px;margin:1px;">');
			document.writeln(lblFont);
			document.writeln('</select></td><td>');
	
			// Erel: removed 'unselectable="on"'
			document.writeln('<select id="fontsize_'+rte+'" onchange="selectFont(\''+rte+'\', this.id);" style="font-size:14px;width:75px;height:20px;margin:1px;">');
			document.writeln(lblSize);
			document.writeln('</select></td>');
			if(tablewidth < iconWrapWidth){
				document.writeln('<td width="100%"></td></tr></tbody></table>');
				document.writeln('<table class="rteBk" cellpadding="0" cellspacing="0" id="Buttons2_'+rte+'" width="' + tablewidth + '">');
				document.writeln('<tbody><tr>');
			}
			insertBar();
			insertImg(lblBold,"bold.gif","rteCommand('"+rte+"','bold')");
			insertImg(lblItalic,"italic.gif","rteCommand('"+rte+"','italic')");
			insertImg(lblUnderline,"underline.gif","rteCommand('"+rte+"','underline')");
			insertSep();
			insertImg(lblStrikeThrough,"strikethrough.gif","rteCommand('"+rte+"','strikethrough')");
			insertImg(lblSuperscript,"superscript.gif","rteCommand('"+rte+"','superscript')");
			insertImg(lblSubscript,"subscript.gif","rteCommand('"+rte+"','subscript')");
			insertSep();
			insertImg(lblAlgnLeft,"left_just.gif","rteCommand('"+rte+"','justifyleft')");
			insertImg(lblAlgnCenter,"centre.gif","rteCommand('"+rte+"','justifycenter')");
			insertImg(lblAlgnRight,"right_just.gif","rteCommand('"+rte+"','justifyright')");
			insertImg(lblJustifyFull,"justifyfull.gif","rteCommand('"+rte+"','justifyfull')");
			insertSep();
			insertImg(lblOL,"numbered_list.gif","rteCommand('"+rte+"','insertorderedlist')");
			insertImg(lblUL,"list.gif","rteCommand('"+rte+"','insertunorderedlist')");
			insertImg(lblOutdent,"outdent.gif","rteCommand('"+rte+"','outdent')");
			insertImg(lblIndent,"indent.gif","rteCommand('"+rte+"','indent')");
			insertSep();
			insertImg(lblTextColor,"textcolor.gif","dlgColorPalette('"+rte+"','forecolor')","forecolor_"+rte);
			insertImg(lblBgColor,"bgcolor.gif","dlgColorPalette('"+rte+"','hilitecolor')","hilitecolor_"+rte);
			insertSep();
			insertImg(lblHR,"hr.gif","rteCommand('"+rte+"','inserthorizontalrule')");
			insertSep();
			insertImg(lblInsertChar,"special_char.gif","dlgLaunch('"+rte+"','char')");
			insertImg(lblInsertLink,"hyperlink.gif","dlgLaunch('"+rte+"','link')");
			insertImg(lblAddImage,"image.gif","dlgLaunch('"+rte+"','image')");
			insertImg(lblInsertTable,"insert_table.gif","dlgLaunch('"+rte+"','table')");
			insertSep();
			insertImg(lblSearch,"replace.gif","dlgLaunch('"+rte+"','replace')");
			insertImg(lblWordCount,"word_count.gif","countWords('"+rte+"')");
			if(isIE)insertImg(lblSpellCheck,"spellcheck.gif","checkspell()");
			document.writeln('<td width="100%"></td></tr></tbody></table>');
		}
		document.writeln('<iframe id="'+rte+'" width="' + (tablewidth - 2) + 'px" height="' + height + 'px" frameborder=0 style="border: 1px solid #d2d2d2" src="' + includesPath + 'blank.htm" onfocus="dlgCleanUp();"></iframe>');
		if(!readOnly){
		  document.writeln('<table id="vs'+rte+'" class="rteBk" cellpadding=0 cellspacing=0 border=0 width="' + tablewidth + '"><tr>');
			document.writeln('<td onclick="toggleHTMLSrc(\''+rte+'\', ' + buttons + ');" nowrap><img class="rteBar" src="'+imagesPath+'bar.gif" alt="" align=absmiddle><span id="imgSrc'+rte+'"><img src="'+imagesPath+'code.gif" alt="" title="" style="margin:1px;" align=absmiddle></span><span id="txtSrc'+rte+'" style="font-family:tahoma,sans-serif;font-size:12px;color:#0000ff;CURSOR: default;">'+lblModeHTML+'</span></td>');
			document.writeln('<td width="100%" nowrap>&nbsp;</td></tr></table>');
		}
		document.writeln('<iframe width="142" height="98" id="cp'+rte+'" src="' + includesPath + 'palette.htm" scrolling="no" frameborder=0 style="margin:0;border:0;visibility:hidden;position:absolute;border:1px solid #cdcdcd;top:-1000px;left:-1000px"></iframe>');
		document.writeln('<input type="hidden" id="hdn'+rte+'" name="'+rte+'" value="" style="position: absolute;left:-1000px;top:-1000px;">');
		if(!fullscreen) document.writeln('<input type="hidden" id="size'+rte+'" value="'+height+'" style="position: absolute;left:-1000px;top:-1000px;">');
		document.writeln('</div><!--rteDiv-->');  // Erel: changed from "span" to "div"
		document.getElementById('hdn'+rte).value = html;  
		enableDesignMode(rte, rte_css, readOnly);            // "html" parameter removed by Erel -- see function definition
	}
	else{
		buttons = false;
		if(fullscreen && height > 90) height = (height - 75);tablewidth=tablewidth-30;
		// CM non-designMode() UI
		html = parseBreaks(html);
		document.writeln('<div style="font:12px Verdana, Arial, Helvetica, sans-serif;width: ' + tablewidth + 'px;padding:15px;">');
		if(!readOnly){
		  document.writeln('<div style="color:gray">'+lblnon_designMode+'</div><br>');
		  document.writeln('<input type="radio" name="' + rte + '_autobr" value="1" checked="checked" onclick="autoBRon(\'' + rte + '\');" /> '+lblAutoBR+'<input type="radio" name="' + rte + '_autobr" value="0" onclick="autoBRoff(\'' + rte + '\');" />'+lblRawHTML+'<br>');
		  document.writeln('<textarea name="'+rte+'" id="'+rte+'" style="width: ' + tablewidth + 'px; height: ' + height + 'px;">' + html + '</textarea>');
		}else{
			document.writeln('<textarea name="'+rte+'" id="'+rte+'" style="width: ' + tablewidth + 'px; height: ' + height + 'px;" readonly=readonly>' + html + '</textarea>');
		}
		if(fullscreen) document.writeln('<br><input type="submit" value="'+btnText+'" />');
		document.writeln('</div>');
	}
}


function insertBar(){
	document.writeln('<td><img class="rteBar" src="'+imagesPath+'bar.gif" alt=""></td>');
}
function insertSep(){
	document.writeln('<td><img class="rteSep" src="'+imagesPath+'blackdot.gif" alt=""></td>');
}
function insertImg(name, image, command, id){
	var td = "<td>";
	if(id!=null) td = "<td id='"+id+"'>";
	document.writeln(td+'<img class="rteImg" src="'+imagesPath+image+'" alt="'+name+'" title="'+name+'" onClick="'+command+'" onmouseover="this.className=\'rteImgUp\'" onmouseout="this.className=\'rteImg\'" onmousedown="this.className=\'rteImgDn\'" onmouseup="this.className=\'rteImgUp\'"></td>');
}



function enableDesignMode(rte, css, readOnly) {
	html = document.getElementById('hdn'+rte).value;       // line added by Erel
	var frameHtml = "<html dir='" + lang_direction + "' lang='" + lang + "' id='" + rte + "'>\n<head>\n";
	frameHtml += "<meta http-equiv='Content-Type' content='text/html; charset=" + encoding + "'>\n";
	frameHtml += "<meta http-equiv='Content-Language' content='" + lang + "'>\n";

	if(css.length > 0){
	  frameHtml += "<link media=\"all\" type=\"text/css\" href=\"" + css + "\" rel=\"stylesheet\">\n";
	}
	else {
	  // styles changed by Erel
	  frameHtml += "<style>" + 
	  	"@charset \"utf-8\"; " + 
		"body            { font-weight:normal; font-size:1.25em }" + 
		"small           { font-size: 0.6em }" + 
		"li table td { font-size: 0.7em }" + 
		"cite, .citut { font-weight: bolder; font-family: serif; font-style: normal; font-size:1.1em }" + 
		"cite small, .citut small, small cite, small .citut {font-size: 0.6em}" + 
		"textarea, input { font-family: 'Courier New', 'Courier', monospace; font-size: 0.6em }" + 
		"textarea.code   { font-size: 0.6em }" + 
		"button          { font-size: 0.6em }" + 
		"table  {border-spacing: 0}" + 
		"table td {border-style:ridge; border-width:1pt}" + 

		
		"h1           { font-weight:normal; font-size:2.5em; text-align:center; margin:auto }" + 
		"h2           { font-weight:normal; font-size:1.6em }" + 
		"h3           { font-weight:normal; font-size:1.3em }" + 
		"h4           { font-weight:normal; font-size:1.2em }" + 
		"h5           { font-weight:normal; font-size:1.1em }" + 
		"h6           { font-weight:normal; font-size:1em }" + 
		
		"td { vertical-align:top }" + 
		"form table tr { background:#dfdfdf; color:black  }" + 
		"form {border: dotted 1pt; margin:1em}" + 
		".notes {font-style:italic; font-size:smaller}" + 
		".requirements {color:#880000}" + 
		".field {border: solid 1pt black; padding-right:10em}" + 
		"a u, a .u {font-weight: bolder; border-bottom: solid 1px}" + 
		".u { text-decoration:underline }" + 
		"h1 a, h2 a, h3 a, h4 a, h5 a, h6 a {text-decoration:none}" + 

		"div.lang  { border-top: 1px solid #eeeeee; border-bottom: 1px solid #eeeeee; padding-top: 1em }" + 
		"span.lang { border-left: 1px solid #eeeeee; border-right: 1px solid #eeeeee }" + 
		
		"textarea.code { background:#eeeeff; color:black; margin:auto }" + 
		"button {margin:auto; text-align:center}" + 
		"body.jsfunction, body.jsalgorithm { text-align:center; margin:auto }" + 
	
		"li table {border: none}" + 
		"li table td {border: groove 1.1px rgb(230,230,184)}" + 
		"li table td a {text-decoration: none}" + 
		
		".advanced, .revisions {background-color:#eee; border:dotted 1pt}" + 
		".versionid {border: solid 1pt #008; background: #ccf; margin:0 2em 0 2em; text-align:center; width:4em}" + 
		".future {font-size:smaller; background-color:#ccc}" + 
		"a.psuq {font-size:10px}" + 

		/* styles for sikum.php */

		"#etnachta {background:#fee}" + 
		
		"#mikraotgdolot {background:#eef}" + 
		"#mikraotgdolot #toc {display:none}" + 
		"#mikraotgdolot .links_in_title {display:none}" + 
		
		"#mamrim {background:#efe}" + 
		"#mamrim .skipped {font-size:10px}" + 
	


		"q:before {content: no-open-quote;}" + 
		"q:after {content: no-close-quote;}" + 
		"cite, .citut, q { font-family: serif; font-style: normal; font-size:1.2em }" + 
		"q      { color: #800 }" + 
		"q.psuq { color: #008 }" + 
		"q.mfrj { color: #080 }" + 

		"body {background:#FFFFFF;margin:8px;padding:0px;font-size:15pt}" + 
		"</style>\n";   // style change by Erel
	}
	frameHtml += "</head><body class='RTE'>\n"+html+"\n</body></html>";     // class attribute added by Erel
	
	var oRTE = returnRTE(rte).document;
	if(document.all){
		oRTE.open();
		oRTE.write(frameHtml);
		oRTE.close();
		if(!readOnly){
			oRTE.designMode = "On";
		}
	}else{
		try{
			// Commented out the following line to confront a bug when loading multiple RTEs on one page in a MOZ browser
			// Fix provided by "Kings". Safari may have problems with this snytax - unable to test because I don't own a MAC.(Tim Bell)
			//
			if(!readOnly) document.getElementById(rte).contentDocument.designMode = "on";
			//if(!readOnly) {
			//	addLoadEvent(function() { document.getElementById(rte).contentDocument.designMode = "on"; });
			//}
			try{
				oRTE.open();
				oRTE.write(frameHtml);
				oRTE.close();
				if(isGecko && !readOnly){
				  //attach a keyboard handler for gecko browsers to make keyboard shortcuts work
				  oRTE.addEventListener("keypress", geckoKeyPress, true);
				  oRTE.addEventListener("focus", function (){dlgCleanUp()}, false);
				}
			}catch(e){
				alert(lblErrorPreload + ": " + e);   // added by Erel for clearer error diagnostics
			}
		}catch(e){
			dump('\nenableDesignMode(' + rte + ', ' + css + ', ' + readOnly + ')\n catch: ' + e + '\n');     // dump added by Erel for diagnostics
			//gecko may take some time to enable design mode.
			//Keep looping until able to set.
			if(isGecko){
				setTimeout("enableDesignMode('"+rte+"', '"+css+"', "+readOnly+");", 200); 
					// html parameter removed by Erel -- see function definition
			}else{
			  return false;
			}
		}
	}
	setTimeout('showGuidelines("'+rte+'")',300);
}


function addLoadEvent(func) {
	 var oldonload = window.onload;
	 if (typeof window.onload != 'function') {
	    window.onload = func;
	 } else {
	    window.onload = function() {
	       oldonload();
	       func();
	    }
	 }
}

function returnRTE(rte) {
	var rtn;
	if(document.all){
		rtn = frames[rte];
	}else{
		rtn = document.getElementById(rte);
		if (rtn==null) {
			//alert("rte '"+rte+"' is null");
			return null;
		}
		else rtn = rtn.contentWindow;
	}
	return rtn;
}

function updateRTE(rte) {
	if(isRichText) {
		dlgCleanUp(); // 	Closes Pop-ups
		stripGuidelines(rte); // Removes Table Guidelines 
		// [Erel thinks the previous line is redundant because it is already done in parseRTE]
		// [Timm Bell says: "I can't remember the reason why stripGuidelines(rte); was added to updateRTE(), but it was added to fix a bug."]
	}
	parseRTE(rte);
}

function parseRTE(rte) {
	if (!isRichText) {
		 autoBRoff(rte); // sorts out autoBR
		 return false;
	}
	//check for readOnly mode
	var readOnly = false;
	var oRTE = returnRTE(rte);
	if(document.all){
		if (oRTE.document.designMode != "On") readOnly = true;
	}else{
		if (oRTE.document.designMode != "on") readOnly = true;
	}

	if(isRichText && !readOnly){
		//if viewing source, switch back to design view
		if(document.getElementById("txtSrc"+rte).innerHTML == lblModeRichText){
			if(document.getElementById("Buttons1_"+rte)){
				 toggleHTMLSrc(rte, true);
			}
			else{
				toggleHTMLSrc(rte, false);
			}
			stripGuidelines(rte);
		}
		setHiddenVal(rte);
	}
}

function setHiddenVal(rte){
	//set hidden form field value for current rte
	var oHdnField = document.getElementById('hdn'+rte);
	//convert html output to xhtml (thanks Timothy Bell and Vyacheslav Smolin!)
	if(oHdnField.value == null) oHdnField.value = "";
	var sRTE = returnRTE(rte).document.body;
	if(generateXHTML){
	  try{
		  oHdnField.value = get_xhtml(sRTE, lang, encoding);
	  }catch(e){
	    oHdnField.value = sRTE.innerHTML;
	  }
	}else{
	  oHdnField.value = sRTE.innerHTML;
	}
	// fix to replace special characters added here: 
	oHdnField.value = replaceSpecialChars(oHdnField.value); 
	//if there is no content (other than formatting) set value to nothing
	if(stripHTML(oHdnField.value.replace("&nbsp;", " ")) == "" &&
		oHdnField.value.toLowerCase().search("<hr") == -1 &&
		oHdnField.value.toLowerCase().search("<img") == -1) oHdnField.value = "";
}

function updateRTEs(){
	var vRTEs = allRTEs.split(";");
	for(var i=0; i<vRTEs.length; i++){
		updateRTE(vRTEs[i]);
	}
}

function rteCommand(rte, command, option){
	dlgCleanUp();
	if (!rte) {
		alert("empty rte "+rte+"'");
		return;
	}
	var oRTE = returnRTE(rte);
	try{
		oRTE.focus();
		if (option) oRTE._doc.execCommand(command, false, option);
		else        oRTE._doc.execCommand(command               );
		oRTE.focus();
	}catch(e){
	}
}

function toggleHTMLSrc(rte, buttons){
	dlgCleanUp();
	//contributed by Bob Hutzel (thanks Bob!)
	var cRTE = document.getElementById(rte);
	var hRTE = document.getElementById('hdn'+rte);
	var sRTE = document.getElementById("size"+rte);
	var tRTE = document.getElementById("txtSrc"+rte);
	var iRTE = document.getElementById("imgSrc"+rte);
	var oRTE = returnRTE(rte).document;
	if(sRTE){
		obj_height = parseInt(sRTE.value);
	}else{
		findSize(rte);
	}
	if(tRTE.innerHTML == lblModeHTML){
		//we are checking the box
		tRTE.innerHTML = lblModeRichText;
		stripGuidelines(rte);
		if(buttons){
			showHideElement("Buttons1_" + rte, "hide", true);
			if(document.getElementById("Buttons2_"+rte)){
				showHideElement("Buttons2_" + rte, "hide", true);
				cRTE.style.height = obj_height+56;
			}else{
				cRTE.style.height = obj_height+28;
			}
		}
		setHiddenVal(rte);
		if(document.all){
			oRTE.body.innerText = hRTE.value;
		}else{
			var htmlSrc = oRTE.createTextNode(hRTE.value);
			oRTE.body.innerHTML = "";
			oRTE.body.appendChild(htmlSrc);
		}
		iRTE.innerHTML = '<img src="'+imagesPath+'design.gif" alt="Switch Mode" style="margin:1px;" align=absmiddle>';
	}else{
		//we are unchecking the box
		obj_height = parseInt(cRTE.style.height);
		tRTE.innerHTML = lblModeHTML;
		if(buttons){
			showHideElement("Buttons1_" + rte, "show", true);
			if(document.getElementById("Buttons2_"+rte)){
				showHideElement("Buttons2_" + rte, "show", true);
				cRTE.style.height = obj_height-56;
			}else{
				cRTE.style.height = obj_height-28;
			}
		}
		if(document.all){
			//fix for IE
			var output = escape(oRTE.body.innerText);
			output = output.replace("%3CP%3E%0D%0A%3CHR%3E", "%3CHR%3E");
			output = output.replace("%3CHR%3E%0D%0A%3C/P%3E", "%3CHR%3E");
			oRTE.body.innerHTML = unescape(output);
			// Disabled due to flaw in the regular expressions, this fix 
	    // does not work with the revamped's enhanced insert link dialog window.
	    //
	    // Prevent links from changing to absolute paths
	    if(!keep_absolute){
	      var tagfix = unescape(output).match(/<a[^>]*href=(['"])([^\1>]*)\1[^>]*>/ig); 
	      var coll = oRTE.body.all.tags('A'); 
	      for(i=0; i<coll.length; i++){ 
	        // the 2 alerts below show when we hinder the links from becoming absolute			
	        //alert(tagfix[i]); 
	        coll[i].href = tagfix[i].replace(/.*href=(['"])([^\1]*)\1.*/i,"$2"); 
	        //alert(RegExp.$1 + " " + RegExp.$2 + " " + RegExp.$3); 
	      } 
	      var imgfix = unescape(output).match(/<img[^>]*src=['"][^'"]*['"][^>]*>/ig); 
	      var coll2 = oRTE.body.all.tags('IMG'); 
	      for(i=0; i<coll2.length; i++){ 
	        coll2[i].src = imgfix[i].replace(/.*src=['"]([^'"]*)['"].*/i,"$1"); 
	      } 
	    }
	    //end path fix			
		}else{
	 		var htmlSrc = oRTE.body.ownerDocument.createRange();
			htmlSrc.selectNodeContents(oRTE.body);
			oRTE.body.innerHTML = htmlSrc.toString();
		}
		oRTE.body.innerHTML = replaceSpecialChars(oRTE.body.innerHTML);
		showGuidelines(rte);
		// (IE Only)This prevents an undo operation from displaying a pervious HTML mode
		// This resets the undo/redo buffer.
		if(document.all){
			parseRTE(rte);
	  }
	  iRTE.innerHTML = '<img src="'+imagesPath+'code.gif" alt="Switch Mode" style="margin:1px;" align=absmiddle>';
	}
}

function toggleSelection(rte) {
	var rng = getRange(rte);
	var oRTE = returnRTE(rte).document;
	var length1;
	var length2;
	if(document.all){
		length1 = rng.text.length;
		var output = escape(oRTE.body.innerText);
		output = output.replace("%3CP%3E%0D%0A%3CHR%3E", "%3CHR%3E");
		output = output.replace("%3CHR%3E%0D%0A%3C/P%3E", "%3CHR%3E");
		length2 = unescape(output).length;
	}else{
		length1 = rng.toString().length;
		var htmlSrc = oRTE.body.ownerDocument.createRange();
		htmlSrc.selectNodeContents(oRTE.body);
	  length2 = htmlSrc.toString().length;
	}
	if(length1 < length2){
	  rteCommand(rte,'selectall','');
	} else {
		if(!document.all){
		  oRTE.designMode = "off";
		  oRTE.designMode = "on";
		}else{
		  rteCommand(rte,'unselect','');
		}
	}
}

function dlgColorPalette(rte, command) {
	//function to display or hide color palettes
	setRange(rte);
	//get dialog position
	var oDialog = document.getElementById('cp' + rte);
	var buttonElement = document.getElementById(command+"_"+rte);
	var iLeftPos = buttonElement.offsetLeft+5; 
	var iTopPos = buttonElement.offsetTop+53;
	if (!document.getElementById('Buttons2_'+rte)) iTopPos = iTopPos-28;
	oDialog.style.left = iLeftPos + "px";
	oDialog.style.top = iTopPos + "px";
	
	if((command == parent.command)&&(rte == currentRTE)){
		//if current command dialog is currently open, close it
		if(oDialog.style.visibility == "hidden"){
			showHideElement(oDialog, 'show', false);
		}else{
			showHideElement(oDialog, 'hide', false);
		}
	}else{
		//if opening a new dialog, close all others
		var vRTEs = allRTEs.split(";");
		for(var i = 0; i<vRTEs.length; i++){
			showHideElement('cp' + vRTEs[i], 'hide', false);
		}
		showHideElement(oDialog, 'show', false);
	}
	//save current values
	currentRTE = rte;
	parent.command = command;
}

function dlgLaunch(rte, command) {
	var selectedText = '';
	//save current values
	parent.command = command;
	currentRTE = rte;
	switch(command){
	case "char":
	  InsertChar = popUpWin(includesPath+'insert_char.htm', 'InsertChar', 50, 50, 'status=yes,');
	  break;
	case "table":
	  InsertTable = popUpWin(includesPath + 'insert_table.htm', 'InsertTable', 50, 50, 'status=yes,');
	  break;
	case "image":
	  setRange(rte);
	  parseRTE(rte);
	  InsertImg = popUpWin(includesPath + 'insert_img.htm','AddImage', 50, 50, 'status=yes,');
	  break;
	case "link":
	  selectedText = getText(rte);
	  InsertLink = popUpWin(includesPath + 'insert_link.htm', 'InsertLink', 50, 50, 'status=yes,');
	  setFormText("0", selectedText);
	  break;
	case "replace":
	  selectedText = getText(rte);
	  dlgReplace = popUpWin(includesPath + 'replace.htm', 'dlgReplace', 50, 50, 'status=yes,');
	  setFormText("1", selectedText);
	  break;
	case "text":
	  dlgPasteText = popUpWin(includesPath + 'paste_text.htm', 'dlgPasteText', 50, 50, 'status=yes,');
	  break;
	case "word":
	  dlgPasteWord = popUpWin(includesPath + 'paste_word.htm', 'dlgPasteWord', 50, 50, 'status=yes,');
	  break;
	}
}

function getText(rte) {
	//get currently highlighted text and set link text value
	setRange(rte);
	var rtn = '';
	if (isIE) {
	  rtn = stripHTML(rng.htmlText);
	} else {
	  rtn = stripHTML(rng.toString());
	}
	parseRTE(rte);
	if(document.all){
	  rtn = rtn.replace(/'/g,"\\\\\\'");    // Erel 2006/05/26: added "g" to fix double-quote bug
	}else{
	  rtn = rtn.replace(/'/g,"\\'");        // Erel 2006/05/26: added "g" to fix double-quote bug
	}
	return rtn;
}

function setFormText(popup, content){
	//set link text value in dialog windows
	if(content != "undefined")
	{
	  try{
		  switch(popup){
		    case "0": InsertLink.document.getElementById("linkText").value = content; break;
		    case "1": dlgReplace.document.getElementById("searchText").value = content; break;
		  }
	  }catch(e){
		  //may take some time to create dialog window.
		  //Keep looping until able to set.
		  setTimeout("setFormText('"+popup+"','" + content + "');", 10);
	  }
	}
}

function dlgCleanUp(){
	var vRTEs = allRTEs.split(";");
	for(var i = 0; i < vRTEs.length; i++){
		showHideElement('cp' + vRTEs[i], 'hide', false);
	}
	if(InsertChar!=null) InsertChar.close();InsertChar=null;
	if(InsertTable!=null) InsertTable.close();InsertTable=null;
	if(InsertLink!=null) InsertLink.close();InsertLink=null;
	if(InsertImg!=null) InsertImg.close();InsertImg=null;
	if(dlgReplace!=null) dlgReplace.close();dlgReplace=null;
	if(dlgPasteText!=null) dlgPasteText.close();dlgPasteText=null;
	if(dlgPasteWord!=null) dlgPasteWord.close();dlgPasteWord=null;
}

function popUpWin (url, win, width, height, options) {
	dlgCleanUp();
	var leftPos = (screen.availWidth - width) / 2;
	var topPos = (screen.availHeight - height) / 2;
	options += 'width=' + width + ',height=' + height + ',left=' + leftPos + ',top=' + topPos;
	return window.open(url, win, options);
}

function setColor(color) {
	//function to set color
	var rte = currentRTE;
	var parentCommand = parent.command;
	if(document.all){
		if(parentCommand == "hilitecolor") parentCommand = "backcolor";
		//retrieve selected range
		rng.select();
	}
	rteCommand(rte, parentCommand, color);
	showHideElement('cp'+rte, "hide", false);
}

function addImage(rte) {
	dlgCleanUp();
	//function to add image
	imagePath = prompt('Enter Image URL:', 'http://');				
	if((imagePath != null)&&(imagePath != "")){
		rteCommand(rte, 'InsertImage', imagePath);
	}
}

function rtePrint(rte) {
	dlgCleanUp();
	if(isIE){
	  document.getElementById(rte).contentWindow.document.execCommand('Print');
	}else{
 	  document.getElementById(rte).contentWindow.print();
	}
}

function selectFont(rte, selectname){
	//function to handle font changes
	var idx = document.getElementById(selectname).selectedIndex;
	// First one is always a label
	if(idx != 0){
		var selected = document.getElementById(selectname).options[idx].value;
		document.getElementById(selectname).selectedIndex = 0;
		var cmd = selectname.replace('_'+rte, '');
		rteCommand(rte, cmd, selected);
	}
}

function tagIsBlock(tag) {
	return (tag=="div" || tag=="p" || tag=="blockquote");
}

function selectClass(rte, selectname) {
	//function to handle font changes
	var idx = document.getElementById(selectname).selectedIndex;
	// First one is always a label
	if(idx != 0){
		var selected = document.getElementById(selectname).options[idx].value;
		document.getElementById(selectname).selectedIndex = 0;
		
		var tag_class = selected.split(".");
		var tag = tag_class[0].toLowerCase();    // for XHTML compliance
		var cls = tag_class[1];

		if (tagIsBlock(tag) && !cls)     // keep previous behaviour when there is no class
			rteCommand(rte, "formatblock", (isIE? "<"+tag+">": tag) );  // "<" and ">" needed in IE, but don't work in Mozilla in some of the tags
		else
			setTagAndClass(rte, tag, cls);
	}
}

function setTagAndClass(rte, tag, cls) {
	var rng = getRange(rte);

	// rng.toString destroys the current formatting, so we use it only for non-block tags.
	// surroundContents doesn't enable UNDO in Mozilla, so we use it only for block-tags.
	if (isIE || !tagIsBlock(tag)) {
		var currentText = isIE? rng.htmlText: rng.toString(); // NOTE: toString clears the current formatting tags!
		var newHTML = 
			"<" + tag + 
				(cls?  " class='"+cls+"'":  "") + 
			">" + currentText + "</" + tag + ">";
		currentRTE = rte;  // because insertHTML uses global variable currentRTE
		insertHTML(newHTML);
	}
	else {      // for DIV styles on non-IE browsers
		var newNode = document.createElement(tag);
		newNode.className = cls;
		rng.surroundContents(newNode);  // NOTE: Mozilla doesn't undo this!
	}
}

function insertHTML(html){
	//function to add HTML -- thanks dannyuk1982
	var rte = currentRTE;
	var oRTE = returnRTE(rte);
	oRTE.focus();
	if(document.all){
		var oRng = oRTE.document.selection.createRange();
		oRng.pasteHTML(html);
		oRng.collapse(false);
		oRng.select();
	}else{
		oRTE.document.execCommand('insertHTML', false, html);
	}
}

function replaceHTML(tmpContent, searchFor, replaceWith) {
	var runCount = 0;
	var intBefore = 0;
	var intAfter = 0;
	var tmpOutput = "";
	while(tmpContent.toUpperCase().indexOf(searchFor.toUpperCase()) > -1) {
	  runCount = runCount+1;
	  // Get all content before the match
	  intBefore = tmpContent.toUpperCase().indexOf(searchFor.toUpperCase());
	  tmpBefore = tmpContent.substring(0, intBefore);
	  tmpOutput = tmpOutput + tmpBefore;
	  // Get the string to replace
	  tmpOutput = tmpOutput + replaceWith;
	  // Get the rest of the content after the match until
	  // the next match or the end of the content
	  intAfter = tmpContent.length - searchFor.length + 1;
	  tmpContent = tmpContent.substring(intBefore + searchFor.length);
	}
	return runCount+"|^|"+tmpOutput+tmpContent;
}

function replaceSpecialChars(html){ 
	 var specials = new Array("&cent;","&euro;","&pound;","&curren;","&yen;","&copy;","&reg;","&trade;","&divide;","&times;","&plusmn;","&frac14;","&frac12;","&frac34;","&deg;","&sup1;","&sup2;","&sup3;","&micro;","&laquo;","&raquo;","&lsquo;","&rsquo;","&lsaquo;","&rsaquo;","&sbquo;","&bdquo;","&ldquo;","&rdquo;","&iexcl;","&brvbar;","&sect;","&not;","&macr;","&para;","&middot;","&cedil;","&iquest;","&fnof;","&mdash;","&ndash;","&bull;","&hellip;","&permil;","&ordf;","&ordm;","&szlig;","&dagger;","&Dagger;","&eth;","&ETH;","&oslash;","&Oslash;","&thorn;","&THORN;","&oelig;","&OElig;","&scaron;","&Scaron;","&acute;","&circ;","&tilde;","&uml;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&ccedil;","&Ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&igrave;","&iacute;","&icirc;","&iuml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ntilde;","&Ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&ugrave;","&uacute;","&ucirc;","&uuml;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&yacute;","&yuml;","&Yacute;","&Yuml;"); 
	 var unicodes = new Array("\u00a2","\u20ac","\u00a3","\u00a4","\u00a5","\u00a9","\u00ae","\u2122","\u00f7","\u00d7","\u00b1","\u00bc","\u00bd","\u00be","\u00b0","\u00b9","\u00b2","\u00b3","\u00b5","\u00ab","\u00bb","\u2018","\u2019","\u2039","\u203a","\u201a","\u201e","\u201c","\u201d","\u00a1","\u00a6","\u00a7","\u00ac","\u00af","\u00b6","\u00b7","\u00b8","\u00bf","\u0192","\u2014","\u2013","\u2022","\u2026","\u2030","\u00aa","\u00ba","\u00df","\u2020","\u2021","\u00f0","\u00d0","\u00f8","\u00d8","\u00fe","\u00de","\u0153","\u0152","\u0161","\u0160","\u00b4","\u02c6","\u02dc","\u00a8","\u00e0","\u00e1","\u00e2","\u00e3","\u00e4","\u00e5","\u00e6","\u00c0","\u00c1","\u00c2","\u00c3","\u00c4","\u00c5","\u00c6","\u00e7","\u00c7","\u00e8","\u00e9","\u00ea","\u00eb","\u00c8","\u00c9","\u00ca","\u00cb","\u00ec","\u00ed","\u00ee","\u00ef","\u00cc","\u00cd","\u00ce","\u00cf","\u00f1","\u00d1","\u00f2","\u00f3","\u00f4","\u00f5","\u00f6","\u00d2","\u00d3","\u00d4","\u00d5","\u00d6","\u00f9","\u00fa","\u00fb","\u00fc","\u00d9","\u00da","\u00db","\u00dc","\u00fd","\u00ff","\u00dd","\u0178"); 
	 for(var i=0; i<specials.length; i++){ 
	    html = replaceIt(html,unicodes[i],specials[i]); 
	 } 
	 return html; 
}

function SearchAndReplace(searchFor, replaceWith, matchCase, wholeWord) {
	 var cfrmMsg = lblSearchConfirm.replace("SF",searchFor).replace("RW",replaceWith);
	 var rte = currentRTE;
	 stripGuidelines(rte);
	 var oRTE = returnRTE(rte);
	 var tmpContent = oRTE.document.body.innerHTML.replace("'", "\'").replace('"', '\"');
	 var strRegex;
	 if (matchCase && wholeWord) {
	    strRegex = "/(?!<[^>]*)(\\b(" + searchFor + ")\\b)(?![^<]*>)/g";
	 }
	 else if (matchCase) {
	    strRegex = "/(?!<[^>]*)(" + searchFor + ")(?![^<]*>)/g";
	 }
	 else if (wholeWord) {
	    strRegex = "/(?!<[^>]*)(\\b(" + searchFor + ")\\b)(?![^<]*>)/gi";
	 } else {
	    strRegex = "/(?!<[^>]*)(" + searchFor + ")(?![^<]*>)/gi";
	 }
	 var cmpRegex=eval(strRegex);
	 var runCount = 0;
	 var tmpNext = tmpContent;
	 var intFound = tmpNext.search(cmpRegex);
	 while(intFound > -1) {
	    runCount = runCount+1;
	    tmpNext = tmpNext.substr(intFound + searchFor.length);
	    intFound = tmpNext.search(cmpRegex);
	 }
	 if (runCount > 0) {
	    cfrmMsg = cfrmMsg.replace("[RUNCOUNT]",runCount);
	    if(confirm(cfrmMsg)) {
	       tmpContent=tmpContent.replace(cmpRegex,replaceWith);
	       oRTE.document.body.innerHTML = tmpContent.replace("\'", "'").replace('\"', '"');
	    } else {
	     alert(lblSearchAbort);
	  }
	    showGuidelines(rte);
	 }
	 else {
	   showGuidelines(rte);
	    alert("["+searchFor+"] "+lblSearchNotFound);
	 }
}
		
function showHideElement(element, showHide, rePosition){
	//function to show or hide elements
	//element variable can be string or object
	if(document.getElementById(element)){
		element = document.getElementById(element);
	}
	if(showHide == "show"){
		element.style.visibility = "visible";
		if(rePosition){
			element.style.position = "relative";
			element.style.left = "auto";
			element.style.top = "auto";
		}
	}else if(showHide == "hide"){
		element.style.visibility = "hidden";
		if(rePosition){
				element.style.position = "absolute";
				element.style.left = "-1000px";
				element.style.top = "-1000px";
		}
	}
}

function getRange(rte){
	var oRTE = returnRTE(rte);
	var rng;
	if(document.all){
		var selection = oRTE.document.selection;
		if(selection != null) rng = selection.createRange();
	}else{
		var selection = oRTE.getSelection();
		rng = selection.getRangeAt(selection.rangeCount - 1).cloneRange();
	}
	return rng;
}

function setRange(rte){
	rng = getRange(rte);
}



function stripHTML(strU) {
	//strip all html
	var strN = strU.replace(/(<([^>]+)>)/ig,"");
	//replace carriage returns and line feeds
	strN = strN.replace(/\r\n/g," ");
	strN = strN.replace(/\n/g," ");
	strN = strN.replace(/\r/g," ");
	strN = trim(strN);
	return strN;
}

function trim(inputString) {
	if (typeof inputString != "string") return inputString;
	var retValue = inputString;
	var ch = retValue.substring(0, 1);
	while(ch == " "){
	  retValue = retValue.substring(1, retValue.length);
	  ch = retValue.substring(0, 1);
	}
	ch = retValue.substring(retValue.length - 1, retValue.length);
	while(ch == " "){
	  retValue = retValue.substring(0, retValue.length - 1);
	  ch = retValue.substring(retValue.length - 1, retValue.length);
	}
	// Note that there are two spaces in the string - look for multiple spaces within the string
	while (retValue.indexOf("  ") != -1) {
	  // Again, there are two spaces in each of the strings
	  retValue = retValue.substring(0, retValue.indexOf("  ")) + retValue.substring(retValue.indexOf("  ") + 1, retValue.length);
	}
	return retValue; // Return the trimmed string back to the user
}

function showGuidelines(rte) {
	return; // TEMPORARY by Erel
	if(rte.length == 0) rte = currentRTE;
	var oRTE = returnRTE(rte);
	var tables = oRTE.document.getElementsByTagName("table");
	for(var i=0; i<tables.length; i++){
	  if(tables[i].getAttribute("border") == "0"){
	    var trs = tables[i].getElementsByTagName("tr");
	    for(var j=0; j<trs.length; j++){
	      var tds = trs[j].getElementsByTagName("td");
	      for(var k=0; k<tds.length; k++){
					if(j == 0 && k == 0){
			   	  tds[k].style.border = "dashed 1px "+zeroBorder;
					}else if(j == 0 && k != 0){
	  		    tds[k].style.borderBottom = "dashed 1px "+zeroBorder;
						tds[k].style.borderTop = "dashed 1px "+zeroBorder;
						tds[k].style.borderRight = "dashed 1px "+zeroBorder;
	        }else if(j != 0 && k == 0) {
			      tds[k].style.borderBottom = "dashed 1px "+zeroBorder;
					  tds[k].style.borderLeft = "dashed 1px "+zeroBorder;
						tds[k].style.borderRight = "dashed 1px "+zeroBorder;
	        }else if(j != 0 && k != 0) {
	          tds[k].style.borderBottom = "dashed 1px "+zeroBorder;
					  tds[k].style.borderRight = "dashed 1px "+zeroBorder;
		      }
	      }
	    }
	  }
	}
}

function stripGuidelines(rte) {
	return; // TEMPORARY by Erel
	var oRTE = returnRTE(rte);
	var tbls = oRTE.document.getElementsByTagName("table");
	for(var j=0; j<tbls.length; j++) {
	  if(tbls[j].getAttribute("border") == "0") {
	    var tds = tbls[j].getElementsByTagName("td");
	    for(var k=0; k<tds.length; k++) {
	      tds[k].removeAttribute("style");
	    }
	  }
	}
}

function findSize(obj) {
	if(obj.length > 0 && document.all) {
	  obj = frames[obj];
	} else if(obj.length > 0 && !document.all) {
	  obj = document.getElementById(obj).contentWindow;
	} else {
	  obj = this;
	}
	
	if ( typeof( obj.window.innerWidth ) == 'number' ) {
	  //Non-IE
	  obj_width = obj.window.innerWidth;
	  obj_height = obj.window.innerHeight;
	} else if( obj.document.documentElement && ( obj.document.documentElement.clientWidth || obj.document.documentElement.clientHeight ) ) {
	  //IE 6+ in 'standards compliant mode'
	  obj_width = document.documentElement.clientWidth;
	  obj_height = document.documentElement.clientHeight;
	} else if( obj.document.body && ( obj.document.body.clientWidth || obj.document.body.clientHeight ) ) {
	  //IE 4 compatible
	  obj_width = obj.document.body.clientWidth;
	  obj_height = obj.document.body.clientHeight;
	}

}

function resizeRTE() {
	document.body.style.overflow = "hidden";
	var rte = currentRTE;
	var oRTE = document.getElementById(rte);
	var oBut1 = document.getElementById('Buttons1_'+rte);
	var oBut2;
	var oVS = document.getElementById('vs'+rte);
	findSize("");
	width = obj_width;
	if (width < minWidth){
		document.body.style.overflow = "auto";
		width = minWidth;
	}
	var height = obj_height - 83;
	if (document.getElementById("txtSrc"+rte).innerHTML == lblModeRichText) {
		height = obj_height-28;
		if (!document.getElementById('Buttons2_'+rte) && width < wrapWidth) {
			document.body.style.overflow = "auto";
			width = wrapWidth;
		}
		if (document.getElementById('Buttons2_'+rte)) document.getElementById('Buttons2_'+rte).style.width = width;
	} else {
		if (document.getElementById('Buttons2_'+rte)) {
			document.getElementById('Buttons2_'+rte).style.width = width;
		} else {
				height = obj_height - 55;
				if(width < wrapWidth){
					document.body.style.overflow = "auto";
					width = wrapWidth;
				}
		}
	}
	if (document.body.style.overflow == "auto" && isIE) height = height-18;
	if (document.body.style.overflow == "auto" && !isIE) height = height-24;
	oBut1.style.width = width;
	oVS.style.width = width;
	oRTE.style.width = width-2;
	oRTE.style.height = height;
	if(!document.all)oRTE.contentDocument.designMode = "on";
}

function replaceIt(string,text,by) {
	// CM 19/10/04 custom replace function
	var strLength = string.length, txtLength = text.length;
	if ((strLength == 0) || (txtLength == 0)) return string;
	var i = string.indexOf(text);
	if ((!i) && (text != string.substring(0,txtLength))) return string;
	if (i == -1) return string;
	var newstr = string.substring(0,i) + by;
	if (i+txtLength < strLength)
	  newstr += replaceIt(string.substring(i+txtLength,strLength),text,by);
	return newstr;
}

function countWords(rte){
	parseRTE(rte);
	var words = document.getElementById("hdn"+rte).value;
	var totalWordCount = getWordCount(words);
	var selectionWordCount = getWordCount(getSelectionedText(rte));
	
	var chars = trim(words);
	chars = chars.length;
	chars = maxchar - chars;

	var alarm = "";
	if(chars<0) alarm = "\n\n"+lblCountCharWarn;
	
	alert(
		lblCountSelection+": "+selectionWordCount+"\n\n"+
		lblCountTotal+": "+totalWordCount+ "\n\n"+
		lblCountChar+": "+chars+alarm);
}


function getWordCount(words) {
	var str = stripHTML(words);
	str = str+" a ";  // word added to avoid error
	str = str.
		replace(/&nbsp;/gi,' ').
		replace(/([\n\r\t])/g,' ').
		replace(/(  +)/g,' ').
		replace(/&[a-z]*;/gi,' ').      //bug fix by Erel
		replace(/^\s*|\s*$/g,'');
	var count = 0;
	for (x=0;x<str.length;x++) {
	  if (str.charAt(x)==" " && str.charAt(x-1)!=" ") count++;  
	}
	if (str.charAt(str.length-1) != " ") count++;
	count = count - 1; // extra word removed
	return count;
}




function getSelectionedText(rte) {
	var oRTE = returnRTE(rte);
	var txt = '';
	if (oRTE.window && oRTE.window.getSelection) {
		txt = oRTE.window.getSelection();
	}
	else if (oRTE.document.getSelection) {
		txt = oRTE.document.getSelection();
	}
	else if (oRTE.document.selection) {
		txt = oRTE.document.selection.createRange().text;
	}
	return txt.toString();
}


function autoBRon(rte) {
	// CM 19/10/04 used for non RTE browsers to deal with auto <BR> (and clean up other muck)
	var oRTE = document.forms[0].elements[rte];
	oRTE.value=parseBreaks(oRTE.value);
	oRTE.value=replaceIt(oRTE.value,'&apos;','\'');
}

function autoBRoff(rte) {
	// CM 19/10/04 used for non RTE browsers to deal with auto <BR> (auto carried out when the form is submitted)
	var oRTE = document.forms[0].elements[rte];
	oRTE.value=replaceIt(oRTE.value,'\n','<br />');
	oRTE.value=replaceIt(oRTE.value,'\'','&apos;');
}

function parseBreaks(argIn) {
	// CM 19/10/04 used for non RTE browsers to deal with auto <BR> (and clean up other muck)
	argIn=replaceIt(argIn,'<br>','\n');
	argIn=replaceIt(argIn,'<BR>','\n');
	argIn=replaceIt(argIn,'<br/>','\n');
	argIn=replaceIt(argIn,'<br />','\n');
	argIn=replaceIt(argIn,'\t',' ');
	argIn=replaceIt(argIn,'    ',' ');
	argIn=replaceIt(argIn,'   ',' ');
	argIn=replaceIt(argIn,'  ',' ');
	argIn=replaceIt(argIn,'  ',' ');
	argIn=replaceIt(argIn,'\n ','\n');
	argIn=replaceIt(argIn,' <p>','<p>');
	argIn=replaceIt(argIn,'</p><p>','\n\n');
	argIn=replaceIt(argIn,'&apos;','\'');
	return argIn;
}

var getKeys = function(obj){
   var keys = [];
   for(var key in obj){
      keys.push(key);
   }
   return keys;
}

function geckoKeyPress(evt) {
	//function to add bold, italic, and underline shortcut commands to gecko RTEs
	//contributed by Anti Veeranna (thanks Anti!)

	var rte = evt.target.id;
	if (!rte) {	
		return; // can't find the id of the rte
	}
	if (evt.ctrlKey) {
		var char = String.fromCharCode(evt.which);
		var key = char.toLowerCase();
		var cmd = '';
		switch (key) {
			case 'b': case '': rteCommand(rte,"bold",null); break;
			case 'i': case '': rteCommand(rte,"italic",null); break;
			case 'u': case '': rteCommand(rte,"underline",null); break;
			//case 'b': setTagAndClass(rte,"strong"); break;     // breaks containing spans!
			//case 'i': setTagAndClass(rte,"em"); break;         // breaks containing spans!  
			//case 'u': setTagAndClass(rte,"span.u"); break;     // breaks containing spans!
	
			case 'q': case '/': setTagAndClass(rte,"q","psuq"); break;
			case 'p': case '': setTagAndClass(rte,"q","mfrj"); break;
			case 'w': case "'": setTagAndClass(rte,"q"); break;
			case 's': case "": setTagAndClass(rte,"small"); break;

			case 'd': case '': setTagAndClass(rte,"dfn"); break;
			case '0': rteCommand(rte, 'removeformat'); break;
			case '1': setTagAndClass(rte,"h1"); break;
			case '2': setTagAndClass(rte,"h2"); break;
			case '3': setTagAndClass(rte,"h3"); break;
			case '4': setTagAndClass(rte,"h4"); break;
			case '5': setTagAndClass(rte,"h5"); break;
			case '6': setTagAndClass(rte,"h6"); break;
			case 'k': case '': dlgLaunch(rte,"link"); break;
			default: return;
		}
		// if there was a command, stop the event bubble
		evt.preventDefault();
		evt.stopPropagation();
 	}
}

function checkspell() {
	dlgCleanUp();
	//function to perform spell check
	try {
		var tmpis = new ActiveXObject("ieSpell.ieSpellExtension");
		tmpis.CheckAllLinkedDocuments(document);
	}
	catch(exception) {
		if(exception.number==-2146827859) {
			if (confirm("ieSpell not detected.  Click Ok to go to download page."))
				window.open("http://www.iespell.com/download.php","DownLoad");
		} else {
			alert("Error Loading ieSpell: Exception " + exception.number);
		}
	}
}




replacements = new Array (
	//convert all types of single quotes
	new RegExp(String.fromCharCode(145),'g'), "'",
	new RegExp(String.fromCharCode(146),'g'), "'",
	new RegExp("'",'g'), "&#39;",

	//convert all types of double quotes
	new RegExp(String.fromCharCode(147),'g'), "\"",
	new RegExp(String.fromCharCode(148),'g'), "\"",
	//new RegExp("\"",'g'), "&#34;",

	//replace carriage returns & line feeds
	new RegExp("[\r\n]",'g'), " "
);


function rteSafe(html) {
	for (i=0; i<replacements.length; i+=2) {
		html = html.replace(replacements[i], replacements[i+1]);
	}
	return html;
}


/* _script/etc */


path_from_document_to_scripts = path_from_document_to_site + '../_script/';


var urlToLike = "http://tora.us.fm/"+path_from_root_to_document;
var facebookLikeButton = "<iframe src='http://www.facebook.com/plugins/like.php?href=" +
		urlToLike+"' scrolling='no' frameborder='0' style='border:none; width:450px; height:80px'></iframe>\n";
var googlePlusButton = "<g:plusone></g:plusone>";


select_other_versions = 
	!/\/t0/.test(path_from_root_to_document) && 
	!/\/index/.test(path_from_root_to_document) && 
	1;

var gfc_skin = {};
gfc_skin['BORDER_COLOR'] = '#cccccc';
gfc_skin['ENDCAP_BG_COLOR'] = '#ddffcc';
gfc_skin['ENDCAP_TEXT_COLOR'] = '#333333';
gfc_skin['ENDCAP_LINK_COLOR'] = '#990033';
gfc_skin['ALTERNATE_BG_COLOR'] = '#ffffff';
gfc_skin['CONTENT_BG_COLOR'] = '#ffffff';
gfc_skin['CONTENT_LINK_COLOR'] = '#990033';
gfc_skin['CONTENT_TEXT_COLOR'] = '#33333a';
gfc_skin['CONTENT_SECONDARY_LINK_COLOR'] = '#990033';
gfc_skin['CONTENT_SECONDARY_TEXT_COLOR'] = '#666666';
gfc_skin['CONTENT_HEADLINE_COLOR'] = '#333333';

initRTE(
	path_from_document_to_scripts+"rteimages/", 
	path_from_document_to_scripts,
	'', //path_from_document_to_site+"_themes/klli.css",
	false);


var SUBSEQUENT_CLICKS_TO_EDIT = 10;


var lang = document.body.lang;

function initialLanguage() {
	// language-string may be set by the search string (i.e. ...html?en or ...html?he)
	if (location.search == '?en' || location.search == '?he')
		languageString = location.search.replace(/^\?+/,"^");
	else {
		languageString = getCookie('language');
		if (languageString.length<=1)
			languageString = '^' + document.body.lang;
		if (languageString.length<=1)
			languageString = '^he';          // default value
	}
	setCookie('language', languageString, 30, '/');
	return languageString;
}

function setLanguage(theNewLanguage) {
	showSingleLanguage(theNewLanguage);
	setCookie('language', theNewLanguage, 365, '/');
	theTguvotHeading = document.getElementById('tguvot');
	newTguvotHeading1 = "<span lang='he' xml:lang='he'></span> <span lang='en' xml:lang='en'>Replies</span>";
	newTguvotHeading2 = "<span lang='he' xml:lang='he'>-</span> <span lang='en' xml:lang='en'>Subjects</span>";
	if (theNewLanguage == '^he') {
		lang = 'he';
		lang_direction = document.body.dir = 'rtl';
		if (theTguvotHeading) {
			theTguvotHeading.innerHTML = theTguvotHeading.innerHTML.
				replace(/^Replies ?$/,newTguvotHeading1).
				replace(/^Subjects ?$/,newTguvotHeading2);
		}
	}
	else if (theNewLanguage == '^en') {
		lang = 'en';
		lang_direction = document.body.dir = 'ltr';
		if (theTguvotHeading) {
			theTguvotHeading.innerHTML = theTguvotHeading.innerHTML.
				replace(/^ ?$/,newTguvotHeading1).
				replace(/^- ?$/,newTguvotHeading2);
		}
	}
	addVersionsByStyle(lang);
	addVersionsByLanguage(lang);
	addVersionsByContent(lang);
}



function text2HTML(theText) {
	theText = theText.
		replace(/(http:\/\/[^ \r\n\t()<>{}]+)/gi, "<a href='$1'>$1</a>").
		replace(/\cM/g, "").
		replace(/\n\n/g, "</p><p>").
		replace(/\n/g, "<br />").
		replace(/&lt;/gi, "<").
		replace(/&gt;/gi, ">").
		replace(/&quot;/gi, "\"").
		replace(/^(<p>)+/,"").
		replace(/(<\/p>)+$/,"");
	if (theText.length>0)
		return "<p>" + theText + "</p>";
	else
		return "";
}


var theTosft, theBnim, theTokn, theTguvot, theTguvotHeading, theTitle, documentHasEditableParts, documentHasExecutableParts;
function getContentElements() { // called in "tguva" 
	theTosft = document.getElementById('tosft');
	theBnim = document.getElementById('ulbnim');
	theTokn = document.getElementById('tokn');
	theTguvot = document.getElementById('ultguvot');
	theTguvotHeading = document.getElementById('tguvot');
	theTitle = document.getElementById('h1');

	documentHasEditableParts = (theTokn && theTguvot) || theBnim;
	documentHasExecutableParts = false;       // might be changed in getCodeElements
}

var theAddForm, theEditForm, theButtons;  // updated in "tguva" 
function getFormElements() { // called in "tguva" 
	theAddForm = document.getElementById('addform');
	theEditForm = document.getElementById('editform');
	theButtons = document.getElementById('buttons');
}


function disableHiddenRTEs() {
	var vRTEs = allRTEs.split(";");
	for(var i=vRTEs.length-1; i>=0; --i) {
		$('hdn'+vRTEs[i]).attr("disabled", "disabled");
		$('size'+vRTEs[i]).attr("disabled", "disabled");
		//document.getElementById('hdn'+vRTEs[i]).disabled = true;
		//document.getElementById('size'+vRTEs[i]).disabled = true;
	}
}












var lastClickTime = new Date();
var clickCount = 0;

function countSubsequentClicks() {
    var now = new Date();
    var difference = now.getTime() - lastClickTime.getTime();
    if (difference <= 300)
       ++clickCount;
    else
       clickCount=1;
    lastClickTime = now;
    return clickCount;
}

function toggleEdit(eventObject) {
    count = countSubsequentClicks();
    if (count==SUBSEQUENT_CLICKS_TO_EDIT) {
       clickType=(navigator.appName=="Netscape")? eventObject.which: event.button;
       if (theEditForm.style.display=='none')
          showEdit('editwithbuttons');
       else
          hideEdit();
    }
}





function authorLink (authorname, authoremail, authoremailserver) {
	return authorname + " (<a href='mailto:" + authoremail + "@" + authoremailserver + "?subject=" + title_without_quotes.replace(/ /g,"_") + "'>" + authoremail + "@" + authoremailserver + "</a>)";
}

function linkToOtherVersion(params, pdf) {
	var script = (pdf? "printpdf.php": "print.php");
	var current_params = (/print[.]php/.test(location.href)?
		(location.search.substr(1)):
		('lang=' + lang + 
		(theLang2? '&lang2=' + theLang2: '') + 
		'&ktovt=' + path_from_root_to_document));
	if (pdf)
		current_params = current_params.replace(/numbering=[^&]+/,"");
	return path_from_document_to_scripts + script + '?' + current_params + "&" + params;
}


function linkToOtherLanguages() {
	var theText = '';
	theText += "<div class='versionlink'>";
	if (theLang2) {
		theText += "<a lang='en' class='lang' dir='ltr' href='javascript:setLanguage(\"^he\")'></a>&nbsp;";
		theText += "<a lang='he' class='lang' dir='rtl' href='javascript:setLanguage(\"^en\")'>English</a>&nbsp;";
		theText += "<a class='lang' dir='rtl' href='javascript:setLanguage(\"^(he|en)\")'>English+</a>&nbsp;";
	}
	theText += "</div>";
	return theText;
}


function emptyVersionSelector(id) {
	theText = '<div class="versionselector"><select size="1" id="' + id + '" onchange="if (selectedIndex>0) location.href=this.value">'; // + 

	theText += '</select></div>';
	return theText;
}

function hide_old_idfields() {
	try {hide('idfields');} catch (e) {};
}

function kotrt() {

	if (//.test(theAuthor) || //.test(theAuthor) || //.test(theAuthor))  {
		google_ad_client = "pub-4131841895603404";
		/* 728x90,  11/05/08 */
		google_ad_slot = "5267744417";
		google_ad_width = 728;
		google_ad_height = 90;
		document.write('<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>');
	} 

	var theText="";
	if (theReceiver==' ') {
		theText += ("<p class='sgulot_logo'>" + 
			"<a href='http://stores.lulu.com/erel'>" +
			"<img src='/tnk1/_themes/sgolot.png' alt=' ' title='   '/>" +
			"</a>" +
			"</p>");
	}

	
	// add a header, if it doesn't exist yet
	theText += ("<h1 id='h1'>" + document.title + "</h1>\n");
	if (document.getElementById("h1")) {
		hide("h1");
	}

	hide_old_idfields();

	if (site=="tnk1") {
		theText += "<a href='"+path_from_document_to_root+site+"/index.html'>"+"<img class='logo' title='  ' alt='  ' src='" + path_from_document_to_root + site + "/_themes/logo_small.gif' /></a>";
		hideByClass('link_to_homepage');
	}
	
	theText += "<div id='visible_idfields'>\n";
	if (theAuthor.length>1 && !/erelsgl|brain/.test(path_from_root_to_document) && !(site == "horsha")) {
		if ((theAuthor=="" || theAuthor==" "))
			authorForTitle = bilingual(lang,theLang2,"span",authorLink("  ,    ,  ,  ", "erelvgalya+tnk1","gmail.com"),"Erel Segal");
		else if (/erel/i.test(theAuthor)) 
			authorForTitle = bilingual(lang,theLang2,"span"," ","Erel Segal");
		else if ("" == theAuthor || / /.test(theAuthor))
			authorForTitle = authorLink(" ", "raananyosef","yahoo.com");
		else if ("" == theAuthor)
			authorForTitle = authorLink("", "the.tzahor","gmail.com");
		else if (" " == theAuthor)
			authorForTitle = authorLink(" ", "avigaelgotlib", "walla.com")
		else if (" " == theAuthor)
			authorForTitle = authorLink(" ", "syaelp","t2.technion.ac.il");
		else if (/ /.test(theAuthor))
			authorForTitle = authorLink("   ", "DAIAN1","013.NET");
		else if (//.test(theAuthor) && //.test(theAuthor))
			authorForTitle = authorLink(":   ", "eitan-avioh","iec.co.il");
		else if (/ /.test(theAuthor))
			authorForTitle = authorLink(" ", "yaront","kibbutzmerav.co.il");
		else if (/ /.test(theAuthor))
			authorForTitle = authorLink(" ", "moblid","gmail.com");
		else if (/  /.test(theAuthor))
			authorForTitle = authorLink("'   ", "bezra","inter.net.il");
		else if (/ /.test(theAuthor) || /   /.test(theAuthor) )
			authorForTitle = authorLink("    -  ", "Hagay_r","tahal.com");
		else if (""==theAuthor || " "==theAuthor )
			authorForTitle = authorLink("<a href='/tnk1/find.php?q= '> </a>", "evycohen","walla.com");
			//authorForTitle = authorLink("<a href='http://www.facebook.com/evycohen'> </a>", "evycohen","walla.com");
		else if (/ /.test(theAuthor))
			authorForTitle = ("   <p style='font-weight:bold; color:#080'>    </p>");
		else if (/ /.test(theAuthor))
			authorForTitle = authorLink (" ","priel9","biu.013.net.il");
		else if (/ /.test(theAuthor))
			authorForTitle = authorLink (" ","reuven49","walla.com");
		else
			authorForTitle = theAuthor;

		theText += (
			bilingual(lang,theLang2, "span", ": ", "By: ") +
			authorForTitle);
		
		if (document.body.className == "dmwt") {
			theText += ("<br />" + ": " + "");
		}
	}

	if (theReceiver.length>0) {
		if (theReceiver==' ') {
			theText += ("<br />" + "  " + 
				"<a href='http://stores.lulu.com/erel'> </a>");
		} else {
			theReceiver = theReceiver.replace(/(  .?)?/, "  <a href='nachat.ipaper.co.il'>\"</a>");
			if (!/\'\'/.test(theReceiver) && !/\'\'/.test(theReceiver) )
				theText += ("<br />" + 
					bilingual(lang,theLang2, "span", ": ", "To: ") +
					theReceiver);
		}
	}

	if (/jdl.*Mefar/.test(path_from_root_to_document))   theText += ('<p>     "     "  .  (, " - , "),      " .    .');

	theText += "</div>\n";
	
	// add links to other versions (languages, printer friendly, all replies, etc)
	if (select_other_versions) {
		theText += 
		"<script type='text/javascript' src='https://apis.google.com/js/plusone.js'>"+
			"{lang: 'iw'}"+
		"</script>"+
		"<table class='versionselectors'>\n<tr>\n" + 
			"<td>" + emptyVersionSelector('versionsByStyle') + "</td>\n" + 
			"<td>" + emptyVersionSelector('versionsByLanguage') + "</td>\n" + 
			"<td>" + emptyVersionSelector('versionsByContent') + "</td>\n" + 
			"<td>" + facebookLikeButton + "</td>\n"+
			"<td>" + googlePlusButton + "</td>\n"+
		"</tr>\n</table>\n";
	}

	document.write(theText);

	/*
	if (/   /.test(theAuthor)) {
		document.write('<div class="daian">    :<br><a href="mailto:DAIAN1@013.NET">  DAIAN1@013.NET</a></div>');
		google_ad_client = "pub-5668940475962184";
		// 728x90,  01/12/10 
		//google_ad_slot = "5267744417";  // What is it???
		google_ad_width = 728;
		google_ad_height = 90;
		//document.write('<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script>');
	}
	*/
}

function currentVersionIsFormal() {
	return !(/\d\d\d\d\d\d\d\d\d\d\d\d/.test(document.URL) || /-open/.test(document.URL));
}


function linkToFormalVersion() {
	return  " " + 
		"<a href='" + path_from_document_to_document + siomt + "'>" + 
		(lang=='en'? "Click here to view the formal version of this document": "        ") + 
		"</a> ";
}

function linksToOtherVersions() {
	document.write("<div id='formerversions' class='formerversions'>\n");

	server_version="c";
	if (/http:/.test(document.URL) && currentVersionIsFormal() && !/compact|csv_ezor[.]p/.test(document.URL)) {
		document.write("</div>\n");

		/*
		google.friendconnect.container.renderOpenSocialGadget(
		{ id: 'formerversions',
		url: 'http://tora.us.fm/quest/gfc/serve.xml?'+server_version+'&mslul='+encodeURIComponent('_script/versionlist.php?versionlist=short&lang='+lang+'&followup='+path_from_root_to_document),
		site: '11268733983612202568'},
		gfc_skin);
		*/

		/*
		theText += (
			'<iframe width="100%" height="42" src="' +
			path_from_document_to_root +
			'_script/versionlist.php?versionlist=short&lang='+
			lang +
			'&followup='+path_from_root_to_document+
			'"></iframe>');
		*/
	} else if (!/compact|csv_ezor[.]p/.test(document.URL)) {
		if (currentVersionIsFormal()) {
			document.write(lang=='en'? 'This is the <b>formal version</b> of the document, last updated at ': ' <b> </b>  ,   -');
			document.write(document.lastModified + '. ');
		} else {
			document.write
			(lang=='en'? 'This is a non-formal version of the document, created ': '     ,  ' );
			document.write(document.lastModified + '. ');
			document.write(linkToFormalVersion());
		}
		document.write("</div>\n");
	} // end of "if http..."
}

function addVersionsByLanguage(lang) {
	var theVersionSelector = document.getElementById('versionsByLanguage');
	if (!theVersionSelector) return;
	if (theLang2) {
		var i = theVersionSelector.options.length = 0;
		theVersionSelector.options[i++] = new Option('* ...  language ... *'  , '');
		if (lang=='en')
			theVersionSelector.options[i++] = new Option('',
				'javascript:setLanguage("^he")');
		else
			theVersionSelector.options[i++] = new Option('English',
				'javascript:setLanguage("^en")');
		theVersionSelector.options[i++] = new Option(' + English',
			'javascript:setLanguage("^(he|en)")');
		theVersionSelector.style.display = "";
	}
	else
		theVersionSelector.style.display = "none";
}


function addVersionsByStyle(lang) {
	var theVersionSelector = document.getElementById('versionsByStyle');
	if (!theVersionSelector) return;
	var i = theVersionSelector.options.length = 0;
	theVersionSelector.options[i++] = new Option( (lang=='en'? '* select style... *': '*  ... *'), '');

	theVersionSelector.options[i++] = new Option( (lang=='en'? "book print": " "), linkToOtherVersion("style=print&toclevel=1&pagebreaklevel=1"));

	theVersionSelector.options[i++] = new Option( (lang=='en'? "compact print": " "), linkToOtherVersion("style=print+compact"));

	if (document.body.dir=='ltr') { // ... because princexml can't handle rtl docs
		theVersionSelector.options[i++] = new Option( (lang=='en'? "book pdf": "pdf "), linkToOtherVersion("style=print&toclevel=1&pagebreaklevel=1","pdf"));
		theVersionSelector.options[i++] = new Option( (lang=='en'? "compact pdf": "pdf "), linkToOtherVersion("style=print+compact","pdf"));
	}

	theVersionSelector.style.display = (theVersionSelector.options.length<2? "none": "");
}


function addVersionsByContent(lang) {
	var theVersionSelector = document.getElementById('versionsByContent');
	if (!theVersionSelector) return;
	var i = theVersionSelector.options.length = 0;
	theVersionSelector.options[i++] = new Option( (lang=='en'? '* select content... *': '*  ... *'), '');
	if (site=='za') {
			theVersionSelector.options[i++] = new Option(
				"Zooogi formal document - HTML",
				linkToOtherVersion("followuplevel=99&toclevel=99&pagebreaklevel=0&style=print+compact"));
			theVersionSelector.options[i++] = new Option(
				"Zooogi formal document - Word",
				linkToOtherVersion("followuplevel=99&toclevel=99&pagebreaklevel=0&style=print+compact&editor=Word&output=" + path_from_root_to_document + "_word&lang=en&lang2="));
			theVersionSelector.options[i++] = new Option(
				"Zooogi formal document - PDF",
				linkToOtherVersion("followuplevel=99&toclevel=99&pagebreaklevel=1&style=print&lang=en&lang2=","pdf"));
	}
	if (/ktuv\/mjly\//.test(path_from_root_to_document) || /msr/.test(path_from_root_to_document) || /0smx/.test(path_from_root_to_document)) {
			var followuplevel = (/mdrik$/.test(path_from_root_to_document)? "2": "1");
			var filebreaklevel = followuplevel-1;
			var timelimit =  (/mdrik$/.test(path_from_root_to_document)? "0": "30");
			//alert(followuplevel);
			theVersionSelector.options[i++] = new Option(
				"   -   ",
				linkToOtherVersion("followuplevel="+followuplevel+"&toclevel="+followuplevel+"&pagebreaklevel=1&databaselevel=50&style=print+compact&internallinks=1&author=&book=&timelimit="+timelimit));
			/*theVersionSelector.options[i++] = new Option(
				"   -  ",
				linkToOtherVersion("followuplevel="+followuplevel+"&toclevel="+followuplevel+"&pagebreaklevel=1&databaselevel=50&style=print+compact&internallinks=1&author=&timelimit=30&output=html"));*/
			theVersionSelector.options[i++] = new Option(
				"   -  ",
				linkToOtherVersion("followuplevel="+followuplevel+"&toclevel="+followuplevel+"&pagebreaklevel=1&filebreaklevel="+filebreaklevel+"&databaselevel=50&style=print+compact&internallinks=1&author=&book=&timelimit="+timelimit+"&output=word&editor=Word"));
			/*theVersionSelector.options[i++] = new Option(
				"   -     ",
				linkToOtherVersion("followuplevel=99&toclevel=99&pagebreaklevel=1&databaselevel=50&style=print","pdf"));*/
	}
	// add "show all replies" option if relevant:
	followups = theTguvot? theTguvot.innerHTML: theBnim? theBnim.innerHTML: "";
	if (followups.length>15) {
		theVersionSelector.options[i++] = new Option( (lang == 'en'? "all sub-articles, numbered": " -, "), linkToOtherVersion("followuplevel=99&numbering=(%d)%20"));
		
		if (theAuthor && theAuthor.length>0 && followups.indexOf(theAuthor)>0) {
			var theLabel = (lang == 'en'? "all sub-articles of ": " -  ") + theAuthor;

			theVersionSelector.options[i++] = new Option( 
				theLabel,
				linkToOtherVersion("followuplevel=99&author="+encodeURI(theAuthor)));
		}
		
		theVersionSelector.options[i++] = new Option( (lang == 'en'? "2 levels sub-articles": "   -"), linkToOtherVersion("followuplevel=2"));
	}
	theVersionSelector.style.display = (theVersionSelector.options.length<2? "none": "");
}

function uriOfOurSearchResults(query) {
	return "http://tora.us.fm/tnk1/find.php?q=" + 
		query.replace(/ /g,"+");
}

function linkToOurSearchResults(query) {
	return "<a href='" + 
		uriOfOurSearchResults(query) + 
		"'>" + 
		query.replace(/\"/g,'') +
		"</a>";
}

function uriOfGoogleSearchResults(query) {
	return "http://www.google.co.il/search?hl=iw&q=" + 
		query.replace(/ /g,"+") + 
		"+site:www.tora.us.fm" + 
		"&meta=&ie=windows-1255&oe=windows-1255&num=100";
}

function linkToGoogleSearchResults(query) {
	return "<a href='" + 
		uriOfGoogleSearchResults(query) + 
		"'>" + 
		query.replace(/\"/g,'') +
		"</a>";
}


function txtit() {

	document.write("</div><div style='clear:both'>");   // close the outside div and open a new div, to prevent "blinking"
	document.write("<hr />");

	linksToOtherVersions();
	if (select_other_versions) {
		addVersionsByStyle(lang);
		addVersionsByLanguage(lang);
		addVersionsByContent(lang);
	}

	theText = ("<div class='txtit'>");

	if (//.test(theAuthor))
		theText += ("<br />      , -       (<a href='"+path_from_document_to_site+"../rjyon.html'></a>)");
	if (!/compact/.test(location.href)) {
		if (theAuthor.length>0 || (theReceiver.length>0 && !/[@]/.test(theReceiver)) )
			theText += (lang=='en'? "<br />more articles:&nbsp;&nbsp;&nbsp;" :"<br />  :&nbsp;&nbsp;&nbsp; ");
		if (theAuthor.length>0) {
			theAuthorWithoutParens = theAuthor.
				replace(/ ?\(.*\)/,'').
				replace(/^["]? /, '');
			//theText += linkToGoogleSearchResults('" ' + theAuthorWithoutParens + '"') + '&nbsp;&nbsp;&nbsp; ';
			theText += ' ' + linkToOurSearchResults(theAuthorWithoutParens) + '&nbsp;&nbsp;&nbsp; ';
			if (/ /.test(theAuthorWithoutParens)) {
				theAuthorFirstWord = theAuthorWithoutParens.replace(/ .*$/,'');
				//theText += linkToGoogleSearchResults('" ' + theAuthorFirstWord + '"') + '&nbsp;&nbsp;&nbsp; ';
				theText += ' ' + linkToOurSearchResults(theAuthorFirstWord) + '&nbsp;&nbsp;&nbsp; ';
			}
		}
		if (theReceiver.length>0 && !/[@]/.test(theReceiver)) {
			theReceiverWithoutParens = theReceiver.replace(/ ?\(.*\)/,'');
			theText += linkToGoogleSearchResults('" ' + theReceiverWithoutParens + '"') + '&nbsp;&nbsp;&nbsp; ';
			if (/ /.test(theReceiverWithoutParens)) {
				theReceiverFirstWord = theReceiverWithoutParens.replace(/ .*$/,'');
				theText += linkToGoogleSearchResults('" ' + theReceiverFirstWord + '"') + '&nbsp;&nbsp;&nbsp; ';
			}
		}

		if (site=='tnk1' || site=='tryg') {
			theText += " <br />" + "<a href='http://he.wikisource.org/wiki/" + 
				path_from_root_to_document.replace(/.html?/,"") +
				"'>" +
				" " +
			"</a>";
		}
		/*	
		theText += " <br />" + (lang=='en'? "Document validity check: ": "  : ") + 
		"<a href='http://validator.w3.org/check/referrer?outline=1'>" + "html" + "</a> " + 
		"<a href='http://validator.w3.org/checklink/checklink?uri=" + encodeURI(document.URL) + "'>" + "link" + "</a> " + 
		"<a href='http://jigsaw.w3.org/css-validator/validator?uri=" + encodeURI(document.URL) + "'>" + "css" + "</a>"; 
		*/
	}
	
	if (/findpsuq[.]/.test(location.href)) {
		absolute_document_url_to_display = location.href;
	}
	else {
		absolute_document_url_to_display = absolute_document_url;
	}
	theText += (" <br /> " + 
	(lang=='en'? "The internet address of this document is": "    ") +
	 ": <a dir='ltr' href='" + absolute_document_url_to_display  + "'>" + absolute_document_url_to_display   + "</a>");
	theText += (" <br />" + site_name + ": <a dir='ltr' href='" + absolute_site_url + "'>" + absolute_site_url + "</a>");
	theText += ("</div>");

	document.write(theText);
}


function LI2P(html) {
	return document.all? html: 
	html.replace(/<li[^>]*>/ig,"<p>(*)").replace(/<\/li>/ig,"").replace(/<\/p>/ig,"");
}

function P2LI(html) {
	result = document.all? 
		html: 
		html.
			replace(/<span[^>]*>\s*<\/span>/ig,"").
			replace(/<span>([^<]*)<\/span>/ig,"$1").
			replace(/<span[^>]*>\s*<\/span>/ig,"").
			replace(/<span>([^<]*)<\/span>/ig,"$1").
			replace(/<\/?p[^>]*>\s*[(][*][)]/ig,"</li><li>").
			replace(/(<br[^>]*>\s*)+[(][*][)]/ig,"</li><li>").
			replace(/^\s*[(][*][)]/ig,"</li><li>").
			replace(/^\s*<\/li>/ig,"").
			replace(/<\/?p[^>]*>/ig,"").
			replace(/<br[^>]*>/ig,"");
		if (/<li/.test(result))
			result += "</li>";
	return result;
}


function standardizeHTMLTokn(theHTML) {
	theText = theHTML.
	/* add newline before a start-tag (except an underline and a super/subscript) */
		replace(/(<[^uU\/!])/ig,"\r\n$1").
		replace(/\r\n(<su[bp]>)/ig,"$1").
	/* add space after an end-tag (except an underline and a subscript) */
		replace(/(<\/[^uUaA>][^>]*>)/ig,"$1 ").
		replace(/(<\/su[bp]>) /ig,"$1").
	/* move space from end of tags to after the tags */
		replace(/ (<\/[^>]*>)/ig,"$1 ").
		replace(/ (<\/[^>]*>)/ig,"$1 ").
		replace(/ (<\/[^>]*>)/ig,"$1 ").
	/* remove links and meta-tags that somehow get into the text (through word, for example) */
		replace(/<link[^>]*>/ig,"").
		replace(/<meta[^>]*>/ig,"").
	/* replace deprecated elements with styles */
		replace(/<u>([^<]*)<\/u>/ig,"<span class='u'>$1</span>").
		replace(/(<\/sub>) /ig,"$1").
		replace(/<o:p>\s*<\/o:p>/ig,"").
	/* remove unneeded properties (added by "Word") */
		replace(/<o:p>\s*<\/o:p>/ig,"").
		replace(/<\/?o:p>/ig,"").
		replace(/ class=MsoNormal[a-z]*/ig,"").
		replace(/mso-[^ ">]*:\s*[^ ">]*/ig,"").
		replace(/margin[^ ">]*:\s*[^ ">]*/ig,"").
		replace(/style=[\"\'][\"\']/ig,"").
		replace(/TEXT-INDENT: -[0-9a-z.]*/ig,"").
	/* remove unneeded properties (added by "Visual Studio") */
		replace(/href=\"vid:/ig,"href=\"").
		replace(/margin[^ ">]*:\s*[^ ">]*/ig,"").
		replace(/style=[\"\'][\"\']/ig,"").
	/* remove unneeded properties (added by Mozilla) */
		replace(/ wrap=\"\"/ig,"").
		replace(/ class=\"moz-txt-citetags\"/ig,"").
		replace(/ border-collapse:\s*collapse/ig, "").
		replace(/ lang=["']["']/ig, "").
		replace(/ target=["']?_self["']?/ig, "").
	/* remove unneeded spans */
		replace(/<span[^>]*>\s*<\/span>/ig,"").
		replace(/<span>([^<]*)<\/span>/ig,"$1").
		replace(/<span[^>]*>\s*<\/span>/ig,"").
		replace(/<span>([^<]*)<\/span>/ig,"$1").
		replace(/<font[^>]*>\s*<\/font>/ig,"").
		replace(/<a[^>]*>\s*<\/a>/ig,"").
		replace(/<q[^>]*>\s*<\/q>/ig,"").
	/* remove problematic FireFox list elements */
		replace(/<ul>\s*<li>\s*<\/li>\s*<\/ul>/ig,"").  // empty list
		replace(/<\/li>\s*<ul>/ig,"<ul>").                  // list inside list
	/* remove unallowed character-data */
		replace(/(<[oud]l[^>]*>\s*)&nbsp;/ig,"$1").
		replace(/(<\/li[^>]*>\s*)&nbsp;/ig,"$1").
	/* remove unallowed tags */
		replace(/<p>\s*(<\/[^p])/ig,"$1").
	/* create small text: replace "[[...]]" with "<small>...</small>" */
		replace(/\[\[/ig, "<small>").
		replace(/\]\]/ig, "<\/small>").
	/* remove unneeded parts of a link */
		replace(/(\.htm)\?[^\"\'<>]*/ig,"$1").
	/* fix span direction (for bidi text) */
		//replace(/(<p[^>]*>\s*)(<B[^>]*>\s*)*(<span[^>]*>\s*)*(<span[^>]*)dir=...([^>]*>)/ig,"$1$2$3$4$5").
		replace(/(<p[^>]*>)([^-]*)(<span[^>]*)dir=\"?...\"?([^>]*>)/ig,"$1$2$3$4").
		replace(/(<li[^>]*>)([^-]*)(<span[^>]*)dir=\"?...\"?([^>]*>)/ig,"$1$2$3$4").
	/* remove unneeded newlines */
		replace(/\r\n(\r\n)+/ig, "\r\n").
		replace(/^\r\n/ig, "").
		replace(/\r\n$/ig, "").
		replace(/(<br[^>]*>\s*)(<br[^>]*>\s*)+/ig, "<p>").
	/* remove unneeded comments */
		replace(/<!--[a-z]-->/ig, "").
	/* correct links */
		replace(/tnk\//ig, "tnk1/").
	/* close tags*/
		replace(/<p>\s*(<[hpou])/ig,"<p />$1").
		replace(/<(hr[^>]*)>/ig, "<$1 />").
		replace(/<(br[^>]*)>/ig, "<$1 />").
		replace(/<(input[^>]*)>/ig, "<$1 />").
		replace(/<(img[^>]*)>/ig, "<$1 />");
	return theText;
}

function standardizeHTMLTguvot(theHTML) {
	return P2LI(theHTML).
		replace(/^<ul>((.|\r|\n)*)<\/ul>$/i,"$1").
		replace(/[\r\n]/ig,"").
		replace(/(<[!][-][-]top:)/ig,"\r\n$1").
		replace(/(<li[^>]*>)/ig,"\r\n$1").
		replace(/[(]<[!][-][-]responses:[^>]+>\d+[)]/ig,"").
		replace(/<span> ?<\/span>/ig,"").
		replace(/(<ul><[!][-][-]insert:)/ig,"\r\n$1").
		replace(/(<\/ul><[!][-][-]end:)/ig,"\r\n$1").
		replace(/\r\n(\r\n)+/ig, "\r\n").
		replace(/^\r\n/ig, "").
		replace(/\r\n$/ig, "");
}

function standardizeHTMLToknAndTguvot(toknHTML, tguvotHTML) {
	return "<div id='tokn'>\r\n" + 
		standardizeHTMLTokn(toknHTML) + "\r\n" +
		"</div><!-" + "-tokn-->" + "\r\n" + 
		"<h2 id='tguvot'>" + theTguvotHeading.innerHTML + "</h2>\r\n\r\n" + 
		"<ul id='ultguvot'>\r\n" + 
		standardizeHTMLTguvot(tguvotHTML) + "\r\n" +
		"</ul><!-" + "-end-->\r\n\r\n";
}

function standardizeHTMLBnim(bnimHTML) {
	return 	"<ul id='ulbnim'>\r\n" + 
		standardizeHTMLTguvot(bnimHTML) + "\r\n" +
		"</ul><!--end-->\r\n\r\n";
}

function standardizeHTMLTosftAndBnim(tosftHTML, bnimHTML) {
	return 	"<!--tosft0--><div id='tosft'>\r\n" +
		standardizeHTMLTokn(tosftHTML) + "\r\n" +
		"</div><!--tosft1-->\r\n"+
		standardizeHTMLBnim(bnimHTML);
}


function standardizeHTML() {
	if (theTokn && theTguvot) {
		return standardizeHTMLToknAndTguvot(theTokn.innerHTML, theTguvot.innerHTML);
	}
	else if (theBnim && theTosft) {
		return standardizeHTMLTosftAndBnim(theTosft.innerHTML, theBnim.innerHTML);
	}
	else if (theBnim) {
		return standardizeHTMLBnim(theBnim.innerHTML);
	}
	else {
		alert('   .    !');
	}
}

function standardizeHTMLRTE() {
	if (theTokn && theTguvot) {
		return standardizeHTMLToknAndTguvot($('#ToknRTE').val(), $('#TguvotRTE').val());
	}
	else if (theBnim && theTosft) {
		updateRTE('ToknRTE');
		updateRTE('TguvotRTE');
		return standardizeHTMLTosftAndBnim(document.getElementById('hdnToknRTE').value, document.getElementById('hdnTguvotRTE').value);
	}
	else if (theBnim) {
		updateRTE('TguvotRTE');  
		return standardizeHTMLBnim(document.getElementById('hdnTguvotRTE').value);
	}
	else {
		alert('   .    !');
	}
}


function hideEdit() {
	if (document.all) {
		hide('editform');
	}
	else {
		hide('helpedit');
		theEditForm.style.visibility = 'hidden';
	}
}

function showAdd(theForm) {
	if (!theAddForm) return;
	show(theAddForm);
	hideEdit(theEditForm);
	hide('addtext');
	hide('addlink');
	hide('addfile');
	show(theForm);

	if (!theAddForm.bodyclass.options) return;
	theAddForm.bodyclass.length = 0;
	
	i = 0;
	theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? '* add what? *': '*  ? *'), '');
	if (theForm == 'addtext') {
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'reply': ''), 'tguva');
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'new article': ' '), 'newarticle');
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'new subject': ' '), 'newsubject');
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'question': ''), 'la_gmwr');
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'sticky message': ' '), 'hodaa');
		theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'executable function': '  '), 'jsfunction');
		if (/^js/.test(path_from_root_to_document)) {
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'Javascript algorithm': '  javascript'), 'jsalgorithm');
		}
		if (/tnk1.ljon.jorj/.test(path_from_root_to_document)) {
			theAddForm.bodyclass.options[i++] = new Option('', 'hgdrh');
			theAddForm.bodyclass.options[i++] = new Option('', 'hbdl');
		}
		if (/tnk1/.test(path_from_root_to_document)) {
			theAddForm.bodyclass.options[i++] = new Option(' ', 'hpwk');
			theAddForm.bodyclass.options[i++] = new Option('', 'jyr');
		}
		if (/tryg.mcwa/.test(path_from_root_to_document)) {
			theAddForm.bodyclass.options[i++] = new Option('', 'hgdrh');
			theAddForm.bodyclass.options[i++] = new Option('', 'fem');
		}

	}
	else if (theForm == 'addfile') {
		if (documentHasExecutableParts) {
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'input file - requires password': '  -  '), 'inputfile');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'other file': ' '), 'file');
		}
		else {
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'image': '  '), 'image');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'tab-seperated text': '  '), 'magr');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'other file': '  '), 'file');
		}
	}
	else {
		if (documentHasExecutableParts) {
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'link to an input file - requires password': '    -  '), 'inputlink');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'link to another code file to use - requires password': '       '), 'uselink');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'other link': ' '), 'link');
		}
		else {
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'link to a file in this site': '   '), 'internallink');
			theAddForm.bodyclass.options[i++] = new Option( (lang=='en'? 'link to a file in another site': '   '), 'externallink');
		}
	}
}



function pausecomp(millis)
{
date = new Date();
var curDate = null;

do { var curDate = new Date(); }
while(curDate-date < millis);
}


function minmax(val, min, max) {
	return val<min? min: val>max? max: val;
}

function fixRTEAppearance() {
	returnRTE('ToknRTE').document.body.dir = returnRTE('TguvotRTE').document.body.dir = document.body.dir;

	var width = theTokn? theTokn.clientWidth: 0.9*document.body.clientWidth;
	var height1 = theTokn? 360: theTosft? Math.min(theTosft.clientHeight+20,360):   0;
	var height2 = theBnim? 360: theTguvot?  Math.min(theTguvot.clientHeight+20,360): 0;

	if (!isIE) {
		setRTESize('ToknRTE', width, height1);
		setRTESize('TguvotRTE', width, height2);
	}
}

function fixTokn() {
	t = theTokn.innerHTML;
	i = t.indexOf("<h2 id=\"tguvot");
	if (i>0)
		t = t.substr(0,i);
	return t.replace(/<!--tokn-->/ig,"").replace(/<!--end-->/ig,"");
}



function copyTextareasToHtml(html) {
	var codeAreas = document.getElementsByTagName("textarea");
	for (var i=0; i<codeAreas.length; ++i) {
		var codeArea = codeAreas[i];
		if (codeArea.id.length>0) {
			var regexp = new RegExp("(<textarea[^>]*id=['\"]?" + codeArea.id + "['\"]?[^>]*>)([^<>]|\r|\n)*<\/textarea>", "ig");
			html = html.replace(regexp, "$1" + codeArea.value + "</textarea>");
		}
	}
	return html;
}


function showEdit(theForm) {
	if (theAddForm) {
		theAddForm.qijur.disabled = true;
		theAddForm.jm_qovc_al_hlqox.disabled = true;
		hide(theAddForm);
	}

	show('helpedit');     

	if (theTokn)
		$('#ToknRTE').val(copyTextareasToHtml(fixTokn()));
	if (theTguvot)
		$('#TguvotRTE').val(LI2P(theTguvot.innerHTML));

	var emptyTitle = "&nbsp;&nbsp;&nbsp;&nbsp;";
	$(".wymeditor").wymeditor({
            lang: 'he',
            stylesheet: '/_script/klli.css',  /* for classes in the classes menu or in the shortcuts */
            logoHtml: 'WYMEditor',
            updateEvent: "click",    
            updateSelector: "[type=submit]",
            postInit: function(wym) {
             	$(wym._iframe).attr('dir','rtl').css('height', wym._element.context.style.height).css('direction', 'rtl');
            },
						skinPath: '/_script/wymeditor/wymeditor/skins/default/',
						basePath: '/_script/wymeditor/wymeditor/',
				    toolsItems: [
        				{'name': 'Bold', 'title': emptyTitle, 'css': 'wym_tools_strong'}, 
								{'name': 'Italic', 'title': emptyTitle, 'css': 'wym_tools_emphasis'},
								{'name': 'Superscript', 'title': emptyTitle,
								    'css': 'wym_tools_superscript'},
								{'name': 'Subscript', 'title': emptyTitle,
								    'css': 'wym_tools_subscript'},
								{'name': 'InsertOrderedList', 'title': emptyTitle,
								    'css': 'wym_tools_ordered_list'},
								{'name': 'InsertUnorderedList', 'title': emptyTitle,
								    'css': 'wym_tools_unordered_list'},
								{'name': 'Indent', 'title': emptyTitle, 'css': 'wym_tools_indent'},
								{'name': 'Outdent', 'title': emptyTitle, 'css': 'wym_tools_outdent'},
								{'name': 'Undo', 'title': emptyTitle, 'css': 'wym_tools_undo'},
								{'name': 'Redo', 'title': emptyTitle, 'css': 'wym_tools_redo'},
								{'name': 'CreateLink', 'title': emptyTitle, 'css': 'wym_tools_link'},
								{'name': 'Unlink', 'title': emptyTitle, 'css': 'wym_tools_unlink'},
								{'name': 'InsertImage', 'title': emptyTitle, 'css': 'wym_tools_image'},
								{'name': 'InsertTable', 'title': emptyTitle, 'css': 'wym_tools_table'},
								{'name': 'Paste', 'title': emptyTitle,       'css': 'wym_tools_paste'},
								{'name': 'ToggleHtml', 'title': emptyTitle, 'css': 'wym_tools_html'},
						],
				    dialogHtml: "<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'"
                      + " 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>"
                      + "<html dir='"
                      + WYMeditor.DIRECTION
                      + "'><head>"
                      + "<link rel='stylesheet' type='text/css'   media='screen'"
                      + " href='"
                      + WYMeditor.CSS_PATH
                      + "' />"
                      + "<title>"
                      + WYMeditor.DIALOG_TITLE
                      + "</title>"
                      + "<script type='text/javascript' src='/_script/wymeditor/jquery/jquery.js'></script>"
                      + "<script type='text/javascript' src='/_script/wymeditor/wymeditor/jquery.wymeditor.js'></script>"
                      + "</head>"
                      + WYMeditor.DIALOG_BODY
                      + "</html>",
						stringDelimiterLeft: "",
						stringDelimiterRight: "",

	});

	theEditForm.style.visibility = 'visible';

	show('editwithbuttons');
}


function removeHTMLColor (theHTML) {
   return theHTML.
      replace(/<TD.*?>/ig, "<TD>").
      replace(/<FONT.*?>/ig, "").
      replace(/<\/FONT>/ig, "").
      replace(/font-family:[^;\"\' >]*[;]?/ig, "").
      replace(/font-size:[^;\"\' >]*[;]?/ig, "").
      replace(/color:[^;\"\' >]*[;]?/ig, "").
      replace(/background:[^;\"\' >]*[;]?/ig, "").
      replace(/moz-.*?:[^;\"\' >]*[;]?/ig, "");
}


help_en = '<li>To delete the document, insert the text "delete me" anywhere in the document. ';

help_he = '<li>   ,    ""   .'+
	'<li>  -: <STRONG>Ctrl+B </STRONG>, <EM>Ctrl+I </EM>, <U>Ctrl+U -</U>, <a href="javascript:alert(\'Ctrl+K =  \')">Ctrl+K  </a>' +
	'<li>  ""   ,    .' + 
	'<li>      : <ul>' + 
	'<li>    -     ,  (Ctrl+C)  (Ctrl+V).  -    !' + 
	'<li>      -   " "     ,        .</ul>' + 
	'    ,        "      .<ul>'; + 
	'';

help = "&nbsp;<div></div><div id='helpedit'>" + 
	bilingual(lang,theLang2,"ul",help_he,help_en)+ 
	"</div>";



origSubjectInput = '<input type=hidden name="origsubject" value="' + title_without_quotes + '">';


function setRewriteTitle(theForm) {
  if (theTitle) {
      theForm.title.value = theTitle.innerHTML;
      if (theForm.title.value.replace(/<[^>]*>/g,"") == document.title)
         theForm.titlechanged.disabled = true;
      else {
         theForm.titlechanged.disabled = false;
         theForm.titlechanged.value = "1";
      }
   }
}


function submitOrDebug(text) {
	if (/^file:/.test(location.href)) {
		alert(text);
		return false;
	}
	if (text == null) {
		alert (" !    !");
		return false;
	}
	if (text.length == 0) {
		alert (" !    !");
		return false;
	}
	
	return true;
}



function onSubmitAdd(theForm) {
	if (theForm.username.value && theForm.title.value && (!passwordIsRequired || theForm.password.value)) {
		theForm.body.value = text2HTML(theForm.body.value);
	}
}

function onSubmitEdit(theForm) {
	for (var i=0; i<=2; ++i) {
		var w = jQuery.wymeditors(i);
		if (w)
			w.update();
	}
	//setRewriteTitle(theEditForm); // for editing the H1 of the document; not supported anymore
	theForm.content.value=standardizeHTMLRTE(); // this is the textarea that will be submitted
	return submitOrDebug(theForm.content.value); 
}

function writeWymEditor(id, width, height, buttons) {
	document.write("<textarea class='wymeditor' style='width:"+width+"px; height:"+height+"px' id='"+id+"'></textarea>");
}

/* from http://stackoverflow.com/a/9976309/827927 */
function resizeIframe(obj) {
    obj.style.height = (obj.contentWindow.document.body.scrollHeight+20) + 'px';
}

function tguva () {
	getContentElements();

	if (//.test(theAuthor)) {
		document.write('<div style="font-style:italic">      <a href="http://www.mycreation.co.il" target="_blank"> </a>.</div>');
	} else {
		if (!theTvnit.length)
			document.write("<iframe class='tguvot' width='100%' src='/tnk1/tguva.php?followup="+path_from_root_to_document+"' onload='javascript:resizeIframe(this);'></iframe>");
	}


	document.write("<table class='versionselectors'><tr>\n"+
			"<td>" + facebookLikeButton + "</td>\n"+
			"<td>" + googlePlusButton + "</td>\n"+
			"</tr></table>");

	if (theTvnit == "0") {
		teur1 = "            .";
	} else if (theTvnit.length>0) {
		teur1 = "    "+document.title+",     ;        (  )     ";
	} else {
		teur1 = "     "+document.title+",     ;        (  )     ";
	}

	if (/new/.test(location.href)) {
		document.write("<div id='buttonGroup'>");
		document.write(buttonGroup(
		   (theTvnit.length>0? "showAdd('addtext');theAddForm.qijur.disabled=true;theAddForm.jm_qovc_al_hlqox.disabled=true;": ""),
		   bilingual(lang, theLang2, "span", "    ", "Add a new page or reply"),
		   (lang=='en'? '': teur1),

		   (theTvnit.length>0? "showAdd('addlink');theAddForm.qijur.disabled=false;theAddForm.jm_qovc_al_hlqox.disabled=true;": ""),
		   bilingual(lang, theLang2, "span", " ", "add hyperlink"),
		   (lang=='en'? '': '       '+document.title+',     . <small>       .</small>'),

		   (theTvnit.length>0? "showAdd('addfile');theAddForm.qijur.disabled=true;theAddForm.jm_qovc_al_hlqox.disabled=false;": ""),
		   bilingual(lang, theLang2, "span", " ,    ", "add image or another file"),
		   (lang=='en'? '': '     '+document.title+' (, , ...)     '),

		   (documentHasEditableParts? "showEdit('editwithbuttons')": ""),
		   bilingual(lang, theLang2, "span", "  ", "edit with style"),
		   (lang=='en'? '': '    , ,     -  ')
		) + "\n\n");
		document.write("</div><!--buttonGroup-->");
	} else {
		document.write("<div id='buttonGroup'>");
		document.write(buttonGroup(
		   (documentHasEditableParts? "showEdit('editwithbuttons')": ""),
		   bilingual(lang, theLang2, "span", "  ", "edit with style"),
		   (lang=='en'? '': '    , ,     -  ')
		) + "\n\n");
		document.write("</div><!--buttonGroup-->");
		document.write("    .         . !");
	}


	if (theTvnit.length>0) {
		document.write(formHeader('addform', '', path_from_document_to_scripts + 'rewrite.php?to=add')+idFields(path_from_root_to_document,usernameHint,passwordHint,emailHint)+
			'<p>'+
			bodyclassInput+
			titleInputVisible+
			languageInputVisible+
			authorInputVisible+
			origSubjectInput);

		if (theTvnit=='0') {
			document.write(
				"<div id='addtext'>\n" + 
				"</div>\n");
		} else {
			document.write(
				"<div id='addtext'>\n" + 
					(lang=='en'? '': '<p><B> </B>:     .      .    ""    .') + 
					(lang=='en'? '<h3>Content (text and hyperlinks)</h3>': '<h3> ( ):</h3>') + 

					(theTvnit.length>0? "<p><textarea id='addtext_body' name='body' cols='50' rows='10'></textarea></p>\n": "") );
			document.write(
				"</div>\n");
		}

		document.write(
			"<div id='addfile'>\n"+
				(lang=='en'? "<h3>A file from your computer</h3>": "<h3>  </h3>")+
				"<p><input type='file' name='jm_qovc_al_hlqox' size='40' onmouseout='if(jm_qovc_al_hlqox.value) theAddForm.title.value=fileparse(jm_qovc_al_hlqox.value)[2];'>"+
				"<p><input type='checkbox' name='hxlf_qovc'>" + 
				(lang=='en'? 'replace file if it exists': '    ')+
			"</div>\n"+

			"<div id='addlink'>\n"+
				(lang=='en'? "<h3>A hyperlink</h3>\n": "<h3>    </h3>\n")+
				"<p><input type='text' name='qijur' dir='ltr' value='http://' size='45' /></p>\n"+
			"</div>\n"+

			(theTvnit=='0'?
				"<input name='add' type='submit' value='"+submitLabel+"'  onclick=''>":
				"<input name='add' type='submit' value='"+submitLabel+"' onclick='onSubmitAdd(this.form)'>") +
			(lang=='en'? "Please be patient, your reply will be posted in a few minutes": 
			"     .   !     -     ")+

		"</form>\n");
	} else {
		theAddForm = null;
	}

	document.write(formHeader('editform', 'rewrite_result_frame', path_from_document_to_scripts + 'rewrite.php?to=rewrite')+idFields(path_from_root_to_document,usernameHint,passwordHint)+
		titleInputHidden+languageInputHidden+
		"<textarea style='display:none' name='content' rows='40' cols='80'></textarea>");
	if (documentHasEditableParts) {
		document.write("<div id='editwithbuttons'>" + 
			(lang=='en'? '<h3>Edit</h3>': '<h3></h3>')+
			(lang=='en'? '<p>edit the text below, fill in your details, and push ': '<p>   ,      ') + 
			'"' + saveLabel + '"' + 
			"");
			// document.writeln("<p dir='ltr'><a target='_blank' href='http://www.kevinroth.com/rte/'>Rich Text Editor by Kevin Roth</a>, <a target='_blank' href='http://richtext.cabspace.com/'>Fork by Timothy S. Bell</a></p>");
			//SYNTAX: writeWymEditor(rte,    width,     height,   buttons)
			var width = theTokn? theTokn.clientWidth: 0.9*document.body.clientWidth;
			var height1 = theTokn? 360: theTosft? Math.max(theTosft.clientHeight,40): 0;
			var height2 = theTguvot? Math.max(theTguvot.clientHeight,40): theBnim? 360: 0;

			writeWymEditor('ToknRTE',   width, height1, (theTokn || theTosft)? true: false);
			if (!(theTokn || theTosft)) showHideRTE('ToknRTE','hide');

			if (theTokn&&theTguvot) document.write("<h2 id='TguvotRTE_heading'>" + theTguvotHeading.innerHTML + '</h2>');

			writeWymEditor('TguvotRTE', width, height2, (theTguvot || theBnim)? true: false);

			if (!(theTguvot || theBnim)) showHideRTE('TguvotRTE','hide');
		document.write(
			'<p>' + 
			'<iframe src="about:blank" width="100%" height="100px" name="rewrite_result_frame" id="rewrite_result_frame" ></iframe>' + 
			'</p>' + 
			'<p>' + 
			"<input accesskey='' type='submit' name='rewrite' value='" + saveLabel + "' onclick='onSubmitEdit(this.form)'>"+ " " + 
			//'<input type=button onclick="document.getElementById(\'ToknRTE\').contentWindow.document.body.innerHTML=removeHTMLColor(document.getElementById(\'ToknRTE\').contentWindow.document.body.innerHTML);return false;" value="'+formatLabel+'">' + ' ' +
			"<input type='button' onclick='$(\"#ToknRTE\").val(removeHTMLColor($(\"#ToknRTE\").val())); return false;' value='"+formatLabel+"'>" + " " +
			"</p></div>\n");
		disableHiddenRTEs();
	}

	document.write(help);
	document.write('</form>');

	getFormElements();

	if (theTvnit.length>0)
		hide('addform');

	if (document.all)
		hide('editform');
	else
		hideEdit(); // MISSION IMPOSSIBLE: hide the edit form WITHOUT causing an error in RTE in Mozilla.

	if (theLang2)
		setLanguage(initialLanguage());    // for the selector and the buttons

	document.onclick = toggleEdit;
	document.onmousedown = toggleEdit;
}  // end of function "tguva"



function ktov_whatsnew() {

	theText = '';
	if (/http:/.test(document.URL)) {
		if (site=='tnk1') {
			theText = 
				"<div style='text-align:center'><div style='margin:0 auto 0 auto'> " + 
				"<iframe height='200' width='100%' src='../_script/display.php?site=" + site + "&file=board&showstart=0&show=9999&expand=0&sort=1&maxtopics=20'></iframe>" + 
				"<br />"+
				"</div></div>";
		}
		else {
			theText = 
				"<div style='text-align:center'> <table style='margin:0 auto 0 auto'><TR>" + 
				"<td><iframe width='400' height='200' src='../_script/display.php?site=" + site + "&file=board&showstart=0&show=9999&expand=0&sort=1&maxtopics=20'></iframe></td>&nbsp;" + 
				"</table> </div>";
		}
	}
	else
		theText = "<p style='text-align: center; margin-left: 2cm; margin-right: 2cm; padding-top: 0.5cm; padding-bottom: 0.5cm'><a href='board.html'>   </a>";
	document.write(theText);
}

function ktov_mftx(current) {
	chars = ""
	for (ii=10; ii<=31; ++ii) {
		if (ii!=current) document.write("<a href='mftx" + ii + ".html'>");
		document.write(chars.substr(ii-10,1));
		if (ii!=current) document.write("</a>");
		document.write("&nbsp;")
	}
}

